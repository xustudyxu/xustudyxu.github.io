<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>尚医通-预约挂号 | xustudyxu&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e1aa9d15d62220ec692a843c08c79000";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>        
    </script>
    <script src="https://fastly.jsdelivr.net/npm/twikoo@1.5.11/dist/twikoo.all.min.js"></script>
    <script href="./js/index.js" async="async"></script>
    <link rel="icon" href="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220627/mmexport1656324824543.124zxwkqyzlc.webp">
    <script charset="utf-8" href="./js/main.js"></script>
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <meta name="description" content="一起学习编程!">
    <meta name="image" content="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221110/image.elwutkf0tgw.webp">
    <meta name="twitter:title" content="尚医通-预约挂号">
    <meta name="twitter:description" content="">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221110/image.elwutkf0tgw.webp">
    <meta name="twitter:url" content="https://frxcat.fun/baodian/high/SYT/SYT_yygh.html">
    <meta name="twitter:site" content="@frxcat">
    <meta property="og:type" content="article">
    <meta property="og:title" content="尚医通-预约挂号">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221110/image.elwutkf0tgw.webp">
    <meta property="og:url" content="https://frxcat.fun/baodian/high/SYT/SYT_yygh.html">
    <meta property="og:site_name" content="frxcat">
    <meta property="article:published_time" content="2022-11-11T20:23:07.000Z">
    <meta property="article:tag" content="中高进阶篇">
    <meta itemprop="name" content="尚医通-预约挂号">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221110/image.elwutkf0tgw.webp">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="baidu-site-verification" content="code-5aMKYEt9fV">
    <link rel="preload" href="/assets/css/0.styles.83a33c40.css" as="style"><link rel="preload" href="/assets/js/app.4955f045.js" as="script"><link rel="preload" href="/assets/js/3.d7147f30.js" as="script"><link rel="preload" href="/assets/js/2.06384a8f.js" as="script"><link rel="preload" href="/assets/js/66.bde30c80.js" as="script"><link rel="preload" href="/assets/js/21.56563fe6.js" as="script"><link rel="preload" href="/assets/js/44.b2c4405b.js" as="script"><link rel="preload" href="/assets/js/26.0926361f.js" as="script"><link rel="preload" href="/assets/js/27.983951e8.js" as="script"><link rel="prefetch" href="/assets/js/1.824c4a45.js"><link rel="prefetch" href="/assets/js/10.7ce79a31.js"><link rel="prefetch" href="/assets/js/100.ffda3ba0.js"><link rel="prefetch" href="/assets/js/101.97f1f0f3.js"><link rel="prefetch" href="/assets/js/102.28121eb8.js"><link rel="prefetch" href="/assets/js/103.0fc5eb83.js"><link rel="prefetch" href="/assets/js/104.1787b574.js"><link rel="prefetch" href="/assets/js/105.ab685e88.js"><link rel="prefetch" href="/assets/js/106.1d957fb0.js"><link rel="prefetch" href="/assets/js/107.47afc3a8.js"><link rel="prefetch" href="/assets/js/108.84399f88.js"><link rel="prefetch" href="/assets/js/109.f5e928df.js"><link rel="prefetch" href="/assets/js/11.15750cc8.js"><link rel="prefetch" href="/assets/js/110.252b65e2.js"><link rel="prefetch" href="/assets/js/111.d46c182c.js"><link rel="prefetch" href="/assets/js/112.4a0c887f.js"><link rel="prefetch" href="/assets/js/113.d817adb9.js"><link rel="prefetch" href="/assets/js/114.08562ff1.js"><link rel="prefetch" href="/assets/js/115.5213c5f1.js"><link rel="prefetch" href="/assets/js/116.5eb73a0e.js"><link rel="prefetch" href="/assets/js/117.01a5c54f.js"><link rel="prefetch" href="/assets/js/118.66cb7195.js"><link rel="prefetch" href="/assets/js/119.69fa746e.js"><link rel="prefetch" href="/assets/js/12.f647df2d.js"><link rel="prefetch" href="/assets/js/120.7ffdbd83.js"><link rel="prefetch" href="/assets/js/121.6b4bf6ef.js"><link rel="prefetch" href="/assets/js/122.bc561cb0.js"><link rel="prefetch" href="/assets/js/123.f6dcec00.js"><link rel="prefetch" href="/assets/js/124.ac7e1df3.js"><link rel="prefetch" href="/assets/js/125.4c8061a6.js"><link rel="prefetch" href="/assets/js/126.c8188fec.js"><link rel="prefetch" href="/assets/js/127.1547a269.js"><link rel="prefetch" href="/assets/js/128.7a3a92aa.js"><link rel="prefetch" href="/assets/js/129.fb1eb93a.js"><link rel="prefetch" href="/assets/js/13.81d78335.js"><link rel="prefetch" href="/assets/js/130.9edcf9f4.js"><link rel="prefetch" href="/assets/js/131.63cc6713.js"><link rel="prefetch" href="/assets/js/132.901dac43.js"><link rel="prefetch" href="/assets/js/133.f50c7a04.js"><link rel="prefetch" href="/assets/js/134.45804187.js"><link rel="prefetch" href="/assets/js/135.c750606f.js"><link rel="prefetch" href="/assets/js/136.4a8abfca.js"><link rel="prefetch" href="/assets/js/137.6da75ee9.js"><link rel="prefetch" href="/assets/js/138.ea688bbe.js"><link rel="prefetch" href="/assets/js/139.9039e9b6.js"><link rel="prefetch" href="/assets/js/14.bb7261bd.js"><link rel="prefetch" href="/assets/js/140.e8263df3.js"><link rel="prefetch" href="/assets/js/141.bce8b10e.js"><link rel="prefetch" href="/assets/js/142.ae993908.js"><link rel="prefetch" href="/assets/js/143.71ee1b96.js"><link rel="prefetch" href="/assets/js/144.60372a7c.js"><link rel="prefetch" href="/assets/js/145.8c9a7820.js"><link rel="prefetch" href="/assets/js/146.c2d999f3.js"><link rel="prefetch" href="/assets/js/147.cb995273.js"><link rel="prefetch" href="/assets/js/148.3882a6c2.js"><link rel="prefetch" href="/assets/js/149.1f48b299.js"><link rel="prefetch" href="/assets/js/15.3ee4934a.js"><link rel="prefetch" href="/assets/js/150.598053fe.js"><link rel="prefetch" href="/assets/js/151.06610092.js"><link rel="prefetch" href="/assets/js/152.b066de39.js"><link rel="prefetch" href="/assets/js/153.a526a861.js"><link rel="prefetch" href="/assets/js/154.6f64be27.js"><link rel="prefetch" href="/assets/js/155.223d0952.js"><link rel="prefetch" href="/assets/js/156.5f726c38.js"><link rel="prefetch" href="/assets/js/157.05b11e1e.js"><link rel="prefetch" href="/assets/js/158.f2e6e770.js"><link rel="prefetch" href="/assets/js/159.f4fbb9d2.js"><link rel="prefetch" href="/assets/js/16.c8e6d991.js"><link rel="prefetch" href="/assets/js/160.8f69bfbe.js"><link rel="prefetch" href="/assets/js/161.eea8d9c0.js"><link rel="prefetch" href="/assets/js/162.93dc95d5.js"><link rel="prefetch" href="/assets/js/163.d7555ad5.js"><link rel="prefetch" href="/assets/js/164.d6e72bea.js"><link rel="prefetch" href="/assets/js/165.a9541677.js"><link rel="prefetch" href="/assets/js/166.2b05d4dc.js"><link rel="prefetch" href="/assets/js/167.aba2871d.js"><link rel="prefetch" href="/assets/js/168.56c921ae.js"><link rel="prefetch" href="/assets/js/169.1b57dfc6.js"><link rel="prefetch" href="/assets/js/17.848716f1.js"><link rel="prefetch" href="/assets/js/170.984fd8d3.js"><link rel="prefetch" href="/assets/js/171.29e05752.js"><link rel="prefetch" href="/assets/js/172.e6849365.js"><link rel="prefetch" href="/assets/js/173.df12d298.js"><link rel="prefetch" href="/assets/js/174.f59836af.js"><link rel="prefetch" href="/assets/js/175.decc0b18.js"><link rel="prefetch" href="/assets/js/176.fae02636.js"><link rel="prefetch" href="/assets/js/177.eec75463.js"><link rel="prefetch" href="/assets/js/178.0bdb6acd.js"><link rel="prefetch" href="/assets/js/179.33b2baaf.js"><link rel="prefetch" href="/assets/js/18.e137756f.js"><link rel="prefetch" href="/assets/js/180.59d4e8b9.js"><link rel="prefetch" href="/assets/js/181.8d0ce9f4.js"><link rel="prefetch" href="/assets/js/182.045c14cc.js"><link rel="prefetch" href="/assets/js/183.e5ebd77c.js"><link rel="prefetch" href="/assets/js/184.ebce314a.js"><link rel="prefetch" href="/assets/js/185.a8203b4c.js"><link rel="prefetch" href="/assets/js/186.cd8f98dd.js"><link rel="prefetch" href="/assets/js/187.dc6f333a.js"><link rel="prefetch" href="/assets/js/188.5bc7e99e.js"><link rel="prefetch" href="/assets/js/189.0a67b0cb.js"><link rel="prefetch" href="/assets/js/19.cf6d35cc.js"><link rel="prefetch" href="/assets/js/190.ff946d45.js"><link rel="prefetch" href="/assets/js/191.07d98970.js"><link rel="prefetch" href="/assets/js/192.652709ba.js"><link rel="prefetch" href="/assets/js/193.2b9d8522.js"><link rel="prefetch" href="/assets/js/194.5954a402.js"><link rel="prefetch" href="/assets/js/195.0db64242.js"><link rel="prefetch" href="/assets/js/196.8118b1aa.js"><link rel="prefetch" href="/assets/js/197.f1307687.js"><link rel="prefetch" href="/assets/js/198.833fa2b9.js"><link rel="prefetch" href="/assets/js/199.8b77b001.js"><link rel="prefetch" href="/assets/js/20.6d85a927.js"><link rel="prefetch" href="/assets/js/200.810bb855.js"><link rel="prefetch" href="/assets/js/201.6d65274f.js"><link rel="prefetch" href="/assets/js/202.a7dbdc7b.js"><link rel="prefetch" href="/assets/js/203.d640113f.js"><link rel="prefetch" href="/assets/js/204.46fe5b90.js"><link rel="prefetch" href="/assets/js/205.89d84b96.js"><link rel="prefetch" href="/assets/js/206.eaa7bacc.js"><link rel="prefetch" href="/assets/js/207.3a11edd3.js"><link rel="prefetch" href="/assets/js/208.ed338ec2.js"><link rel="prefetch" href="/assets/js/209.5a0a6d02.js"><link rel="prefetch" href="/assets/js/210.305cc09b.js"><link rel="prefetch" href="/assets/js/211.ef5c1e96.js"><link rel="prefetch" href="/assets/js/212.b2956a2d.js"><link rel="prefetch" href="/assets/js/213.bcb6e34b.js"><link rel="prefetch" href="/assets/js/214.ba065433.js"><link rel="prefetch" href="/assets/js/215.37fab5e9.js"><link rel="prefetch" href="/assets/js/216.99c87f39.js"><link rel="prefetch" href="/assets/js/217.527dec0c.js"><link rel="prefetch" href="/assets/js/218.a63e3816.js"><link rel="prefetch" href="/assets/js/219.2349d979.js"><link rel="prefetch" href="/assets/js/22.9c9e8d39.js"><link rel="prefetch" href="/assets/js/220.a6977d0f.js"><link rel="prefetch" href="/assets/js/221.79a88942.js"><link rel="prefetch" href="/assets/js/222.285ffff7.js"><link rel="prefetch" href="/assets/js/223.a1c6c3d9.js"><link rel="prefetch" href="/assets/js/224.0c47685a.js"><link rel="prefetch" href="/assets/js/225.a3d85065.js"><link rel="prefetch" href="/assets/js/226.7adcbd5c.js"><link rel="prefetch" href="/assets/js/227.f94ef1d7.js"><link rel="prefetch" href="/assets/js/228.cdea03df.js"><link rel="prefetch" href="/assets/js/229.ec699685.js"><link rel="prefetch" href="/assets/js/23.cdd23c67.js"><link rel="prefetch" href="/assets/js/230.76245f06.js"><link rel="prefetch" href="/assets/js/231.fe3ceeb6.js"><link rel="prefetch" href="/assets/js/232.90096e19.js"><link rel="prefetch" href="/assets/js/233.aad42634.js"><link rel="prefetch" href="/assets/js/234.ce6d7cb3.js"><link rel="prefetch" href="/assets/js/235.bea8a64e.js"><link rel="prefetch" href="/assets/js/236.66375c89.js"><link rel="prefetch" href="/assets/js/237.ee4706fa.js"><link rel="prefetch" href="/assets/js/238.2cb263a4.js"><link rel="prefetch" href="/assets/js/239.349c1fa8.js"><link rel="prefetch" href="/assets/js/24.d61c681d.js"><link rel="prefetch" href="/assets/js/240.106ba9a4.js"><link rel="prefetch" href="/assets/js/241.11632a0e.js"><link rel="prefetch" href="/assets/js/242.d1d145cb.js"><link rel="prefetch" href="/assets/js/243.52a3426f.js"><link rel="prefetch" href="/assets/js/244.2a584fa0.js"><link rel="prefetch" href="/assets/js/245.1fb29f3e.js"><link rel="prefetch" href="/assets/js/246.cd6a4ff6.js"><link rel="prefetch" href="/assets/js/247.7e962282.js"><link rel="prefetch" href="/assets/js/248.2c8794d2.js"><link rel="prefetch" href="/assets/js/249.15a9e798.js"><link rel="prefetch" href="/assets/js/25.0ae8f37e.js"><link rel="prefetch" href="/assets/js/250.9634ba4f.js"><link rel="prefetch" href="/assets/js/251.8dea9ef2.js"><link rel="prefetch" href="/assets/js/252.1ef90246.js"><link rel="prefetch" href="/assets/js/253.c760ad82.js"><link rel="prefetch" href="/assets/js/254.3a85d48c.js"><link rel="prefetch" href="/assets/js/255.c4d5320f.js"><link rel="prefetch" href="/assets/js/256.fbd5919e.js"><link rel="prefetch" href="/assets/js/257.34697e2d.js"><link rel="prefetch" href="/assets/js/258.f9cd5316.js"><link rel="prefetch" href="/assets/js/259.4cede2ec.js"><link rel="prefetch" href="/assets/js/260.50019bf0.js"><link rel="prefetch" href="/assets/js/261.a73b8ea9.js"><link rel="prefetch" href="/assets/js/262.14c31152.js"><link rel="prefetch" href="/assets/js/263.c000bca2.js"><link rel="prefetch" href="/assets/js/264.b8107f16.js"><link rel="prefetch" href="/assets/js/265.85b6b9c1.js"><link rel="prefetch" href="/assets/js/266.694d2f3e.js"><link rel="prefetch" href="/assets/js/267.f116f2e0.js"><link rel="prefetch" href="/assets/js/268.9c97144d.js"><link rel="prefetch" href="/assets/js/269.6fbc62ea.js"><link rel="prefetch" href="/assets/js/270.369846d8.js"><link rel="prefetch" href="/assets/js/271.67b12e6c.js"><link rel="prefetch" href="/assets/js/272.bba3ff96.js"><link rel="prefetch" href="/assets/js/273.13c95743.js"><link rel="prefetch" href="/assets/js/274.2e6e23ae.js"><link rel="prefetch" href="/assets/js/275.ef9864fc.js"><link rel="prefetch" href="/assets/js/276.1144051f.js"><link rel="prefetch" href="/assets/js/277.adf536ed.js"><link rel="prefetch" href="/assets/js/278.3bf25b0f.js"><link rel="prefetch" href="/assets/js/279.aefbd210.js"><link rel="prefetch" href="/assets/js/28.5e8136a7.js"><link rel="prefetch" href="/assets/js/280.28af2ae4.js"><link rel="prefetch" href="/assets/js/281.b82a267a.js"><link rel="prefetch" href="/assets/js/282.8b8c2aef.js"><link rel="prefetch" href="/assets/js/283.6cc25af1.js"><link rel="prefetch" href="/assets/js/284.f6c919b2.js"><link rel="prefetch" href="/assets/js/285.c8b37f1f.js"><link rel="prefetch" href="/assets/js/286.cc62881c.js"><link rel="prefetch" href="/assets/js/287.63bdf0a3.js"><link rel="prefetch" href="/assets/js/288.eff5e5d1.js"><link rel="prefetch" href="/assets/js/289.3495ef91.js"><link rel="prefetch" href="/assets/js/29.589632c5.js"><link rel="prefetch" href="/assets/js/290.3c4e85c5.js"><link rel="prefetch" href="/assets/js/291.4aa17898.js"><link rel="prefetch" href="/assets/js/292.aa916882.js"><link rel="prefetch" href="/assets/js/293.dd76f349.js"><link rel="prefetch" href="/assets/js/294.48d6b678.js"><link rel="prefetch" href="/assets/js/295.b64b3a61.js"><link rel="prefetch" href="/assets/js/296.d42756b8.js"><link rel="prefetch" href="/assets/js/297.adaa2635.js"><link rel="prefetch" href="/assets/js/298.ddce93c6.js"><link rel="prefetch" href="/assets/js/299.f6c6d0d6.js"><link rel="prefetch" href="/assets/js/30.92b97c4a.js"><link rel="prefetch" href="/assets/js/300.9d2314c1.js"><link rel="prefetch" href="/assets/js/301.63785cf2.js"><link rel="prefetch" href="/assets/js/302.6567a551.js"><link rel="prefetch" href="/assets/js/303.4a773a3a.js"><link rel="prefetch" href="/assets/js/304.e7578acd.js"><link rel="prefetch" href="/assets/js/305.d7264241.js"><link rel="prefetch" href="/assets/js/306.afe4b4d6.js"><link rel="prefetch" href="/assets/js/307.3ecd4181.js"><link rel="prefetch" href="/assets/js/308.75abb4ef.js"><link rel="prefetch" href="/assets/js/309.1899459a.js"><link rel="prefetch" href="/assets/js/31.a196a6b1.js"><link rel="prefetch" href="/assets/js/310.2c3ce99b.js"><link rel="prefetch" href="/assets/js/311.e2751a92.js"><link rel="prefetch" href="/assets/js/312.8d781795.js"><link rel="prefetch" href="/assets/js/313.61965c0b.js"><link rel="prefetch" href="/assets/js/314.3f22d2ce.js"><link rel="prefetch" href="/assets/js/315.29850d1c.js"><link rel="prefetch" href="/assets/js/316.28146e65.js"><link rel="prefetch" href="/assets/js/317.911d6c0d.js"><link rel="prefetch" href="/assets/js/318.a6bb8468.js"><link rel="prefetch" href="/assets/js/319.817b65e4.js"><link rel="prefetch" href="/assets/js/32.e0e28974.js"><link rel="prefetch" href="/assets/js/320.a13c22db.js"><link rel="prefetch" href="/assets/js/321.b0012692.js"><link rel="prefetch" href="/assets/js/322.51b22673.js"><link rel="prefetch" href="/assets/js/323.72b5467a.js"><link rel="prefetch" href="/assets/js/324.a3302f6d.js"><link rel="prefetch" href="/assets/js/325.4b932c3b.js"><link rel="prefetch" href="/assets/js/326.373319d8.js"><link rel="prefetch" href="/assets/js/327.4d773aaa.js"><link rel="prefetch" href="/assets/js/328.418bc74e.js"><link rel="prefetch" href="/assets/js/329.d38edfe8.js"><link rel="prefetch" href="/assets/js/33.327fd4ae.js"><link rel="prefetch" href="/assets/js/330.2990ca24.js"><link rel="prefetch" href="/assets/js/331.d021965b.js"><link rel="prefetch" href="/assets/js/332.71803827.js"><link rel="prefetch" href="/assets/js/333.ffbc52af.js"><link rel="prefetch" href="/assets/js/334.3df0f3d2.js"><link rel="prefetch" href="/assets/js/335.1dae2dca.js"><link rel="prefetch" href="/assets/js/336.882628f3.js"><link rel="prefetch" href="/assets/js/337.2acbad9c.js"><link rel="prefetch" href="/assets/js/338.7a66ed6c.js"><link rel="prefetch" href="/assets/js/339.c7810f9e.js"><link rel="prefetch" href="/assets/js/34.b2df595d.js"><link rel="prefetch" href="/assets/js/340.319a77f0.js"><link rel="prefetch" href="/assets/js/341.175cff3d.js"><link rel="prefetch" href="/assets/js/342.2f68554e.js"><link rel="prefetch" href="/assets/js/343.cbada1ae.js"><link rel="prefetch" href="/assets/js/344.7070f981.js"><link rel="prefetch" href="/assets/js/345.aa9ee343.js"><link rel="prefetch" href="/assets/js/346.7e28e169.js"><link rel="prefetch" href="/assets/js/347.1acc3094.js"><link rel="prefetch" href="/assets/js/348.880928ff.js"><link rel="prefetch" href="/assets/js/349.c589d35e.js"><link rel="prefetch" href="/assets/js/35.615ee69e.js"><link rel="prefetch" href="/assets/js/350.0b5d9734.js"><link rel="prefetch" href="/assets/js/351.2d9435b0.js"><link rel="prefetch" href="/assets/js/352.45e29852.js"><link rel="prefetch" href="/assets/js/353.bda6d8ca.js"><link rel="prefetch" href="/assets/js/354.583c41db.js"><link rel="prefetch" href="/assets/js/355.7c88e775.js"><link rel="prefetch" href="/assets/js/356.b7b5efc6.js"><link rel="prefetch" href="/assets/js/357.4ba46471.js"><link rel="prefetch" href="/assets/js/358.6488c5be.js"><link rel="prefetch" href="/assets/js/359.5a9a928c.js"><link rel="prefetch" href="/assets/js/36.77eeb092.js"><link rel="prefetch" href="/assets/js/360.6b9b662d.js"><link rel="prefetch" href="/assets/js/361.d8a02c7d.js"><link rel="prefetch" href="/assets/js/362.755c280d.js"><link rel="prefetch" href="/assets/js/363.6f70be34.js"><link rel="prefetch" href="/assets/js/364.340fb301.js"><link rel="prefetch" href="/assets/js/365.ed71cce4.js"><link rel="prefetch" href="/assets/js/366.11918e35.js"><link rel="prefetch" href="/assets/js/367.105c96e7.js"><link rel="prefetch" href="/assets/js/368.64b38b88.js"><link rel="prefetch" href="/assets/js/369.08891dd8.js"><link rel="prefetch" href="/assets/js/37.440a91a5.js"><link rel="prefetch" href="/assets/js/370.a510b044.js"><link rel="prefetch" href="/assets/js/371.0fbc30dd.js"><link rel="prefetch" href="/assets/js/38.9f8083e5.js"><link rel="prefetch" href="/assets/js/39.c1961004.js"><link rel="prefetch" href="/assets/js/4.62debd28.js"><link rel="prefetch" href="/assets/js/40.fcdae8fa.js"><link rel="prefetch" href="/assets/js/41.29538f39.js"><link rel="prefetch" href="/assets/js/42.c16ad366.js"><link rel="prefetch" href="/assets/js/43.d16f5e49.js"><link rel="prefetch" href="/assets/js/45.978b35cc.js"><link rel="prefetch" href="/assets/js/46.4c017598.js"><link rel="prefetch" href="/assets/js/47.0eaddaef.js"><link rel="prefetch" href="/assets/js/48.8d699a53.js"><link rel="prefetch" href="/assets/js/49.96ea0379.js"><link rel="prefetch" href="/assets/js/5.f4847a38.js"><link rel="prefetch" href="/assets/js/50.9b54f522.js"><link rel="prefetch" href="/assets/js/51.a7472af4.js"><link rel="prefetch" href="/assets/js/52.bf4b068b.js"><link rel="prefetch" href="/assets/js/53.25f480b7.js"><link rel="prefetch" href="/assets/js/54.21d88e0f.js"><link rel="prefetch" href="/assets/js/55.c8d25d39.js"><link rel="prefetch" href="/assets/js/56.9c58c82c.js"><link rel="prefetch" href="/assets/js/57.da4bebf0.js"><link rel="prefetch" href="/assets/js/58.63d26e3a.js"><link rel="prefetch" href="/assets/js/59.2531f3bb.js"><link rel="prefetch" href="/assets/js/6.a52887f1.js"><link rel="prefetch" href="/assets/js/60.328b3a09.js"><link rel="prefetch" href="/assets/js/61.13224792.js"><link rel="prefetch" href="/assets/js/62.728ee957.js"><link rel="prefetch" href="/assets/js/63.7c73b7c7.js"><link rel="prefetch" href="/assets/js/64.c76e79e3.js"><link rel="prefetch" href="/assets/js/65.43c44fad.js"><link rel="prefetch" href="/assets/js/67.ff492882.js"><link rel="prefetch" href="/assets/js/68.a35057cc.js"><link rel="prefetch" href="/assets/js/69.6382854e.js"><link rel="prefetch" href="/assets/js/70.89864f1b.js"><link rel="prefetch" href="/assets/js/71.280c76dd.js"><link rel="prefetch" href="/assets/js/72.eb100e80.js"><link rel="prefetch" href="/assets/js/73.903c8992.js"><link rel="prefetch" href="/assets/js/74.12b843af.js"><link rel="prefetch" href="/assets/js/75.31486792.js"><link rel="prefetch" href="/assets/js/76.0c2178c7.js"><link rel="prefetch" href="/assets/js/77.6306f7ef.js"><link rel="prefetch" href="/assets/js/78.92cce2a0.js"><link rel="prefetch" href="/assets/js/79.a0684f2d.js"><link rel="prefetch" href="/assets/js/80.6e23d835.js"><link rel="prefetch" href="/assets/js/81.282b545c.js"><link rel="prefetch" href="/assets/js/82.1a25ddb3.js"><link rel="prefetch" href="/assets/js/83.179f61a7.js"><link rel="prefetch" href="/assets/js/84.3e3b5f31.js"><link rel="prefetch" href="/assets/js/85.ce53a54c.js"><link rel="prefetch" href="/assets/js/86.98b8bb37.js"><link rel="prefetch" href="/assets/js/87.9acb7104.js"><link rel="prefetch" href="/assets/js/88.4ac2a1b0.js"><link rel="prefetch" href="/assets/js/89.3dfd5b1d.js"><link rel="prefetch" href="/assets/js/9.72067b46.js"><link rel="prefetch" href="/assets/js/90.05d2c34c.js"><link rel="prefetch" href="/assets/js/91.389badd5.js"><link rel="prefetch" href="/assets/js/92.07ef2869.js"><link rel="prefetch" href="/assets/js/93.c8044225.js"><link rel="prefetch" href="/assets/js/94.6597f744.js"><link rel="prefetch" href="/assets/js/95.47db06ad.js"><link rel="prefetch" href="/assets/js/96.cd4e53e7.js"><link rel="prefetch" href="/assets/js/97.621d6cc9.js"><link rel="prefetch" href="/assets/js/98.425d9618.js"><link rel="prefetch" href="/assets/js/99.d9003496.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.65779e7a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83a33c40.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">xustudyxu's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页​</a></div><div class="nav-item"><a href="/pages/f6054a/" class="nav-link">导航🚀​</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机核心" class="dropdown-title"><!----> <span class="title" style="display:;">计算机核心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/db72cf/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/pages/39e2a1/" class="nav-link">计算机网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e05ef5/" class="nav-link">JavaSE</a></li></ul></li><li class="dropdown-item"><h4>JavaWeb</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/5cda88/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/pages/cea341/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/pages/d893c0/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/pages/6f762f/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/pages/8f83ba/" class="nav-link">Servlet</a></li><li class="dropdown-subitem"><a href="/pages/8bc1c4/" class="nav-link">MVC</a></li><li class="dropdown-subitem"><a href="/pages/f883e2/" class="nav-link">filter|listener</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><!----> <span class="title" style="display:;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/462a90/" class="nav-link">Spring5</a></li><li class="dropdown-item"><!----> <a href="/pages/2e990c/" class="nav-link">SpringMVC</a></li><li class="dropdown-item"><!----> <a href="/pages/0d4af0/" class="nav-link">SpringBoot2</a></li><li class="dropdown-item"><!----> <a href="/pages/870083/" class="nav-link">SpringCloud</a></li><li class="dropdown-item"><!----> <a href="/pages/66babb/" class="nav-link">SpringSecurity</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>搜索引擎</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/596552/" class="nav-link">ElasticSearch</a></li></ul></li><li class="dropdown-item"><h4>消息队列</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e645d9/" class="nav-link">RabbitMQ</a></li></ul></li><li class="dropdown-item"><h4>服务器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9551ee/" class="nav-link">Nginx🌐</a></li></ul></li><li class="dropdown-item"><h4>服务框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/48771f/" class="nav-link">Dubbo</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><!----> <span class="title" style="display:;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Python</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b9268d/" class="nav-link">Python基础</a></li><li class="dropdown-subitem"><a href="/pages/e0bd06/" class="nav-link">数据分析</a></li></ul></li><li class="dropdown-item"><h4>环境搭建</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/600247/" class="nav-link">Hadoop集群</a></li><li class="dropdown-subitem"><a href="/pages/cdeb68/" class="nav-link">KVM虚拟化技术</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title" style="display:;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e72480/" class="nav-link">MySQL</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/7ab056/" class="nav-link">NoSQL数据库概论</a></li><li class="dropdown-subitem"><a href="/pages/e9cc9f/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/pages/91197c/" class="nav-link">MongoDB</a></li><li class="dropdown-subitem"><a href="/pages/2aae92/" class="nav-link">HBase</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/0e424f/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/pages/e0594a/" class="nav-link">MyBatis-Plus</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><!----> <span class="title" style="display:;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/99e9dc/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/pages/90cc29/" class="nav-link">Docker</a></li></ul></li><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/45eca1/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/pages/34892c/" class="nav-link">Git</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试" class="dropdown-title"><!----> <span class="title" style="display:;">面试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/eab19d/" class="nav-link">十大排序算法</a></li><li class="dropdown-item"><!----> <a href="/pages/40ee62/" class="nav-link">力扣算法题</a></li><li class="dropdown-item"><!----> <a href="/pages/39558d/" class="nav-link">初级开发篇</a></li><li class="dropdown-item"><!----> <a href="/pages/47c622/" class="nav-link">中高进阶篇</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/myfriends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><!----> <a href="/pages/bba350/" class="nav-link">优秀博客文章</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="本站" class="dropdown-title"><!----> <span class="title" style="display:;">本站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>索引</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>其他</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9013e4/" class="nav-link">关于</a></li></ul></li></ul></div></div> <a href="https://github.com/xustudyxu/xustudyxu.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220627/mmexport1656324824543.124zxwkqyzlc.webp"> <div class="blogger-info"><h3>xustudyxu</h3> <span>一起学习编程!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页​</a></div><div class="nav-item"><a href="/pages/f6054a/" class="nav-link">导航🚀​</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机核心" class="dropdown-title"><!----> <span class="title" style="display:;">计算机核心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/db72cf/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/pages/39e2a1/" class="nav-link">计算机网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e05ef5/" class="nav-link">JavaSE</a></li></ul></li><li class="dropdown-item"><h4>JavaWeb</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/5cda88/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/pages/cea341/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/pages/d893c0/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/pages/6f762f/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/pages/8f83ba/" class="nav-link">Servlet</a></li><li class="dropdown-subitem"><a href="/pages/8bc1c4/" class="nav-link">MVC</a></li><li class="dropdown-subitem"><a href="/pages/f883e2/" class="nav-link">filter|listener</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><!----> <span class="title" style="display:;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/462a90/" class="nav-link">Spring5</a></li><li class="dropdown-item"><!----> <a href="/pages/2e990c/" class="nav-link">SpringMVC</a></li><li class="dropdown-item"><!----> <a href="/pages/0d4af0/" class="nav-link">SpringBoot2</a></li><li class="dropdown-item"><!----> <a href="/pages/870083/" class="nav-link">SpringCloud</a></li><li class="dropdown-item"><!----> <a href="/pages/66babb/" class="nav-link">SpringSecurity</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>搜索引擎</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/596552/" class="nav-link">ElasticSearch</a></li></ul></li><li class="dropdown-item"><h4>消息队列</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e645d9/" class="nav-link">RabbitMQ</a></li></ul></li><li class="dropdown-item"><h4>服务器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9551ee/" class="nav-link">Nginx🌐</a></li></ul></li><li class="dropdown-item"><h4>服务框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/48771f/" class="nav-link">Dubbo</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><!----> <span class="title" style="display:;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Python</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b9268d/" class="nav-link">Python基础</a></li><li class="dropdown-subitem"><a href="/pages/e0bd06/" class="nav-link">数据分析</a></li></ul></li><li class="dropdown-item"><h4>环境搭建</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/600247/" class="nav-link">Hadoop集群</a></li><li class="dropdown-subitem"><a href="/pages/cdeb68/" class="nav-link">KVM虚拟化技术</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title" style="display:;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e72480/" class="nav-link">MySQL</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/7ab056/" class="nav-link">NoSQL数据库概论</a></li><li class="dropdown-subitem"><a href="/pages/e9cc9f/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/pages/91197c/" class="nav-link">MongoDB</a></li><li class="dropdown-subitem"><a href="/pages/2aae92/" class="nav-link">HBase</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/0e424f/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/pages/e0594a/" class="nav-link">MyBatis-Plus</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><!----> <span class="title" style="display:;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/99e9dc/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/pages/90cc29/" class="nav-link">Docker</a></li></ul></li><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/45eca1/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/pages/34892c/" class="nav-link">Git</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试" class="dropdown-title"><!----> <span class="title" style="display:;">面试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/eab19d/" class="nav-link">十大排序算法</a></li><li class="dropdown-item"><!----> <a href="/pages/40ee62/" class="nav-link">力扣算法题</a></li><li class="dropdown-item"><!----> <a href="/pages/39558d/" class="nav-link">初级开发篇</a></li><li class="dropdown-item"><!----> <a href="/pages/47c622/" class="nav-link">中高进阶篇</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/myfriends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><!----> <a href="/pages/bba350/" class="nav-link">优秀博客文章</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="本站" class="dropdown-title"><!----> <span class="title" style="display:;">本站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>索引</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>其他</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9013e4/" class="nav-link">关于</a></li></ul></li></ul></div></div> <a href="https://github.com/xustudyxu/xustudyxu.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>十大排序算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/eab19d/" class="sidebar-link">十大经典排序算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>面试题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1f387c/" class="sidebar-link">Java 面试题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>力扣算法题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/40ee62/" class="sidebar-link">LeetCode 算法题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SSM-CRUD</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/98f56c/" class="sidebar-link">SSM-CRUD</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SpringBoot+MyBatis-plus</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6de3d6/" class="sidebar-link">瑞吉外卖-介绍</a></li><li><a href="/pages/f5d63e/" class="sidebar-link">瑞吉外卖-员工管理</a></li><li><a href="/pages/f2037b/" class="sidebar-link">瑞吉外卖-分类管理业务开发</a></li><li><a href="/pages/f8dc6e/" class="sidebar-link">瑞吉外卖-菜品管理业务开发</a></li><li><a href="/pages/fcadd4/" class="sidebar-link">瑞吉外卖-套餐管理业务开发</a></li><li><a href="/pages/684cf3/" class="sidebar-link">瑞吉外卖-移动端开发</a></li><li><a href="/pages/93eacc/" class="sidebar-link">瑞吉外卖-移动端业务开发</a></li><li><a href="/pages/68f7f1/" class="sidebar-link">瑞吉外卖-功能补充</a></li><li><a href="/pages/908199/" class="sidebar-link">瑞吉外卖-缓存优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>高级宝典</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/47c622/" class="sidebar-link">尚医通-项目概述</a></li><li><a href="/high/SYT/SYT_build_environment/" class="sidebar-link">尚医通-搭建环境</a></li><li><a href="/high/SYT/SYT_HospitalSet/" class="sidebar-link">尚医通-后台接口</a></li><li><a href="/high/SYT/SYT_fron/" class="sidebar-link">尚医通-前端知识点</a></li><li><a href="/high/SYT/SYT_dataDict/" class="sidebar-link">尚医通-数据字典</a></li><li><a href="/high/SYT/SYT_MongoDB/" class="sidebar-link">尚医通-MongoDB</a></li><li><a href="/high/SYT/SYT_dataInterface/" class="sidebar-link">尚医通-数据接口</a></li><li><a href="/high/SYT/SYT_Background_system/" class="sidebar-link">尚医通-后台系统</a></li><li><a href="/high/SYT/SYT_gateway/" class="sidebar-link">尚医通-技术点-整合服务网关</a></li><li><a href="/high/SYT/SYT_client/" class="sidebar-link">尚医通-客户端平台</a></li><li><a href="/high/SYT/SYT_phoneLogin/" class="sidebar-link">尚医通-手机登录</a></li><li><a href="/high/SYT/SYT_wechatLogin/" class="sidebar-link">尚医通-微信登录</a></li><li><a href="/high/SYT/SYT_SYT_ali_oos/" class="sidebar-link">尚医通- 阿里云OSS、用户认证与就诊人</a></li><li><a href="/high/SYT/SYT_yygh/" aria-current="page" class="active sidebar-link">尚医通-预约挂号</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=baodian" title="分类" data-v-06225672>baodian</a></li><li data-v-06225672><a href="/categories/?category=high" title="分类" data-v-06225672>high</a></li><li data-v-06225672><a href="/categories/?category=SYT" title="分类" data-v-06225672>SYT</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>xu</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-11-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">尚医通-预约挂号<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="尚医通-预约挂号"><a href="#尚医通-预约挂号" class="header-anchor">#</a> 尚医通-预约挂号</h1> <p></p><div class="table-of-contents"><ul><li><a href="#预约挂号详情">预约挂号详情</a><ul><li><a href="#需求分析">需求分析</a></li><li><a href="#api-接口">api 接口</a></li><li><a href="#获取科室信息">获取科室信息</a></li></ul></li><li><a href="#预约确认">预约确认</a><ul><li><a href="#api-接口">api 接口</a></li><li><a href="#添加-service-接口以及实现类">添加 service 接口以及实现类</a></li><li><a href="#添加-controller-接口">添加 Controller 接口</a></li></ul></li><li><a href="#预约下单">预约下单</a><ul><li><a href="#需求分析">需求分析</a></li><li><a href="#搭建-service-order-模块">搭建 service-order 模块</a></li><li><a href="#添加订单基础类">添加订单基础类</a></li><li><a href="#封装-feign-调用获取就诊人接口">封装 Feign 调用获取就诊人接口</a></li><li><a href="#搭建-service-user-client-模块">搭建 service-user-client 模块</a></li><li><a href="#封装feign调用获取排班下单信息接口">封装Feign调用获取排班下单信息接口</a></li></ul></li><li><a href="#实现下单接口">实现下单接口</a><ul><li><a href="#引入依赖">引入依赖</a></li><li><a href="#封装下单工具类">封装下单工具类</a></li></ul></li><li><a href="#预约成功后处理逻辑">预约成功后处理逻辑</a><ul><li><a href="#rabbit-util-模块封装">rabbit-util 模块封装</a></li><li><a href="#封装短信接口">封装短信接口</a></li><li><a href="#封装更新排班数量">封装更新排班数量</a></li><li><a href="#调整下单接口">调整下单接口</a></li></ul></li><li><a href="#订单详情功能">订单详情功能</a><ul><li><a href="#添加-servcie-接口以及实现类">添加 servcie 接口以及实现类</a></li><li><a href="#添加-controller">添加 Controller</a></li></ul></li><li><a href="#订单列表功能">订单列表功能</a><ul><li><a href="#添加-service-接口以及实现">添加 service 接口以及实现</a></li><li><a href="#添加-controller">添加 Controller</a></li></ul></li><li><a href="#订单支付-生成二维码">订单支付（生成二维码）</a><ul><li><a href="#微信支付介绍">微信支付介绍</a></li><li><a href="#微信支付开发">微信支付开发</a></li><li><a href="#处理支付结果">处理支付结果</a></li></ul></li><li><a href="#取消预约">取消预约</a><ul><li><a href="#需求描述">需求描述</a></li><li><a href="#开发微信退款接口">开发微信退款接口</a></li></ul></li></ul></div><p></p> <h2 id="预约挂号详情"><a href="#预约挂号详情" class="header-anchor">#</a> 预约挂号详情</h2> <h3 id="需求分析"><a href="#需求分析" class="header-anchor">#</a> 需求分析</h3> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221110/image.elwutkf0tgw.webp" alt="image"></p> <ol><li>接口分析
<ol><li>根据预约周期，展示可预约日期数据，按分页展示</li> <li>选择日期展示当天可预约列表（该接口后台已经实现过）</li></ol></li> <li>页面展示分析
<ol><li>分页展示可预约日期，根据有号、无号、约满等状态展示不同颜色，以示区分</li> <li>可预约最后一个日期为即将放号日期，根据放号时间页面展示倒计时</li></ol></li></ol> <h3 id="api-接口"><a href="#api-接口" class="header-anchor">#</a> api 接口</h3> <h4 id="添加-service-接口以及实现类"><a href="#添加-service-接口以及实现类" class="header-anchor">#</a> 添加 service 接口以及实现类</h4> <ol><li>在 ScheduleService 类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获取可预约的排版数据</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBookingScheduleRule</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> limit<span class="token punctuation">,</span> <span class="token class-name">String</span> hoscode<span class="token punctuation">,</span> <span class="token class-name">String</span> depcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在 ScheduleServiceImpl 类添加接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获取可预约的排班数据</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBookingScheduleRule</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> limit<span class="token punctuation">,</span> <span class="token class-name">String</span> hoscode<span class="token punctuation">,</span> <span class="token class-name">String</span> depcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取预约规则</span>
        <span class="token comment">//根据医院的编号获取预约的规则</span>
        <span class="token class-name">Hospital</span> hospital <span class="token operator">=</span> hospitalService<span class="token punctuation">.</span><span class="token function">getByHosCode</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hospital<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">DATA_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">BookingRule</span> bookingRule <span class="token operator">=</span> hospital<span class="token punctuation">.</span><span class="token function">getBookingRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取可预约的日期的数据(分页)</span>
        <span class="token class-name">IPage</span> iPage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getListDate</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>limit<span class="token punctuation">,</span>bookingRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取可预约的日期</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dateList <span class="token operator">=</span> iPage<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取可预约日期里面科室剩余预约数</span>
        <span class="token class-name">Criteria</span>  criteria <span class="token operator">=</span> <span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;depcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>depcode<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;workDate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>dateList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Aggregation</span> agg <span class="token operator">=</span> <span class="token class-name">Aggregation</span><span class="token punctuation">.</span><span class="token function">newAggregation</span><span class="token punctuation">(</span>
                <span class="token class-name">Aggregation</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>criteria<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Aggregation</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&quot;workDate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token string">&quot;workDate&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">&quot;workDate&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">&quot;docCount&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;availableNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">&quot;availableNumber&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;reservedNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">&quot;reservedNumber&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AggregationResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">&gt;</span></span> aggregateResult <span class="token operator">=</span>
                mongoTemplate<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>agg<span class="token punctuation">,</span> <span class="token class-name">Schedule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">&gt;</span></span> scheduleRuleVoList <span class="token operator">=</span> aggregateResult<span class="token punctuation">.</span><span class="token function">getMappedResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//合并数据 map集合 key日期 value预约规则和数量信息</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">,</span> <span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">&gt;</span></span> scheduleVoMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>scheduleRuleVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            scheduleVoMap <span class="token operator">=</span> scheduleRuleVoList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
                        <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">BookingScheduleRuleVo</span><span class="token operator">::</span><span class="token function">getWorkDate</span><span class="token punctuation">,</span>
                        <span class="token class-name">BookingScheduleRuleVo</span> <span class="token operator">-&gt;</span> <span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取可预约排班规则</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">&gt;</span></span> bookingScheduleRuleVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>len <span class="token operator">=</span> dateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> len <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Date</span> date <span class="token operator">=</span> dateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//从map集合中根据key日期获取value值</span>
            <span class="token class-name">BookingScheduleRuleVo</span> bookingScheduleRuleVo <span class="token operator">=</span> scheduleVoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果说当天没有判断医生</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>bookingScheduleRuleVo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                bookingScheduleRuleVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookingScheduleRuleVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//就诊医生人数</span>
                bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setDocCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//科室剩余预约数 -1表示无号</span>
                bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setAvailableNumber</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setWorkDate</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setWorkDateMd</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计算当前预约日期对应星期</span>
            <span class="token class-name">String</span> dayOfWeek <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDayOfWeek</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setDayOfWeek</span><span class="token punctuation">(</span>dayOfWeek<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//最后一页最后一条记录为即将预约 状态 0：正常 1：即将放号  -1：当天已停止放号</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span>len<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> page <span class="token operator">==</span> iPage<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//当天预约如果过了停号时间，不能预约</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> page <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">DateTime</span> stopTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getStopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>stopTime<span class="token punctuation">.</span><span class="token function">isBeforeNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//停止预约</span>
                    bookingScheduleRuleVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            bookingScheduleRuleVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bookingScheduleRuleVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//可预约日期规则数据</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bookingScheduleList&quot;</span><span class="token punctuation">,</span> bookingScheduleRuleVoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> iPage<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//其他基础数据</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> baseMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//医院名称</span>
        baseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hosname&quot;</span><span class="token punctuation">,</span> hospitalService<span class="token punctuation">.</span><span class="token function">getHospName</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//科室</span>
        <span class="token class-name">Department</span> department <span class="token operator">=</span>departmentService<span class="token punctuation">.</span><span class="token function">getDepartment</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">,</span> depcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//大科室名称</span>
        baseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bigname&quot;</span><span class="token punctuation">,</span> department<span class="token punctuation">.</span><span class="token function">getBigname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//科室名称</span>
        baseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;depname&quot;</span><span class="token punctuation">,</span> department<span class="token punctuation">.</span><span class="token function">getDepname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//月</span>
        baseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;workDateString&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy年MM月&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//放号时间</span>
        baseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;releaseTime&quot;</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getReleaseTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//停号时间</span>
        baseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;stopTime&quot;</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getStopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;baseMap&quot;</span><span class="token punctuation">,</span> baseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取可预约的日志分页数据</span>
    <span class="token keyword">private</span> <span class="token class-name">IPage</span> <span class="token function">getListDate</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> limit<span class="token punctuation">,</span> <span class="token class-name">BookingRule</span> bookingRule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取当天放号的一个时间 年 月 日 小时 分钟</span>
        <span class="token class-name">DateTime</span> releaseTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getReleaseTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取预约周期</span>
        <span class="token class-name">Integer</span> cycle <span class="token operator">=</span> bookingRule<span class="token punctuation">.</span><span class="token function">getCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果当天放号时间已经过去了，预约周期从后一天开始计算，周期+1</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>releaseTime<span class="token punctuation">.</span><span class="token function">isBeforeNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             cycle <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取可预约的所有的日期，最后一天显示即将放号</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cycle<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DateTime</span> currentDateTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> dataSting <span class="token operator">=</span> currentDateTime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>dataSting<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//因为预约周期是不同的，每页显示的日期最多七天的数据，超过七天分页</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> pageDateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>limit<span class="token punctuation">;</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>limit<span class="token operator">+</span>limit<span class="token punctuation">;</span>
        <span class="token comment">//如果可以显示的数据小于7，直接显示</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>end <span class="token operator">&gt;</span> dateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            end <span class="token operator">=</span> dateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pageDateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果可以显示的数据大于7，进行分页</span>
        <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> iPage <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>pagination<span class="token punctuation">.</span></span>Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> dateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iPage<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>pageDateList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> iPage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 将Date日期（yyyy-MM-dd HH:mm）转换为DateTime
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DateTime</span> <span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">,</span> <span class="token class-name">String</span> timeString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> dateTimeString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token operator">+</span> timeString<span class="token punctuation">;</span>
        <span class="token class-name">DateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">DateTimeFormat</span><span class="token punctuation">.</span><span class="token function">forPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseDateTime</span><span class="token punctuation">(</span>dateTimeString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dateTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br></div></div><h3 id="获取科室信息"><a href="#获取科室信息" class="header-anchor">#</a> 获取科室信息</h3> <h4 id="添加-service-接口以及实现类-2"><a href="#添加-service-接口以及实现类-2" class="header-anchor">#</a> 添加 service 接口以及实现类</h4> <ol><li>在DepartmentService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根绝科室编号，和医院编号，查询科室</span>
    <span class="token class-name">Department</span> <span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token class-name">String</span> hoscode<span class="token punctuation">,</span> <span class="token class-name">String</span> depcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在DepartmentImpl类实现接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Department</span> <span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token class-name">String</span> hoscode<span class="token punctuation">,</span> <span class="token class-name">String</span> depcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> departmentRepository<span class="token punctuation">.</span><span class="token function">getDepartemntByHoscodeAndDepcode</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">,</span>depcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="添加-controller-接口"><a href="#添加-controller-接口" class="header-anchor">#</a> 添加 Controller 接口</h4> <p>在HospitalApiController类添加方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获取可预约的排班数据</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取可预约排版数据&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/getBookingScheduleRule/{page}/{limit}/{hoscode}/{depcode}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getBookingScheduleRule</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span>
                                         <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> limit<span class="token punctuation">,</span>
                                         <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> hoscode<span class="token punctuation">,</span>
                                         <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> depcode<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>scheduleService<span class="token punctuation">.</span><span class="token function">getBookingScheduleRule</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>limit<span class="token punctuation">,</span>hoscode<span class="token punctuation">,</span>depcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取排班的具体数据</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取排班数据&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/findScheduleList/{hoscode}/{depcode}/{workData}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findScheduleList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> hoscode<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> depcode<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> workData<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>scheduleService<span class="token punctuation">.</span><span class="token function">getDetailSchedule</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">,</span>depcode<span class="token punctuation">,</span>workData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ul><li>前端访问结果</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221111/image.f4tftfyowls.webp" alt="image"></p> <h2 id="预约确认"><a href="#预约确认" class="header-anchor">#</a> 预约确认</h2> <ol><li>根据排班id获取排班信息，在页面展示</li> <li>选择就诊人</li> <li>预约下单</li></ol> <h3 id="api-接口-2"><a href="#api-接口-2" class="header-anchor">#</a> api 接口</h3> <h3 id="添加-service-接口以及实现类-3"><a href="#添加-service-接口以及实现类-3" class="header-anchor">#</a> 添加 service 接口以及实现类</h3> <ol><li>在ScheduleService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根绝排班id获取排班数据</span>
    <span class="token class-name">Schedule</span> <span class="token function">getScheduleById</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在ScheduleServiceImpl类实现接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根绝排班id获取排班数据</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Schedule</span> <span class="token function">getScheduleById</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Schedule</span> schedule <span class="token operator">=</span> scheduleRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">packageSchedule</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="添加-controller-接口-2"><a href="#添加-controller-接口-2" class="header-anchor">#</a> 添加 Controller 接口</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根绝排班id获取排班数据</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;根绝排班id获取排班数据&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getSchedule/{scheduleId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getSchedule</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Schedule</span> schedule <span class="token operator">=</span> scheduleService<span class="token punctuation">.</span><span class="token function">getScheduleById</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>前端访问测试</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221112/image.3bp70uuqkjq0.webp" alt="image"></p> <h2 id="预约下单"><a href="#预约下单" class="header-anchor">#</a> 预约下单</h2> <p>由于预约下单后台api接口相对复杂，我们先实现前端，前端配合调试api接口。</p> <h3 id="需求分析-2"><a href="#需求分析-2" class="header-anchor">#</a> 需求分析</h3> <h4 id="订单表结构"><a href="#订单表结构" class="header-anchor">#</a> 订单表结构</h4> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221112/image.q58f24waf1s.webp" alt="image"></p> <h4 id="下单分析"><a href="#下单分析" class="header-anchor">#</a> 下单分析</h4> <p>下单参数：就诊人id与排班id</p> <ol><li>下单我们要获取就诊人信息</li> <li>获取排班下单信息与规则信息</li> <li>获取医院签名信息，然后通过接口去医院预约下单</li> <li>下单成功更新排班信息与发送短信</li></ol> <h3 id="搭建-service-order-模块"><a href="#搭建-service-order-模块" class="header-anchor">#</a> 搭建 service-order 模块</h3> <h4 id="修改配置"><a href="#修改配置" class="header-anchor">#</a> 修改配置</h4> <ol><li>修改 pom.xml,引入依赖</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service-cmn-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>添加配置文件 application.properties</li></ol> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 服务端口</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8206</span>
<span class="token comment"># 服务名</span>
<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">service-order</span>
<span class="token comment"># 环境设置：dev、test、prod</span>
<span class="token key attr-name">spring.profiles.active</span><span class="token punctuation">=</span><span class="token value attr-value">dev</span>
<span class="token comment"># mysql数据库连接</span>
<span class="token key attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/yygh_hosp?characterEncoding=utf-8&amp;useSSL=false</span>
<span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">hsp</span>
<span class="token comment">#返回json的全局时间格式</span>
<span class="token key attr-name">spring.jackson.date-format</span><span class="token punctuation">=</span><span class="token value attr-value">yyyy-MM-dd HH:mm:ss</span>
<span class="token key attr-name">spring.jackson.time-zone</span><span class="token punctuation">=</span><span class="token value attr-value">GMT+8</span>
<span class="token key attr-name">spring.data.mongodb.uri</span><span class="token punctuation">=</span><span class="token value attr-value">mongodb://192.168.91.166:27017/yygh_hosp</span>
<span class="token comment"># nacos服务地址</span>
<span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="启动类"><a href="#启动类" class="header-anchor">#</a> 启动类</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.frx01&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.frx01&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceOrderApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ServiceOrderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="配置网关"><a href="#配置网关" class="header-anchor">#</a> 配置网关</h4> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#设置路由id</span>
<span class="token key attr-name">spring.cloud.gateway.routes[6].id</span><span class="token punctuation">=</span><span class="token value attr-value">service-order</span>
<span class="token comment">#设置路由的uri</span>
<span class="token key attr-name">spring.cloud.gateway.routes[6].uri</span><span class="token punctuation">=</span><span class="token value attr-value">lb://service-order</span>
<span class="token comment">#设置路由断言,代理servicerId为auth-service的/auth/路径</span>
<span class="token key attr-name">spring.cloud.gateway.routes[6].predicates</span><span class="token punctuation">=</span> <span class="token value attr-value">Path=/*/order/**</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="添加订单基础类"><a href="#添加订单基础类" class="header-anchor">#</a> 添加订单基础类</h3> <h4 id="添加-model"><a href="#添加-model" class="header-anchor">#</a> 添加 model</h4> <p>说明：由于实体对象没有逻辑，我们已经统一导入</p> <p>com.frx01.yygh.model.order.OrderInfo</p> <h4 id="添加-mapper"><a href="#添加-mapper" class="header-anchor">#</a> 添加 Mapper</h4> <p>添加com.frx01.yygh.order.mapper.OrderInfoMapper,添加配置类，扫描mapper包</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderInfoMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="添加-service-接口及实现类"><a href="#添加-service-接口及实现类" class="header-anchor">#</a> 添加 service 接口及实现类</h4> <ol><li>添加com.frx01.yygh.order.service.OrderService接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//生成挂号的订单</span>
    <span class="token class-name">Long</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">,</span> <span class="token class-name">String</span> patientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li>添加com.frx01.yygh.order.service.impl.OrderServiceImpl接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfoMapper</span><span class="token punctuation">,</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">,</span> <span class="token class-name">String</span> patientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="添加-controller"><a href="#添加-controller" class="header-anchor">#</a> 添加 Controller</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/order/orderInfo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderApiController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
    <span class="token comment">//生成挂号的订单</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/submitOrder/{scheduleId}/{patientId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveOrders</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> scheduleId<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> patientId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Long</span> orderId <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">saveOrder</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">,</span>patientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="封装-feign-调用获取就诊人接口"><a href="#封装-feign-调用获取就诊人接口" class="header-anchor">#</a> 封装 Feign 调用获取就诊人接口</h3> <h4 id="获取就诊人信息-api-接口"><a href="#获取就诊人信息-api-接口" class="header-anchor">#</a> 获取就诊人信息 api 接口</h4> <p>操作模块：service-user</p> <p>在PatientApiController类添加方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根绝就诊人id获取就诊人信息</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/inner/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Patient</span> <span class="token function">getPatientOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Patient</span> patient <span class="token operator">=</span> patientService<span class="token punctuation">.</span><span class="token function">getPatientId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> patient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="搭建-service-user-client-模块"><a href="#搭建-service-user-client-模块" class="header-anchor">#</a> 搭建 service-user-client 模块</h3> <h4 id="添加-feign-接口类"><a href="#添加-feign-接口类" class="header-anchor">#</a> 添加 Feign 接口类</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-user&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PatientFeignClient</span> <span class="token punctuation">{</span>
    <span class="token comment">//根绝就诊人id获取就诊人信息</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/user/patient/inner/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Patient</span> <span class="token function">getPatientOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="封装feign调用获取排班下单信息接口"><a href="#封装feign调用获取排班下单信息接口" class="header-anchor">#</a> 封装Feign调用获取排班下单信息接口</h3> <h4 id="获取排班下单信息api接口"><a href="#获取排班下单信息api接口" class="header-anchor">#</a> 获取排班下单信息api接口</h4> <h5 id="添加-service-接口与实现"><a href="#添加-service-接口与实现" class="header-anchor">#</a> 添加 service 接口与实现</h5> <ol><li>在 ScheduleService 类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根据排班id获取预约下单数据</span>
    <span class="token class-name">ScheduleOrderVo</span> <span class="token function">getScheduleOrderVo</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在ScheduleServiceImpl类 添加实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ScheduleOrderVo</span> <span class="token function">getScheduleOrderVo</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ScheduleOrderVo</span> scheduleOrderVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleOrderVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取排班的信息</span>
        <span class="token class-name">Schedule</span> schedule <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>schedule <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取预约规则信息</span>
        <span class="token class-name">Hospital</span> hospital <span class="token operator">=</span> hospitalService<span class="token punctuation">.</span><span class="token function">getByHosCode</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hospital<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">BookingRule</span> bookingRule <span class="token operator">=</span> hospital<span class="token punctuation">.</span><span class="token function">getBookingRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bookingRule <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//把获取数据设置到ScheduleOrderVo中去</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setHoscode</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setHosname</span><span class="token punctuation">(</span>hospitalService<span class="token punctuation">.</span><span class="token function">getHospName</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setDepcode</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getDepcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setDepname</span><span class="token punctuation">(</span>departmentService<span class="token punctuation">.</span><span class="token function">getDepName</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule<span class="token punctuation">.</span><span class="token function">getDepcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setHosScheduleId</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getHosScheduleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setAvailableNumber</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getAvailableNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setReserveDate</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getWorkDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setReserveTime</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getWorkTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//退号截止天数（如：就诊前一天为-1，当天为0）</span>
        <span class="token keyword">int</span> quitDay <span class="token operator">=</span> bookingRule<span class="token punctuation">.</span><span class="token function">getQuitDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DateTime</span> quitTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span><span class="token function">getWorkDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span>quitDay<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getQuitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setQuitTime</span><span class="token punctuation">(</span>quitTime<span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//预约开始时间</span>
        <span class="token class-name">DateTime</span> startTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getReleaseTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>startTime<span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//预约截止时间</span>
        <span class="token class-name">DateTime</span> endTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span>bookingRule<span class="token punctuation">.</span><span class="token function">getCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getStopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>endTime<span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当天停止挂号时间</span>
        <span class="token class-name">DateTime</span> stopTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bookingRule<span class="token punctuation">.</span><span class="token function">getStopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleOrderVo<span class="token punctuation">.</span><span class="token function">setStopTime</span><span class="token punctuation">(</span>stopTime<span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> scheduleOrderVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h5 id="添加-controller-方法"><a href="#添加-controller-方法" class="header-anchor">#</a> 添加 Controller 方法</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;根据排班id获取预约下单数据&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/inner/getScheduleOrderVo/{scheduleId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ScheduleOrderVo</span> <span class="token function">getScheduleOrderVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;scheduleId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> scheduleService<span class="token punctuation">.</span><span class="token function">getScheduleOrderVo</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="添加-feign-接口类-2"><a href="#添加-feign-接口类-2" class="header-anchor">#</a> 添加 Feign 接口类</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-hosp&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HospitalFeignClient</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 根据排班id获取预约下单数据
     * @param scheduleId
     * @return
     */</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;根据排班id获取预约下单数据&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/hosp/hospital/inner/getScheduleOrderVo/{scheduleId}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">ScheduleOrderVo</span> <span class="token function">getScheduleOrderVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;scheduleId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="获取下单引用签名信息接口"><a href="#获取下单引用签名信息接口" class="header-anchor">#</a> 获取下单引用签名信息接口</h4> <h5 id="添加-service-接口以及实现类-4"><a href="#添加-service-接口以及实现类-4" class="header-anchor">#</a> 添加 service 接口以及实现类</h5> <ol><li>在HospitalSetService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获取医院签名信息</span>
    <span class="token class-name">SignInfoVo</span> <span class="token function">getSignInfoVo</span><span class="token punctuation">(</span><span class="token class-name">SignInfoVo</span> hoscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在 HospitalSetServiceImpl 类实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根据医院编号获取医院签名信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SignInfoVo</span> <span class="token function">getSignInfoVo</span><span class="token punctuation">(</span><span class="token class-name">SignInfoVo</span> hoscode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HospitalSet</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">,</span>hoscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HospitalSet</span> hospitalSet <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> hospitalSet<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">HOSPITAL_OPEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">SignInfoVo</span> signInfoVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignInfoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signInfoVo<span class="token punctuation">.</span><span class="token function">setSignKey</span><span class="token punctuation">(</span>hospitalSet<span class="token punctuation">.</span><span class="token function">getSignKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signInfoVo<span class="token punctuation">.</span><span class="token function">setApiUrl</span><span class="token punctuation">(</span>hospitalSet<span class="token punctuation">.</span><span class="token function">getApiUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> signInfoVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="添加-controller-方法-2"><a href="#添加-controller-方法-2" class="header-anchor">#</a> 添加 Controller 方法</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取医院签名信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/inner/getSignInfoVo/{hoscode}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SignInfoVo</span> <span class="token function">getSignInfoVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">)</span> <span class="token class-name">SignInfoVo</span> hoscode<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> hospitalSetService<span class="token punctuation">.</span><span class="token function">getSignInfoVo</span><span class="token punctuation">(</span>hoscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="添加-feign-接口类-3"><a href="#添加-feign-接口类-3" class="header-anchor">#</a> 添加 Feign 接口类</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 获取医院签名信息
     * @param hoscode
     * @return
     */</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取医院签名信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/hosp/hospital/inner/getSignInfoVo/{hoscode}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">SignInfoVo</span> <span class="token function">getSignInfoVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> hoscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="实现下单接口"><a href="#实现下单接口" class="header-anchor">#</a> 实现下单接口</h2> <p>操作模块：service-order</p> <h3 id="引入依赖"><a href="#引入依赖" class="header-anchor">#</a> 引入依赖</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service-cmn-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service-hosp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service-user-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="封装下单工具类"><a href="#封装下单工具类" class="header-anchor">#</a> 封装下单工具类</h3> <p>封装HttpRequestHelper类，添加签名请求方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpRequestHelper</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     *
     * @param paramMap
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">switchMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> paramMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> param <span class="token operator">:</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 请求数据获取签名
     * @param paramMap
     * @param signKey
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap<span class="token punctuation">,</span> <span class="token class-name">String</span> signKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;sign&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            paramMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;sign&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sorted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>paramMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">:</span> sorted<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            str<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        str<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>signKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;加密前：&quot;</span> <span class="token operator">+</span> str<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> md5Str <span class="token operator">=</span> <span class="token constant">MD5</span><span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;加密后：&quot;</span> <span class="token operator">+</span> md5Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> md5Str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 签名校验
     * @param paramMap
     * @param signKey
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isSignEquals</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap<span class="token punctuation">,</span> <span class="token class-name">String</span> signKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>paramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sign&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> md5Str <span class="token operator">=</span> <span class="token function">getSign</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">,</span> signKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>sign<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>md5Str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 获取时间戳
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 封装同步请求
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JSONObject</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//封装post参数</span>
            <span class="token class-name">StringBuilder</span> postdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">:</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                postdata<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt; 发送请求：post data %1s&quot;</span><span class="token punctuation">,</span> postdata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reqData <span class="token operator">=</span> postdata<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> respdata <span class="token operator">=</span> <span class="token class-name">HttpUtil</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>reqData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>respdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt; 应答结果：result data %1s&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h2 id="预约成功后处理逻辑"><a href="#预约成功后处理逻辑" class="header-anchor">#</a> 预约成功后处理逻辑</h2> <p>预约成功后我们要更新预约数和短信提醒预约成功，为了提高下单的并发性，这部分逻辑我们就交给mq为我们完成，预约成功发送消息即可。</p> <ol><li><strong>RabbitMQ简介</strong></li></ol> <p>以商品订单场景为例，</p> <p>如果商品服务和订单服务是两个不同的微服务，在下单的过程中订单服务需要调用商品服务进行扣库存操作。按照传统的方式，下单过程要等到调用完毕之后才能返回下单成功，如果网络产生波动等原因使得商品服务扣库存延迟或者失败，会带来较差的用户体验，如果在高并发的场景下，这样的处理显然是不合适的，那怎么进行优化呢？这就需要消息队列登场了。</p> <p>消息队列提供一个异步通信机制，消息的发送者不必一直等待到消息被成功处理才返回，而是立即返回。消息中间件负责处理网络通信，如果网络连接不可用，消息被暂存于队列当中，当网络畅通的时候在将消息转发给相应的应用程序或者服务，当然前提是这些服务订阅了该队列。如果在商品服务和订单服务之间使用消息中间件，既可以提高并发量，又降低服务之间的耦合度。</p> <p>RabbitMQ就是这样一款消息队列。RabbitMQ是一个开源的消息代理的队列服务器，用来通过普通协议在完全不同的应用之间共享数据。</p> <ol start="2"><li><strong>典型应用场景：</strong></li></ol> <p><strong>异步处理</strong>。把消息放入消息中间件中，等到需要的时候再去处理。</p> <p><strong>流量削峰</strong>。例如秒杀活动，在短时间内访问量急剧增加，使用消息队列，当消息队列满了就拒绝响应，跳转到错误页面，这样就可以使得系统不会因为超负载而崩溃。</p> <p><strong>日志处理</strong></p> <p><strong>应用解耦</strong></p> <ol start="3"><li>安装RabbitMQ</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">docker</span> pull rabbitmq:management
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 <span class="token parameter variable">--name</span> rabbitmq rabbitmq:management
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>管理后台</strong>：http://IP:15672</p> <ul><li>访问</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221112/image.14f0on7uwxog.webp" alt="image"></p> <h3 id="rabbit-util-模块封装"><a href="#rabbit-util-模块封装" class="header-anchor">#</a> rabbit-util 模块封装</h3> <p>由于后续可能多个模块都会使用mq，所以我们把它封装成一个模块，需要的地方直接引用即可</p> <h4 id="修改-pom-xml"><a href="#修改-pom-xml" class="header-anchor">#</a> 修改 pom.xml</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--rabbitmq消息队列--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="封装-service-方法"><a href="#封装-service-方法" class="header-anchor">#</a> 封装 service 方法</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 发送消息
     * @param exchange    交换机
     * @param rootingKey  路由键
     * @param message     消息
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> exchange<span class="token punctuation">,</span><span class="token class-name">String</span> rootingKey<span class="token punctuation">,</span><span class="token class-name">Object</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span>rootingKey<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="配置-mq-消息转换器"><a href="#配置-mq-消息转换器" class="header-anchor">#</a> 配置 mq 消息转换器</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MQconfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>说明：默认是字符串转换器</p> <h3 id="封装短信接口"><a href="#封装短信接口" class="header-anchor">#</a> 封装短信接口</h3> <p>操作模块：service-msm</p> <h4 id="引入依赖-2"><a href="#引入依赖-2" class="header-anchor">#</a> 引入依赖</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rabbit-util<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="添加配置"><a href="#添加配置" class="header-anchor">#</a> 添加配置</h4> <p>在resources/application.properties添加</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#rabbitmq地址</span>
<span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.91.166</span>
<span class="token key attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token value attr-value">15672</span>
<span class="token key attr-name">spring.rabbitmq.username</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
<span class="token key attr-name">spring.rabbitmq.password</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="添加常量配置"><a href="#添加常量配置" class="header-anchor">#</a> 添加常量配置</h4> <p>在rabbit-util模块com.frx01.yygh.common.constant.MqConst类添加</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConst</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 预约下单
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_DIRECT_ORDER</span>
            <span class="token operator">=</span> <span class="token string">&quot;exchange.direct.order&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_ORDER</span> <span class="token operator">=</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_ORDER</span>  <span class="token operator">=</span> <span class="token string">&quot;queue.order&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 短信
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_DIRECT_MSM</span> <span class="token operator">=</span> <span class="token string">&quot;exchange.direct.msm&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_MSM_ITEM</span> <span class="token operator">=</span> <span class="token string">&quot;msm.item&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_MSM_ITEM</span>  <span class="token operator">=</span> <span class="token string">&quot;queue.msm.item&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="在model模块封装短信实体"><a href="#在model模块封装短信实体" class="header-anchor">#</a> 在model模块封装短信实体</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;短信实体&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsmVo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;短信模板code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> templateCode<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;短信模板参数&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>说明：已统一引入</p> <h4 id="封装-service-接口"><a href="#封装-service-接口" class="header-anchor">#</a> 封装 service 接口</h4> <ol><li>在 MsmService 类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MsmVo</span> msmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>在 MsmServiceImpl 类添加接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//使用mq发送短信</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MsmVo</span> msmVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>msmVo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msmVo<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isSend <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msmVo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> isSend<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="封装-mq-监听器"><a href="#封装-mq-监听器" class="header-anchor">#</a> 封装 mq 监听器</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsmReceiver</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MsmService</span> msmService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">QUEUE_MSM_ITEM</span><span class="token punctuation">,</span>durable <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_DIRECT_MSM</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">ROUTING_MSM_ITEM</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MsmVo</span> msmVo<span class="token punctuation">,</span> <span class="token class-name">Message</span> message <span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        msmService<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="封装更新排班数量"><a href="#封装更新排班数量" class="header-anchor">#</a> 封装更新排班数量</h3> <p>操作模块：service-hosp</p> <h4 id="引入依赖-3"><a href="#引入依赖-3" class="header-anchor">#</a> 引入依赖</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rabbit-util<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="添加配置-2"><a href="#添加配置-2" class="header-anchor">#</a> 添加配置</h4> <p>在resources/application.properties添加</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#rabbitmq地址</span>
<span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.91.166</span>
<span class="token key attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token value attr-value">15672</span>
<span class="token key attr-name">spring.rabbitmq.username</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
<span class="token key attr-name">spring.rabbitmq.password</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="添加常量配置-2"><a href="#添加常量配置-2" class="header-anchor">#</a> 添加常量配置</h4> <p>在rabbit-util模块com.frx01.yygh.common.constant.MqConst类添加</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 预约下单
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_DIRECT_ORDER</span> <span class="token operator">=</span> <span class="token string">&quot;exchange.direct.order&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_ORDER</span> <span class="token operator">=</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//队列</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_ORDER</span>  <span class="token operator">=</span> <span class="token string">&quot;queue.order&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="在model模块封装更新排班实体"><a href="#在model模块封装更新排班实体" class="header-anchor">#</a> 在model模块封装更新排班实体</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;短信实体&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsmVo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;短信模板code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> templateCode<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;短信模板参数&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>说明：已统一引入，该对象放一个短信实体，预约下单成功后，我们发送一条消息，让mq来保证两个消息都发送成功。</p> <h4 id="封装-service-接口-2"><a href="#封装-service-接口-2" class="header-anchor">#</a> 封装 service 接口</h4> <ol><li>在ScheduleService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//更新排版数据</span>
    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Schedule</span> schedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在ScheduleServiceImpl类添加接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//更新排班信息,用于mq的操作</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Schedule</span> schedule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        schedule<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="封装mq监听器"><a href="#封装mq监听器" class="header-anchor">#</a> 封装mq监听器</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HospitalReceiver</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ScheduleService</span> scheduleService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitService</span> rabbitService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ORDER</span><span class="token punctuation">,</span> durable <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_DIRECT_ORDER</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">ROUTING_ORDER</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiver</span><span class="token punctuation">(</span><span class="token class-name">OrderMqVo</span> orderMqVo<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//下单成功更新预约数</span>
        <span class="token class-name">Schedule</span> schedule <span class="token operator">=</span> scheduleService<span class="token punctuation">.</span><span class="token function">getScheduleById</span><span class="token punctuation">(</span>orderMqVo<span class="token punctuation">.</span><span class="token function">getScheduleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        schedule<span class="token punctuation">.</span><span class="token function">setReservedNumber</span><span class="token punctuation">(</span>orderMqVo<span class="token punctuation">.</span><span class="token function">getReservedNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        schedule<span class="token punctuation">.</span><span class="token function">setAvailableNumber</span><span class="token punctuation">(</span>orderMqVo<span class="token punctuation">.</span><span class="token function">getAvailableNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduleService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送短信</span>
        <span class="token class-name">MsmVo</span> msmVo <span class="token operator">=</span> orderMqVo<span class="token punctuation">.</span><span class="token function">getMsmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> msmVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rabbitService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_DIRECT_MSM</span><span class="token punctuation">,</span> <span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">ROUTING_MSM_ITEM</span><span class="token punctuation">,</span> msmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="调整下单接口"><a href="#调整下单接口" class="header-anchor">#</a> 调整下单接口</h3> <p>操作模块：service-order</p> <h4 id="引入依赖-4"><a href="#引入依赖-4" class="header-anchor">#</a> 引入依赖</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.frx01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service-order<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="添加配置-3"><a href="#添加配置-3" class="header-anchor">#</a> 添加配置</h4> <p>在resources/application.properties添加</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#rabbitmq地址</span>
<span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.91.166</span>
<span class="token key attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token value attr-value">15672</span>
<span class="token key attr-name">spring.rabbitmq.username</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
<span class="token key attr-name">spring.rabbitmq.password</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="修改下单接口"><a href="#修改下单接口" class="header-anchor">#</a> 修改下单接口</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//生成挂号订单</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheduleId<span class="token punctuation">,</span> <span class="token class-name">Long</span> patientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取就诊人信息</span>
        <span class="token class-name">Patient</span> patient <span class="token operator">=</span> patientFeignClient<span class="token punctuation">.</span><span class="token function">getPatientOrder</span><span class="token punctuation">(</span>patientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取排相关的信息</span>
        <span class="token class-name">ScheduleOrderVo</span> scheduleOrderVo <span class="token operator">=</span> hospitalFeignClient<span class="token punctuation">.</span><span class="token function">getScheduleOrderVo</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断当前是否还可以预约</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>scheduleOrderVo<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfterNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>scheduleOrderVo<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBeforeNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">TIME_NO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取签名的信息</span>
        <span class="token class-name">SignInfoVo</span> signInfoVo <span class="token operator">=</span> hospitalFeignClient<span class="token punctuation">.</span><span class="token function">getSignInfoVo</span><span class="token punctuation">(</span>scheduleOrderVo<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加到订单的表中</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//把 scheduleOrderVo 中的数据 复制到 orderInfo中去</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>scheduleOrderVo<span class="token punctuation">,</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向orderInfo设置其他的数据</span>
        <span class="token class-name">String</span> outTradeNo <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setScheduleId</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>patient<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setPatientId</span><span class="token punctuation">(</span>patientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setPatientName</span><span class="token punctuation">(</span>patient<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setPatientPhone</span><span class="token punctuation">(</span>patient<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">UNPAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用医院的接口，实现预约挂号操作</span>
        <span class="token comment">//设置调用医院接口需要参数，参数放到map集合</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;depcode&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getDepcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hosScheduleId&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getScheduleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;reserveDate&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getReserveDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;reserveTime&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getReserveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;certificatesType&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getCertificatesType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;certificatesNo&quot;</span><span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token function">getCertificatesNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;birthdate&quot;</span><span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token function">getBirthdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;isMarry&quot;</span><span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token function">getIsMarry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;provinceCode&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getProvinceCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cityCode&quot;</span><span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token function">getCityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;districtCode&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getDistrictCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//联系人</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;contactsName&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getContactsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;contactsCertificatesType&quot;</span><span class="token punctuation">,</span> patient<span class="token punctuation">.</span><span class="token function">getContactsCertificatesType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;contactsCertificatesNo&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getContactsCertificatesNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;contactsPhone&quot;</span><span class="token punctuation">,</span>patient<span class="token punctuation">.</span><span class="token function">getContactsPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">,</span> signInfoVo<span class="token punctuation">.</span><span class="token function">getSignKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sign&quot;</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求医院系统接口</span>
        <span class="token class-name">JSONObject</span> result <span class="token operator">=</span>
                <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">,</span> signInfoVo<span class="token punctuation">.</span><span class="token function">getApiUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/order/submitOrder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//预约记录唯一标识（医院预约记录主键）</span>
            <span class="token class-name">String</span> hosRecordId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;hosRecordId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//预约序号</span>
            <span class="token class-name">Integer</span> number <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token comment">//取号时间</span>
            <span class="token class-name">String</span> fetchTime <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;fetchTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token comment">//取号地址</span>
            <span class="token class-name">String</span> fetchAddress <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;fetchAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token comment">//更新订单</span>
            orderInfo<span class="token punctuation">.</span><span class="token function">setHosRecordId</span><span class="token punctuation">(</span>hosRecordId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderInfo<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderInfo<span class="token punctuation">.</span><span class="token function">setFetchTime</span><span class="token punctuation">(</span>fetchTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderInfo<span class="token punctuation">.</span><span class="token function">setFetchAddress</span><span class="token punctuation">(</span>fetchAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
            baseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//排班可预约数</span>
            <span class="token class-name">Integer</span> reservedNumber <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;reservedNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//排班剩余预约数</span>
            <span class="token class-name">Integer</span> availableNumber <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;availableNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//发送mq消息，号源更新和短信通知</span>
            <span class="token class-name">OrderMqVo</span> orderMqVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderMqVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderMqVo<span class="token punctuation">.</span><span class="token function">setScheduleId</span><span class="token punctuation">(</span>scheduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderMqVo<span class="token punctuation">.</span><span class="token function">setReservedNumber</span><span class="token punctuation">(</span>reservedNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderMqVo<span class="token punctuation">.</span><span class="token function">setAvailableNumber</span><span class="token punctuation">(</span>availableNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//短息提示</span>
            <span class="token class-name">MsmVo</span> msmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MsmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msmVo<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getPatientPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> reserveDate <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getReserveDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getReserveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;上午&quot;</span><span class="token operator">:</span> <span class="token string">&quot;下午&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
                <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getHosname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getDepname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;reserveDate&quot;</span><span class="token punctuation">,</span> reserveDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getPatientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;quitTime&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getQuitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            msmVo<span class="token punctuation">.</span><span class="token function">setParam</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderMqVo<span class="token punctuation">.</span><span class="token function">setMsmVo</span><span class="token punctuation">(</span>msmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//发送</span>
            rabbitService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_DIRECT_ORDER</span><span class="token punctuation">,</span><span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">ROUTING_ORDER</span><span class="token punctuation">,</span>orderMqVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br></div></div><ul><li>前端测试访问</li></ul> <ol><li>得到就诊人信息</li> <li>得到排班信息</li> <li>得到相关信息</li> <li>调用医院接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">29.151</span>  <span class="token constant">INFO</span> <span class="token number">7572</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8206</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>frx01<span class="token punctuation">.</span>helper<span class="token punctuation">.</span></span>HttpRequestHelper</span>       <span class="token operator">:</span> <span class="token operator">--</span><span class="token operator">&gt;</span> 应答结果：result data <span class="token punctuation">{</span><span class="token string">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;成功&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;number&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">&quot;fetchAddress&quot;</span><span class="token operator">:</span><span class="token string">&quot;一层114窗口&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;reservedNumber&quot;</span><span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token string">&quot;availableNumber&quot;</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token string">&quot;resultCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;0000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;fetchTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2022-11-1409:00前&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hosRecordId&quot;</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">&quot;resultMsg&quot;</span><span class="token operator">:</span><span class="token string">&quot;预约成功&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">29.437</span>  <span class="token constant">INFO</span> <span class="token number">7572</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>erListUpdater<span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>ChainedDynamicProperty</span>  <span class="token operator">:</span> <span class="token class-name">Flipping</span> property<span class="token operator">:</span> service<span class="token operator">-</span><span class="token class-name"><span class="token namespace">user<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span></span>ActiveConnectionsLimit</span> <span class="token keyword">to</span> <span class="token namespace">use</span> <span class="token constant">NEXT</span> property<span class="token operator">:</span> niws<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>availabilityFilteringRule<span class="token punctuation">.</span>activeConnectionsLimit <span class="token operator">=</span> <span class="token number">2147483647</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">29.593</span>  <span class="token constant">INFO</span> <span class="token number">7572</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>erListUpdater<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>ChainedDynamicProperty</span>  <span class="token operator">:</span> <span class="token class-name">Flipping</span> property<span class="token operator">:</span> service<span class="token operator">-</span><span class="token class-name"><span class="token namespace">hosp<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span></span>ActiveConnectionsLimit</span> <span class="token keyword">to</span> <span class="token namespace">use</span> <span class="token constant">NEXT</span> property<span class="token operator">:</span> niws<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>availabilityFilteringRule<span class="token punctuation">.</span>activeConnectionsLimit <span class="token operator">=</span> <span class="token number">2147483647</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="订单详情功能"><a href="#订单详情功能" class="header-anchor">#</a> 订单详情功能</h2> <h3 id="添加-servcie-接口以及实现类"><a href="#添加-servcie-接口以及实现类" class="header-anchor">#</a> 添加 servcie 接口以及实现类</h3> <ol><li>在OrderInfoService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根据订单的id查询订单详情</span>
    <span class="token class-name">OrderInfo</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在OrderInfoServiceImpl类添加接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根据订单id查询订单详情</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">packOrderInfo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderInfo</span> <span class="token function">packOrderInfo</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span> orderInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderStatusString&quot;</span><span class="token punctuation">,</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token function">getStatusNameByStatus</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="添加-controller-2"><a href="#添加-controller-2" class="header-anchor">#</a> 添加 Controller</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//根据订单的id查询订单详情</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/getOrders/{orderId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getOrders</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>前端测试访问</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221113/image.3sxtal5zwou0.webp" alt="image"></p> <h2 id="订单列表功能"><a href="#订单列表功能" class="header-anchor">#</a> 订单列表功能</h2> <h3 id="添加-service-接口以及实现"><a href="#添加-service-接口以及实现" class="header-anchor">#</a> 添加 service 接口以及实现</h3> <ol><li>在 OrderInfoSerice 接口及实现类</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//订单列表（条件查询带分页）</span>
    <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectPage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">OrderQueryVo</span> orderQueryVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在 OrderInfoServiceImpl 类添加接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//订单列表（条件查询带分页）</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectPage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">OrderQueryVo</span> orderQueryVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//OrderQueryVo获取条件值</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> orderQueryVo<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//医院名称</span>
        <span class="token class-name">String</span> patientName <span class="token operator">=</span> orderQueryVo<span class="token punctuation">.</span><span class="token function">getPatientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//就诊人的名称</span>
        <span class="token class-name">String</span> orderStatus <span class="token operator">=</span> orderQueryVo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//订单的状态</span>
        <span class="token class-name">String</span> reserveDate <span class="token operator">=</span> orderQueryVo<span class="token punctuation">.</span><span class="token function">getReserveDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//安排日期</span>
        <span class="token class-name">String</span> createTimeBegin <span class="token operator">=</span> orderQueryVo<span class="token punctuation">.</span><span class="token function">getCreateTimeBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始时间</span>
        <span class="token class-name">String</span> createTimeEnd <span class="token operator">=</span> orderQueryVo<span class="token punctuation">.</span><span class="token function">getCreateTimeEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//结束时间</span>
        <span class="token comment">//对条件值进行非空的判断</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">&quot;hosname&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>patientName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;patient_name&quot;</span><span class="token punctuation">,</span>patientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>orderStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;order_status&quot;</span><span class="token punctuation">,</span>orderStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>reserveDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token string">&quot;reserce_date&quot;</span><span class="token punctuation">,</span>reserveDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>createTimeBegin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token string">&quot;create_time&quot;</span><span class="token punctuation">,</span>createTimeBegin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>createTimeEnd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token string">&quot;create_time&quot;</span><span class="token punctuation">,</span>createTimeEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//调用mapper的方法</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span>  pages <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span> queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pages<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">packOrderInfo</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pages<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderInfo</span> <span class="token function">packOrderInfo</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span> orderInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderStatusString&quot;</span><span class="token punctuation">,</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token function">getStatusNameByStatus</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="添加-controller-3"><a href="#添加-controller-3" class="header-anchor">#</a> 添加 Controller</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//订单列表（条件查询带分页）</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/{page}/{limit}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> page<span class="token punctuation">,</span>
                       <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> limit<span class="token punctuation">,</span>
                       <span class="token class-name">OrderQueryVo</span> orderQueryVo<span class="token punctuation">,</span>
                       <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//设置当前用户的id值</span>
        orderQueryVo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> pageParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> pageModel <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span>orderQueryVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>pageModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取订单状态</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/getStatusList&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getStatusList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token function">getStatusList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>说明：订单状态我们是封装到枚举中的，页面搜索需要一个下拉列表展示，所以我们通过接口返回页面</p> <ul><li>前端访问测试</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221113/image.3ubxjqw0p840.webp" alt="image"></p> <h2 id="订单支付-生成二维码"><a href="#订单支付-生成二维码" class="header-anchor">#</a> 订单支付（生成二维码）</h2> <h3 id="微信支付介绍"><a href="#微信支付介绍" class="header-anchor">#</a> 微信支付介绍</h3> <h4 id="微信扫码支付申请"><a href="#微信扫码支付申请" class="header-anchor">#</a> 微信扫码支付申请</h4> <p>微信扫码支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。</p> <p>申请步骤：（了解）</p> <p><strong>第一步：注册公众号（类型须为：服务号）</strong></p> <p>请根据营业执照类型选择以下主体注册：<a href="http://kf.qq.com/faq/120911VrYVrA151009JB3i2Q.html" target="_blank" rel="noopener noreferrer">个体工商户<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>| <a href="http://kf.qq.com/faq/120911VrYVrA151013MfYvYV.html" target="_blank" rel="noopener noreferrer">企业/公司<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>| <a href="http://kf.qq.com/faq/161220eaAJjE161220IJn6zU.html" target="_blank" rel="noopener noreferrer">政府<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>| <a href="http://kf.qq.com/faq/161220IFBJFv161220YnqAbQ.html" target="_blank" rel="noopener noreferrer">媒体<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>| <a href="http://kf.qq.com/faq/120911VrYVrA151013nYFZ7Z.html" target="_blank" rel="noopener noreferrer">其他类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><strong>第二步：认证公众号</strong></p> <p>公众号认证后才可申请微信支付，认证费：300元/年。</p> <p><strong>第三步：提交资料申请微信支付</strong></p> <p>登录公众平台，点击左侧菜单【微信支付】，开始填写资料等待审核，审核时间为1-5个工作日内。</p> <p><strong>第四步：开户成功，登录商户平台进行验证</strong></p> <p>资料审核通过后，请登录联系人邮箱查收商户号和密码，并登录商户平台填写财付通备付金打的小额资金数额，完成账户验证。</p> <p><strong>第五步：在线签署协议</strong></p> <p>本协议为线上电子协议，签署后方可进行交易及资金结算，签署完立即生效。</p> <h4 id="开发文档"><a href="#开发文档" class="header-anchor">#</a> 开发文档</h4> <p>微信支付接口调用的整体思路：</p> <p>按API要求组装参数，以XML方式发送（POST）给微信支付接口（URL）,微信支付接口也是以XML方式给予响应。程序根据返回的结果（其中包括支付URL）生成二维码或判断订单状态。</p> <p>在线微信支付开发文档：</p> <p>https://pay.weixin.qq.com/wiki/doc/api/index.html</p> <ol><li>appid：微信公众账号或开放平台APP的唯一标识</li> <li>mch_id：商户号  (配置文件中的partner)</li> <li>partnerkey：商户密钥</li> <li>sign:数字签名, 根据微信官方提供的密钥和一套算法生成的一个加密信息, 就是为了保证交易的安全性</li></ol> <h4 id="微信支付sdk"><a href="#微信支付sdk" class="header-anchor">#</a> 微信支付SDK</h4> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221115/image.775rxz9ipqs0.webp" alt="image"></p> <p>添加依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.wxpay<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>wxpay-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们主要会用到微信支付SDK的以下功能</p> <ol><li>获取随机字符串</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">generateNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>MAP转换为XML字符串（自动添加签名）</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">generateSignedXml</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> partnerkey<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>XML字符串转换为MAP</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">xmlToMap</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="微信支付开发"><a href="#微信支付开发" class="header-anchor">#</a> 微信支付开发</h3> <h4 id="api-接口-3"><a href="#api-接口-3" class="header-anchor">#</a> api 接口</h4> <p>场景：用户扫描商户展示在各种场景的二维码进行支付</p> <p>使用案例：</p> <p>线下：家乐福超市、7-11便利店、上品折扣线下店等</p> <p>线上：大众点评网站、携程网站、唯品会、美丽说网站等</p> <p>开发模式：</p> <p>模式一：商户在后台给你生成二维码，用户打开扫一扫</p> <p>模式二：商户后台系统调用微信支付【<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1" target="_blank" rel="noopener noreferrer">统一下单API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>】生成预付交易，将接口返回的链接生成二维码，用户扫码后输入密码完成支付交易。注意：**该模式的预付单有效期为2小时，**过期后无法支付。</p> <p>微信支付：生成xml发送请求</p> <p>操作模块：service-order</p> <h5 id="引入依赖-5"><a href="#引入依赖-5" class="header-anchor">#</a> 引入依赖</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.wxpay<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>wxpay-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="添加配置-4"><a href="#添加配置-4" class="header-anchor">#</a> 添加配置</h5> <p>在application.properties中添加商户信息</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.91.166</span>
<span class="token key attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
<span class="token key attr-name">spring.redis.database</span><span class="token punctuation">=</span> <span class="token value attr-value">0</span>
<span class="token key attr-name">spring.redis.password</span><span class="token punctuation">=</span><span class="token value attr-value">mima</span>
<span class="token key attr-name">spring.redis.timeout</span><span class="token punctuation">=</span><span class="token value attr-value">1800000</span>
<span class="token key attr-name">spring.redis.lettuce.pool.max-active</span><span class="token punctuation">=</span><span class="token value attr-value">20</span>
<span class="token key attr-name">spring.redis.lettuce.pool.max-wait</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span>
<span class="token comment">#最大阻塞等待时间(负数表示没限制)</span>
<span class="token key attr-name">spring.redis.lettuce.pool.max-idle</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token key attr-name">spring.redis.lettuce.pool.min-idle</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token comment">#关联的公众号appid</span>
<span class="token key attr-name">weixin.pay.appid</span><span class="token punctuation">=</span><span class="token value attr-value">wx74862e0dfcf69954</span>
<span class="token comment">#商户号</span>
<span class="token key attr-name">weixin.pay.partner</span><span class="token punctuation">=</span><span class="token value attr-value">1558950191</span>
<span class="token comment">#商户key</span>
<span class="token key attr-name">weixin.pay.partnerkey</span><span class="token punctuation">=</span><span class="token value attr-value">T6m9iK73b0kn9g5v426MKfHQH7X8rKwb</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h5 id="引入工具类"><a href="#引入工具类" class="header-anchor">#</a> 引入工具类</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConstantPropertiesUtils</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${weixin.appid}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appid<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${weixin.partner}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> partner<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${weixin.partnerkey}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> partnerkey<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">APPID</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">PARTNER</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">PARTNERKEY</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token constant">APPID</span> <span class="token operator">=</span> appid<span class="token punctuation">;</span>
        <span class="token constant">PARTNER</span> <span class="token operator">=</span> partner<span class="token punctuation">;</span>
        <span class="token constant">PARTNERKEY</span> <span class="token operator">=</span> partnerkey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * http请求客户端
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpClient</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> statusCode<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> xmlParam<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> isHttps<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> isCert <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token comment">//证书密码 微信商户号（mch_id）</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> certPassword<span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isHttps<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHttps</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isHttps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isHttps <span class="token operator">=</span> isHttps<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isCert<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCert</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> cert<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isCert <span class="token operator">=</span> cert<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getXmlParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> xmlParam<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setXmlParam</span><span class="token punctuation">(</span><span class="token class-name">String</span> xmlParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>xmlParam <span class="token operator">=</span> xmlParam<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>param <span class="token operator">=</span> param<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCertPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> certPassword<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCertPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> certPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>certPassword <span class="token operator">=</span> certPassword<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      param <span class="token operator">=</span> map<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
         param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      param<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">HttpPost</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setEntity</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">HttpPut</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPut</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setEntity</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">StringBuilder</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">boolean</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> param<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span>
               url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
               url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">HttpGet</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">/**
    * set http post,put param
    */</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token class-name">HttpEntityEnclosingRequestBase</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NameValuePair</span><span class="token punctuation">&gt;</span></span> nvps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NameValuePair</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> param<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            nvps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicNameValuePair</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 参数</span>
         http<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UrlEncodedFormEntity</span><span class="token punctuation">(</span>nvps<span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置参数</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xmlParam <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         http<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>xmlParam<span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">HttpUriRequest</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span>
         <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>isHttps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>isCert<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">//TODO 需要完善</span>
               <span class="token class-name">FileInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">KeyStore</span> keystore <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;PKCS12&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> partnerId2charArray <span class="token operator">=</span> certPassword<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               keystore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> partnerId2charArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token class-name">SSLContexts</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadKeyMaterial</span><span class="token punctuation">(</span>keystore<span class="token punctuation">,</span> partnerId2charArray<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">SSLConnectionSocketFactory</span> sslsf <span class="token operator">=</span>
                     <span class="token keyword">new</span> <span class="token class-name">SSLConnectionSocketFactory</span><span class="token punctuation">(</span>sslContext<span class="token punctuation">,</span>
                           <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;TLSv1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                           <span class="token keyword">null</span><span class="token punctuation">,</span>
                           <span class="token class-name">SSLConnectionSocketFactory</span><span class="token punctuation">.</span><span class="token constant">BROWSER_COMPATIBLE_HOSTNAME_VERIFIER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSSLSocketFactory</span><span class="token punctuation">(</span>sslsf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSLContextBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">loadTrustMaterial</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrustStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 信任所有</span>
                        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chain<span class="token punctuation">,</span>
                                           <span class="token class-name">String</span> authType<span class="token punctuation">)</span>
                              <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">{</span>
                           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">SSLConnectionSocketFactory</span> sslsf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSLConnectionSocketFactory</span><span class="token punctuation">(</span>
                     sslContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
               httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSSLSocketFactory</span><span class="token punctuation">(</span>sslsf<span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">createDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                  statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 响应内容</span>
               content <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         httpClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> statusCode<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> content<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br></div></div><h4 id="添加交易记录接口"><a href="#添加交易记录接口" class="header-anchor">#</a> 添加交易记录接口</h4> <h5 id="添加-mapper-2"><a href="#添加-mapper-2" class="header-anchor">#</a> 添加 Mapper</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="添加service接口与实现"><a href="#添加service接口与实现" class="header-anchor">#</a> 添加service接口与实现</h5> <ol><li>添加PaymentService 类</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//向支付记录表添加信息</span>
    <span class="token keyword">void</span> <span class="token function">savePaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span> orderInfo<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>添加PaymentServiceImpl实现类</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentMapper</span><span class="token punctuation">,</span> <span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">PaymentService</span> <span class="token punctuation">{</span>
    <span class="token comment">//向支付记录表添加信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">savePaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span> orderInfo<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据订单id和支付类型，查询支付记录表里面是否存在相同的订单</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;payment_type&quot;</span><span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//添加记录</span>
        <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentStatus</span><span class="token punctuation">(</span><span class="token class-name">PaymentStatusEnum</span><span class="token punctuation">.</span><span class="token constant">UNPAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getReserveDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHosname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getDepname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="添加支付service接口与实现"><a href="#添加支付service接口与实现" class="header-anchor">#</a> 添加支付service接口与实现</h4> <ol><li>添加com.frx01.yygh.order.service.WeixinService类</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WeiXinService</span> <span class="token punctuation">{</span>
    <span class="token comment">//生成微信支付扫描的二维码</span>
    <span class="token class-name">Map</span> <span class="token function">createNative</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>添加com.frx01.yygh.order.service.impl.WeixinServiceImpl类</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeiXinServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WeiXinService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentService</span> paymentService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token comment">//生成微信支付扫描的二维码</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">createNative</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.根据orderId获取订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.向支付记录表添加信息</span>
        paymentService<span class="token punctuation">.</span><span class="token function">savePaymentInfo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">,</span> <span class="token class-name">PaymentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">WEIXIN</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//从redis获取数据</span>
            <span class="token class-name">Map</span> payMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>orderId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>payMap<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> payMap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//3.设置参数，调用微信生成二维码的接口</span>
            <span class="token comment">//把参数转换成xml格式，使用商户key进行加密</span>
            <span class="token class-name">Map</span> paramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;appid&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">APPID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mch_id&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">PARTNER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nonce_str&quot;</span><span class="token punctuation">,</span> <span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">generateNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> body <span class="token operator">=</span> orderInfo<span class="token punctuation">.</span><span class="token function">getReserveDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;就诊&quot;</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span><span class="token function">getDepname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//paramMap.put(&quot;total_fee&quot;, order.getAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total_fee&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;spbill_create_ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://guli.shop/api/order/weixinPay/weixinNotify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;trade_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NATIVE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.调用微信生成二维码的接口</span>
            <span class="token class-name">HttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.mch.weixin.qq.com/pay/unifiedorder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置map参数</span>
            client<span class="token punctuation">.</span><span class="token function">setXmlParam</span><span class="token punctuation">(</span><span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">generateSignedXml</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">,</span> <span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">PARTNERKEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">setHttps</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5.返回相关的数据</span>
            <span class="token class-name">String</span> xml <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//转换成map集合</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">xmlToMap</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;resultMap=:&quot;</span> <span class="token operator">+</span> resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//6.封装返回结果集</span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalFee&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;resultCode&quot;</span><span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;result_code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;codeUrl&quot;</span><span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code_url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//二维码地址</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;result_code&quot;</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orderId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>map<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h4 id="添加-controller-方法-3"><a href="#添加-controller-方法-3" class="header-anchor">#</a> 添加 Controller 方法</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;微信支付接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/order/weixin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeiXinController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WeiXinService</span> weiXinService<span class="token punctuation">;</span>
    <span class="token comment">//生成微信支付扫描的二维码</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/createNative/{orderId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createNative</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> weiXinService<span class="token punctuation">.</span><span class="token function">createNative</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>前端支付测试</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221115/image.29zrqdawt91c.webp" alt="image"></p> <h3 id="处理支付结果"><a href="#处理支付结果" class="header-anchor">#</a> 处理支付结果</h3> <h4 id="添加-service-接口以及实现-2"><a href="#添加-service-接口以及实现-2" class="header-anchor">#</a> 添加 service 接口以及实现</h4> <ol><li>在PaymentService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//更新订单状态</span>
    <span class="token keyword">void</span> <span class="token function">paySucess</span><span class="token punctuation">(</span><span class="token class-name">String</span> out_trade_no<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在PaymentServiceImpl类添加实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//更新订单状态</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paySucess</span><span class="token punctuation">(</span><span class="token class-name">String</span> out_trade_no<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.根据订单编号得到支付记录</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;payment_type&quot;</span><span class="token punctuation">,</span> <span class="token class-name">PaymentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">WEIXIN</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.更新支付记录信息</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentStatus</span><span class="token punctuation">(</span><span class="token class-name">PaymentStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setCallbackTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setTradeNo</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;transaction_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setCallbackContent</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.根据订单号得到订单信息</span>
        <span class="token comment">//4.更新订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.调用医院接口，更新订单支付信息</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="更新医院支付状态"><a href="#更新医院支付状态" class="header-anchor">#</a> 更新医院支付状态</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//5.调用医院接口，更新订单支付信息</span>
        <span class="token class-name">SignInfoVo</span> signInfoVo <span class="token operator">=</span> hospitalFeignClient<span class="token punctuation">.</span><span class="token function">getSignInfoVo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> reqMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hosRecordId&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHosRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span>reqMap<span class="token punctuation">,</span> signInfoVo<span class="token punctuation">.</span><span class="token function">getSignKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sign&quot;</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> result
                <span class="token operator">=</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>reqMap<span class="token punctuation">,</span> signInfoVo<span class="token punctuation">.</span><span class="token function">getApiUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/order/updatePayStatus&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>前端访问测试
<ul><li>查看控制台</li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>支付状态resultMap<span class="token operator">:</span><span class="token punctuation">{</span>transaction_id<span class="token operator">=</span><span class="token number">4200001670202211168362613899</span><span class="token punctuation">,</span> nonce_str<span class="token operator">=</span>mDMDU1ap2Lqlg9QR<span class="token punctuation">,</span> trade_state<span class="token operator">=</span><span class="token constant">SUCCESS</span><span class="token punctuation">,</span> bank_type<span class="token operator">=</span><span class="token constant">OTHERS</span><span class="token punctuation">,</span> openid<span class="token operator">=</span>oHwsHuL_t99<span class="token operator">-</span>ri2ZsWbBVi4CNGXI<span class="token punctuation">,</span> sign<span class="token operator">=</span><span class="token number">6</span><span class="token constant">BB001DF5E713892D5D5142615D56718</span><span class="token punctuation">,</span> return_msg<span class="token operator">=</span><span class="token constant">OK</span><span class="token punctuation">,</span> fee_type<span class="token operator">=</span><span class="token constant">CNY</span><span class="token punctuation">,</span> mch_id<span class="token operator">=</span><span class="token number">1558950191</span><span class="token punctuation">,</span> cash_fee<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> out_trade_no<span class="token operator">=</span><span class="token number">16685284490991</span><span class="token punctuation">,</span> cash_fee_type<span class="token operator">=</span><span class="token constant">CNY</span><span class="token punctuation">,</span> appid<span class="token operator">=</span>wx74862e0dfcf69954<span class="token punctuation">,</span> total_fee<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> trade_state_desc<span class="token operator">=</span>支付成功<span class="token punctuation">,</span> trade_type<span class="token operator">=</span><span class="token constant">NATIVE</span><span class="token punctuation">,</span> result_code<span class="token operator">=</span><span class="token constant">SUCCESS</span><span class="token punctuation">,</span> attach<span class="token operator">=</span><span class="token punctuation">,</span> time_end<span class="token operator">=</span><span class="token number">20221116000748</span><span class="token punctuation">,</span> is_subscribe<span class="token operator">=</span><span class="token class-name">N</span><span class="token punctuation">,</span> return_code<span class="token operator">=</span><span class="token constant">SUCCESS</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>查看数据库</li></ul> <p><img src="https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20221116/image.75ob63plui80.webp" alt="image"></p> <h2 id="取消预约"><a href="#取消预约" class="header-anchor">#</a> 取消预约</h2> <h3 id="需求描述"><a href="#需求描述" class="header-anchor">#</a> 需求描述</h3> <p>取消订单分两种情况：</p> <ol><li>未支付取消订单，直接通知医院更新取消预约状态</li> <li>已支付取消订单，先退款给用户，然后通知医院更新取消预约状态</li></ol> <h3 id="开发微信退款接口"><a href="#开发微信退款接口" class="header-anchor">#</a> 开发微信退款接口</h3> <ul><li><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_4" target="_blank" rel="noopener noreferrer">参考文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>该接口需要使用证书，详情参考文档并下载证书</p> <h4 id="配置证书"><a href="#配置证书" class="header-anchor">#</a> 配置证书</h4> <p>请下载的证书放在service-order模块/resources/cert文件夹下</p> <p>在application.properties文件配置证书路径</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#退款证书</span>
<span class="token key attr-name">weixin.cert</span><span class="token punctuation">=</span><span class="token value attr-value">cert/apiclient_cert.p12</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="添加获取支付记录接口"><a href="#添加获取支付记录接口" class="header-anchor">#</a> 添加获取支付记录接口</h4> <p>退款我们是根据支付记录发起退款的</p> <ol><li>在PaymentService类添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获取支付记录</span>
    <span class="token class-name">PaymentInfo</span> <span class="token function">getPaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">,</span><span class="token class-name">Integer</span> paymentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在PaymentServiceImpl类添加实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获取支付记录</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PaymentInfo</span> <span class="token function">getPaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> paymentType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;payment_type&quot;</span><span class="token punctuation">,</span>paymentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> paymentInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="添加退款记录"><a href="#添加退款记录" class="header-anchor">#</a> 添加退款记录</h4> <h5 id="添加-mapper-3"><a href="#添加-mapper-3" class="header-anchor">#</a> 添加 mapper</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RefundInfoMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="添加service接口与实现-2"><a href="#添加service接口与实现-2" class="header-anchor">#</a> 添加service接口与实现</h5> <ol><li>添加service接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RefundInfoService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//保存退款记录</span>
    <span class="token class-name">RefundInfo</span> <span class="token function">saveRefundInfo</span><span class="token punctuation">(</span><span class="token class-name">PaymentInfo</span> paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>添加service接口实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefundInfoServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfoMapper</span><span class="token punctuation">,</span> <span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">RefundInfoService</span> <span class="token punctuation">{</span>
    <span class="token comment">//保存退款记录</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RefundInfo</span> <span class="token function">saveRefundInfo</span><span class="token punctuation">(</span><span class="token class-name">PaymentInfo</span> paymentInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断是否有重复数据添加</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;payment_type&quot;</span><span class="token punctuation">,</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getPaymentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RefundInfo</span> refundInfo <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>refundInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//有相同数据</span>
            <span class="token keyword">return</span> refundInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//添加记录</span>
        refundInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefundInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getPaymentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">UNREFUND</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//paymentInfo.setSubject(&quot;test&quot;);</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>refundInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> refundInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="添加微信退款接口"><a href="#添加微信退款接口" class="header-anchor">#</a> 添加微信退款接口</h4> <ol><li>在WeixinService添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//退款</span>
    <span class="token class-name">Boolean</span> <span class="token function">refund</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在WeixinServiceImpl添加实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//微信退款</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">refund</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取支付记录相关信息</span>
            <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> paymentService<span class="token punctuation">.</span><span class="token function">getPaymentInfo</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> <span class="token class-name">PaymentTypeEnum</span><span class="token punctuation">.</span><span class="token constant">WEIXIN</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//添加信息到退款记录表</span>
            <span class="token class-name">RefundInfo</span> refundInfo <span class="token operator">=</span> refundInfoService<span class="token punctuation">.</span><span class="token function">saveRefundInfo</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//判断当前订单数据是否已经退款</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>refundInfo<span class="token punctuation">.</span><span class="token function">getRefundStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">REFUND</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//调用微信接口实现退款</span>
            <span class="token comment">//封装需要参数</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;appid&quot;</span><span class="token punctuation">,</span><span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">APPID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//公众账号ID</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mch_id&quot;</span><span class="token punctuation">,</span><span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">PARTNER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//商户编号</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nonce_str&quot;</span><span class="token punctuation">,</span><span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">generateNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;transaction_id&quot;</span><span class="token punctuation">,</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//微信订单号</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//商户订单编号</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_refund_no&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tk&quot;</span><span class="token operator">+</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//商户退款单号</span>
            <span class="token comment">//paramMap.put(&quot;total_fee&quot;,paymentInfoQuery.getTotalAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span>
            <span class="token comment">//paramMap.put(&quot;refund_fee&quot;,paymentInfoQuery.getTotalAmount().multiply(new BigDecimal(&quot;100&quot;)).longValue()+&quot;&quot;);</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total_fee&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;refund_fee&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> paramXml <span class="token operator">=</span> <span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">generateSignedXml</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">,</span><span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">PARTNERKEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置调用接口内容</span>
            <span class="token class-name">HttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.mch.weixin.qq.com/secapi/pay/refund&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">setXmlParam</span><span class="token punctuation">(</span>paramXml<span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">setHttps</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置证书的信息</span>
            client<span class="token punctuation">.</span><span class="token function">setCert</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">setCertPassword</span><span class="token punctuation">(</span><span class="token class-name">ConstantPropertiesUtils</span><span class="token punctuation">.</span><span class="token constant">PARTNER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//接受返回数据</span>
            <span class="token class-name">String</span> xml <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">xmlToMap</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> resultMap <span class="token operator">&amp;&amp;</span> <span class="token class-name">WXPayConstants</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;result_code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                refundInfo<span class="token punctuation">.</span><span class="token function">setCallbackTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                refundInfo<span class="token punctuation">.</span><span class="token function">setTradeNo</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;refund_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                refundInfo<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">REFUND</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                refundInfo<span class="token punctuation">.</span><span class="token function">setCallbackContent</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                refundInfoService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>refundInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h4 id="完成取消预约"><a href="#完成取消预约" class="header-anchor">#</a> 完成取消预约</h4> <h5 id="添加service接口与实现-3"><a href="#添加service接口与实现-3" class="header-anchor">#</a> 添加service接口与实现</h5> <ol><li>在OrderService添加接口</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//取消预约</span>
    <span class="token keyword">boolean</span> <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>在OrderServiceImpl添加实现</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//取消预约</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//先获取订单的信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否可以取消</span>
        <span class="token class-name">DateTime</span> quitTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getQuitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>quitTime<span class="token punctuation">.</span><span class="token function">isBeforeNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">CANCEL_ORDER_NO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//调用医院接口实现预约取消</span>
        <span class="token class-name">SignInfoVo</span> signInfoVo <span class="token operator">=</span> hospitalFeignClient<span class="token punctuation">.</span><span class="token function">getSignInfoVo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> signInfoVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> reqMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hoscode&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHoscode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hosRecordId&quot;</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">.</span><span class="token function">getHosRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span>reqMap<span class="token punctuation">,</span> signInfoVo<span class="token punctuation">.</span><span class="token function">getSignKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sign&quot;</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> result <span class="token operator">=</span> <span class="token class-name">HttpRequestHelper</span><span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>reqMap<span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:9998/order/updateCancelStatus&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//根据医院接口返回的数据</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//判断当前的订单是否可以取消</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Boolean</span> isRefund <span class="token operator">=</span> weiXinService<span class="token punctuation">.</span><span class="token function">refund</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isRefund<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">YyghException</span><span class="token punctuation">(</span><span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">CANCEL_ORDER_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//更新订单的状态</span>
                orderInfo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLE</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                baseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//发送mq更新预约数量</span>
                <span class="token class-name">OrderMqVo</span> orderMqVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderMqVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderMqVo<span class="token punctuation">.</span><span class="token function">setScheduleId</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getScheduleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//短信提示</span>
                <span class="token class-name">MsmVo</span> msmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MsmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msmVo<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getPatientPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msmVo<span class="token punctuation">.</span><span class="token function">setTemplateCode</span><span class="token punctuation">(</span><span class="token string">&quot;SMS_194640722&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> reserveDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getReserveDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getReserveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;上午&quot;</span><span class="token operator">:</span> <span class="token string">&quot;下午&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
                    <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getHosname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getDepname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span>orderInfo<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;reserveDate&quot;</span><span class="token punctuation">,</span> reserveDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getPatientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                msmVo<span class="token punctuation">.</span><span class="token function">setParam</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderMqVo<span class="token punctuation">.</span><span class="token function">setMsmVo</span><span class="token punctuation">(</span>msmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rabbitService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_DIRECT_ORDER</span><span class="token punctuation">,</span> <span class="token class-name">MqConst</span><span class="token punctuation">.</span><span class="token constant">ROUTING_ORDER</span><span class="token punctuation">,</span> orderMqVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h5 id="添加-controller-方法-4"><a href="#添加-controller-方法-4" class="header-anchor">#</a> 添加 Controller 方法</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//取消预约</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/cancelOrder/{orderId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> isOrder <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">cancelOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/xustudyxu/xustudyxu.github.io/edit/master/docs/baodian/high/SYT/SYT_yygh.md" target="_blank" rel="noopener noreferrer">帮助我改善此页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=%E4%B8%AD%E9%AB%98%E8%BF%9B%E9%98%B6%E7%AF%87" title="标签">#中高进阶篇</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025年5月18日</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/high/SYT/SYT_SYT_ali_oos/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">尚医通- 阿里云OSS、用户认证与就诊人</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/high/SYT/SYT_SYT_ali_oos/" class="prev">尚医通- 阿里云OSS、用户认证与就诊人</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/c538d4/"><div>
            结构型模式
            <!----></div></a> <span class="date">03-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/9f3d5d/"><div>
            创建者模式
            <!----></div></a> <span class="date">01-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/57297b/"><div>
            设计模式入门
            <!----></div></a> <span class="date">12-30</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1812903531@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xustudyxu" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://frxcat.fun/img/wx.png" title="微信" target="_blank" class="iconfont icon-weixin"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2025
    <span>xustudyxu |<a href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022008983号</a><br>	<img src="http://www.beian.gov.cn/img/new/gongan.png" border="0" /></a>	 		<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41018302000331" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px;">豫公网安备 41018302000331号</p></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><div></div><div id="tcomment"></div><!----></div></div>
    <script src="/assets/js/app.4955f045.js" defer></script><script src="/assets/js/3.d7147f30.js" defer></script><script src="/assets/js/2.06384a8f.js" defer></script><script src="/assets/js/66.bde30c80.js" defer></script><script src="/assets/js/21.56563fe6.js" defer></script><script src="/assets/js/44.b2c4405b.js" defer></script><script src="/assets/js/26.0926361f.js" defer></script><script src="/assets/js/27.983951e8.js" defer></script>
  </body>
</html>
