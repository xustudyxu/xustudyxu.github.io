(window.webpackJsonp=window.webpackJsonp||[]).push([[277],{626:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis-主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-主从复制"}},[s._v("#")]),s._v(" Redis 主从复制")]),s._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#概念"}},[s._v("概念")])]),t("li",[t("a",{attrs:{href:"#搭建一主多从"}},[s._v("搭建一主多从")])]),t("li",[t("a",{attrs:{href:"#配置三类"}},[s._v("配置三类")]),t("ul",[t("li",[t("a",{attrs:{href:"#一主二仆"}},[s._v("一主二仆")])]),t("li",[t("a",{attrs:{href:"#薪火相传"}},[s._v("薪火相传")])]),t("li",[t("a",{attrs:{href:"#反客为主"}},[s._v("反客为主")])]),t("li",[t("a",{attrs:{href:"#复制原理"}},[s._v("复制原理")])])])]),t("li",[t("a",{attrs:{href:"#哨兵模式"}},[s._v("哨兵模式")]),t("ul",[t("li",[t("a",{attrs:{href:"#什么是哨兵模式"}},[s._v("什么是哨兵模式")])]),t("li",[t("a",{attrs:{href:"#配置测试"}},[s._v("配置测试")])]),t("li",[t("a",{attrs:{href:"#java整合"}},[s._v("Java整合")])])])])])]),t("p"),s._v(" "),t("h2",{attrs:{id:"概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.4mf4xesn8lw.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("主从复制，是指将一台 Redis 服务器的数据，复制到其他的 Redis 服务器。前者称为主节点 (master/leader)，后者称为从节点(slave/follower)；数据的复制是单向的，只能由主节点到从节点。"),t("strong",[s._v("Master 以写为主，Slave 以读为主")]),s._v("。")]),s._v(" "),t("p",[s._v("默认情况下，每台 Redis 服务器都是主节点；且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。")]),s._v(" "),t("p",[s._v("主从复制的作用主要包括：")]),s._v(" "),t("ul",[t("li",[s._v("数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式")]),s._v(" "),t("li",[s._v("故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余")]),s._v(" "),t("li",[s._v("负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务 （即写 Redis 数据时应用连接主节点，读 Redis 数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量")]),s._v(" "),t("li",[s._v("高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是 Redis 高可用的基础")])]),s._v(" "),t("p",[s._v("一般来说，要将 Redis 运用于工程项目中，只使用一台 Redis 是万万不能的，原因如下：")]),s._v(" "),t("ul",[t("li",[s._v("从结构上，单个 Redis 服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；")]),s._v(" "),t("li",[s._v("从容量上，单个 Redis 服务器内存容量有限，就算一台 Redis 服务器内存容量为 256G，也不能将所有内存用作 Redis 存储内存，一般来说，单台 Redis 最大使用内存不应该超过 20G。")])]),s._v(" "),t("p",[s._v("电商网站上的商品，一般都是一次上传，无数次浏览的，说专业点也就是「多读少写」。")]),s._v(" "),t("p",[s._v("对于这种场景，我们可以使如下这种架构：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.1gitjgqit1eo.webp",alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"搭建一主多从"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建一主多从"}},[s._v("#")]),s._v(" 搭建一主多从")]),s._v(" "),t("p",[s._v("查看当前库的信息："),t("code",[s._v("info replication")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info replication\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 角色")]),s._v("\nconnected_slaves:0     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从机数量")]),s._v("\nmaster_failover_state:no-failover\nmaster_replid:5ea47aa7d0e765ce2c5d242df2c85070675dd296\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:0\nsecond_repl_offset:-1\nrepl_backlog_active:0\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:0\nrepl_backlog_histlen:0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("因为没有多个服务器，就以本地开启 3 个端口，模拟 3 个服务")]),s._v(" "),t("p",[s._v("既然需要启动多个服务，就需要多个配置文件。每个配置文件对应修改以下信息：")]),s._v(" "),t("ul",[t("li",[s._v("端口号（port）")]),s._v(" "),t("li",[s._v("pid文件名（pidfile）")]),s._v(" "),t("li",[s._v("日志文件名（logfile）")]),s._v(" "),t("li",[s._v("rdb文件名（dbfilename）")])]),s._v(" "),t("ol",[t("li",[s._v("创建目录")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /myredis\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("复制redis.conf配置文件到文件夹中")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/redis.conf /myredis/redis.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("配置一主两从，创建三个配置文件\n"),t("ol",[t("li",[s._v("redis6379.conf")]),s._v(" "),t("li",[s._v("redis6380.conf")]),s._v(" "),t("li",[s._v("redis6381.conf")])])])]),s._v(" "),t("ul",[t("li",[s._v("关闭appendonly")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.41b7mn7ovcm0.webp",alt:"image"}})]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" redis6379.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("写入以下内容")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("include /myredis/redis.conf\npidfile /var/run/redis_6379.pid\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\ndbfilename dump6379.rdb\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("blockquote",[t("p",[s._v("其他两个端口为6380,6381，其他不变")])]),s._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[s._v("配置好分别启动 3 个不同端口服务")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master myredis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server redis6379.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master myredis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server redis6380.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master myredis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-server redis6381.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master myredis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep redis")]),s._v("\nroot       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3103")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":30 ?        00:00:04 redis-server *:6379\nroot       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3825")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":28 ?        00:00:00 redis-server *:6380\nroot       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3831")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":29 ?        00:00:00 redis-server *:6381\nroot       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3845")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3272")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":29 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto redis\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ol",{attrs:{start:"5"}},[t("li",[s._v("查看三台主机运行情况,分别执行")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\nredis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\nredis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.3tg125lyubm0.webp",alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"配置三类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置三类"}},[s._v("#")]),s._v(" 配置三类")]),s._v(" "),t("h3",{attrs:{id:"一主二仆"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一主二仆"}},[s._v("#")]),s._v(" 一主二仆")]),s._v(" "),t("p",[s._v("可以发现，默认情况下，开启的每个 Redis 服务器都是主节点")]),s._v(" "),t("ul",[t("li",[s._v("配置为一个 Master 和 两个 Slave（即一主二仆）")])]),s._v(" "),t("p",[s._v("6379 为主，6380、6381 为从，分别在 6380、6381 的 Redis 上执行如下指令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("slaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.2nd28pe2kdw0.webp",alt:"image"}})]),s._v(" "),t("ul",[t("li",[s._v("在主机设置值，在从机都可以取到，但是从机不能写值")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.5ckyr14k44s0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("我们这里是使用命令搭建，是「暂时的」，如果重启三个 Redis 服务，则又恢复到三主的地位")]),s._v(" "),t("p",[s._v("如果想配置「永久的」，则去配置里进行修改，找到 "),t("code",[s._v("slaveof <ip> <port>")]),s._v(" 指令进行配置：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.4tcrhaywr380.webp",alt:"image"}})]),s._v(" "),t("blockquote",[t("p",[s._v("使用规则")])]),s._v(" "),t("p",[s._v("当主机断电宕机后，默认情况下从机的角色不会发生变化，集群中只是失去了写操作，当主机恢复以后，又会连接上从机恢复原状。")]),s._v(" "),t("p",[s._v("当从机断电宕机后，若不是使用配置文件配置的从机，再次启动后作为主机是无法获取之前主机的数据的，若此时重新配置称为从机，又可以获取到主机的所有数据。这里就要提到一个同步原理。")]),s._v(" "),t("p",[s._v("有两种方式可以产生新的主机：看下文「反客为主」")]),s._v(" "),t("h3",{attrs:{id:"薪火相传"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#薪火相传"}},[s._v("#")]),s._v(" 薪火相传")]),s._v(" "),t("p",[s._v("上一个 Slave 可以是下一个 Slave 和 Master，Slave 同样可以接收其他 Slaves 的连接和同步请求，那么该 Slave 作为了链条中下一个的 Master，可以有效减轻 Master 的写压力，去中心化降低风险。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.73an9sywqrs0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("在一个从机用 "),t("code",[s._v("slaveof <ip> <port>")]),s._v(" 指令连接另一个从机")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.3c8aowrzbpm0.webp",alt:"image"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.4amz2iybjkk0.webp",alt:"image"}})]),s._v(" "),t("h3",{attrs:{id:"反客为主"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#反客为主"}},[s._v("#")]),s._v(" 反客为主")]),s._v(" "),t("p",[s._v("当一个 master 宕机后，后面的 slave 可以立刻升为 master，其后面的 slave 不用做任何修改。")]),s._v(" "),t("p",[s._v("有两种方式可以产生新的主机：")]),s._v(" "),t("ul",[t("li",[s._v("从机手动执行命令 "),t("code",[s._v("slaveof no one")]),s._v("，这样执行以后从机会独立出来成为一个主机")]),s._v(" "),t("li",[s._v("使用哨兵模式（自动选举）")])]),s._v(" "),t("h3",{attrs:{id:"复制原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#复制原理"}},[s._v("#")]),s._v(" 复制原理")]),s._v(" "),t("ul",[t("li",[s._v("Slave 启动成功连接到 Master 后会发送一个 sync 命令")]),s._v(" "),t("li",[s._v("Master 接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，Master 将传送整个数据文件到 Slave，并完成一次完全同步")]),s._v(" "),t("li",[s._v("全量复制：而 Slave 服务在接收到数据库文件数据后，将其存盘并加载到内存中")]),s._v(" "),t("li",[s._v("增量复制：Master 继续将新的所有收集到的修改命令依次传给 Slave，完成同步")]),s._v(" "),t("li",[s._v("但是只要是重新连接 Master，一次完全同步（全量复制）将被自动执行")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.5eivho3kll00.webp",alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"哨兵模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵模式"}},[s._v("#")]),s._v(" 哨兵模式")]),s._v(" "),t("h3",{attrs:{id:"什么是哨兵模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是哨兵模式"}},[s._v("#")]),s._v(" 什么是哨兵模式")]),s._v(" "),t("p",[s._v("主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。Redis 从 2.8 开始正式提供了 Sentinel（哨兵）架构来解决这个问题。")]),s._v(" "),t("p",[t("strong",[s._v("反客为主的自动版")]),s._v("，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。")]),s._v(" "),t("p",[s._v("哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是 "),t("strong",[s._v("哨兵通过发送命令，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.4drtau9vige0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("这里的哨兵有两个作用：")]),s._v(" "),t("ul",[t("li",[s._v("通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器")]),s._v(" "),t("li",[s._v("当哨兵监测到 Master 宕机，会自动将 Slave 切换成 Master，然后通过 "),t("strong",[s._v("发布订阅模式")]),s._v(" 通知其他的从服务器，修改配置文件，让它们切换主机")])]),s._v(" "),t("p",[s._v("然而一个哨兵进程对 Redis 服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.3lsffl4hg0e0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("假设主服务器宕机，哨兵 1 先检测到这个结果，系统并不会马上进行 failover 过程，仅仅是哨兵 1 主观的认为主服务器不可用，这个现象成为 "),t("strong",[s._v("主观下线")]),s._v("。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 failover [故障转移]操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为 "),t("strong",[s._v("客观下线")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"配置测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置测试"}},[s._v("#")]),s._v(" 配置测试")]),s._v(" "),t("ul",[t("li",[s._v("调整结构，6379 带着 80、81")]),s._v(" "),t("li",[s._v("自定义的 /myredis 目录下新建 sentinel.conf 文件，名字千万不要错")]),s._v(" "),t("li",[s._v("配置哨兵，填写内容\n"),t("ul",[t("li",[t("code",[s._v("sentinel monitor 被监控主机名字 127.0.0.1 6379 1")])])])])]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("sentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("上面最后一个数字 1，表示主机挂掉后 Slave 投票看让谁接替成为主机，得票数多少后成为主机，这里的例子是 1 票。")]),s._v(" "),t("ul",[t("li",[s._v("启动哨兵")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-sentinel myredis/sentinel.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("上述目录依照各自的实际情况配置，可能目录不同")]),s._v(" "),t("p",[s._v("成功启动哨兵模式：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.3dhl97lren60.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("此时哨兵监视着我们的主机 6379，当我们断开主机后：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting@master/20220619/image.6p02ncej3ao0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("哪个从机会被选举为主机呢？根据优先级别："),t("code",[s._v("slave-priority")]),s._v("，这个指令需要去每个从机的配置文件进行配置，默认都是 100。")]),s._v(" "),t("p",[s._v("建议每个从机都配置不同的 "),t("code",[s._v("slave-priority")]),s._v("，这样可以避免复制延时。")]),s._v(" "),t("p",[t("strong",[s._v("值越小优先级越高。")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("复制延时")])])]),s._v(" "),t("p",[s._v("由于所有的写操作都是先在 Master 上操作，然后同步更新到 Slave 上，所以从 Master 同步到 Slave 机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave 机器数量的增加也会使这个问题更加严重。")]),s._v(" "),t("blockquote",[t("p",[s._v("哨兵模式的优缺点")])]),s._v(" "),t("p",[s._v("优点：")]),s._v(" "),t("ol",[t("li",[s._v("哨兵集群，基于主从复制模式，所有主从复制的优点，它都有")]),s._v(" "),t("li",[s._v("主从可以切换，故障可以转移，系统的可用性更好")]),s._v(" "),t("li",[s._v("哨兵模式是主从模式的升级，手动到自动，更加健壮")])]),s._v(" "),t("p",[s._v("缺点：")]),s._v(" "),t("ol",[t("li",[s._v("Redis不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦")]),s._v(" "),t("li",[s._v("实现哨兵模式的配置其实是很麻烦的，里面有很多配置项")])]),s._v(" "),t("blockquote",[t("p",[s._v("哨兵模式的全部配置")])]),s._v(" "),t("p",[s._v("完整的哨兵模式配置文件 sentinel.conf")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Example sentinel.conf")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵 sentinel 实例运行的端口 默认 26379")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵 sentinel 的工作目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /tmp\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵 sentinel 监控的 redis 主节点的 ip port ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# master-name：可以自己命名的主节点名字 只能由字母 A-z、数字 0-9 、这三个字符 ".-_" 组成。')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# quorum：当这些 quorum 个数 sentinel 哨兵认为 Master 主节点失联 那么这时客观上认为主节点失联了")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel monitor <master-name> <ip> <redis-port> <quorum>")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当在 Redis 实例中开启了 requirepass foobared 授权密码 这样所有连接 Redis 实例的客户端都要提供密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置哨兵 sentinel 连接主从的密码 注意必须为主从设置一样的验证密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel auth-pass <master-name> <password>")]),s._v("\nsentinel auth-pass mymaster MySUPER--secret-0123passw0rd\n \n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定多少毫秒之后 主节点没有应答哨兵 sentinel 此时 哨兵主观上认为主节点下线 默认 30 秒")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel down-after-milliseconds <master-name> <milliseconds>")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个配置项指定了在发生 failover 主备切换时最多可以有多少个 Slave 同时对新的 Master 进行同步，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个数字越小，完成 failover 所需的时间就越长，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 但是如果这个数字越大，就意味着越 多的 Slave 因为 replication 而不可用。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以通过将这个值设为 1 来保证每次只有一个 Slave 处于不能处理命令请求的状态。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel parallel-syncs <master-name> <numslaves>")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n \n\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 故障转移的超时时间 failover-timeout 可以用在以下这些方面： ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1. 同一个 sentinel 对同一个 Master 两次 failover 之间的间隔时间。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2. 当一个 Slave 从一个错误的 Master 那里同步数据开始计算时间。直到 Slave 被纠正为向正确的 Master 那里同步数据时。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#3. 当想要取消一个正在进行的 failover 所需要的时间。  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#4. 当进行 failover 时，配置所有 Slaves 指向新的 Master 所需的最大时间。不过，即使过了这个超时，Slaves 依然会被正确配置为指向Master，但是就不按 parallel-syncs 所配置的规则来了")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认三分钟")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel failover-timeout <master-name> <milliseconds>")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SCRIPTS EXECUTION")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对于脚本的运行结果有以下规则：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 若脚本执行后返回 1，那么该脚本稍后将会被再次执行，重复次数目前默认为 10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 若脚本执行后返回 2，或者比 2 更高的一个返回值，脚本将不会重复执行。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为 1 时的行为相同。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个脚本的最大执行时间为 60s，如果超过这个时间，脚本将会被一个 SIGKILL 信号终止，之后重新执行。")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通知型脚本:当 sentinel 有任何警告级别的事件发生时（比如说 Redis 实例的主观失效和客观失效等等），将会去调用这个脚本，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这时这个脚本应该通过邮件，SMS 等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个是事件的类型，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个是事件的描述。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果 sentinel.conf 配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则 sentinel 无法正常启动成功。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通知脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel notification-script <master-name> <script-path>")]),s._v("\n  sentinel notification-script mymaster /var/redis/notify.sh\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端重新配置主节点参数脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当一个 Master 由于 failover 而发生改变时，这个脚本将会被调用，通知相关的客户端关于 Master 地址已经发生改变的信息。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下参数将会在调用脚本时传给脚本:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 目前 <state> 总是「failover」,")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <role> 是「leader」或者「observer」中的一个。 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参数 from-ip, from-port, to-ip, to-port 是用来和旧的 Master 和新的 Master(即旧的 Slave)通信的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个脚本应该是通用的，能被多次调用，不是针对性的。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel client-reconfig-script <master-name> <script-path>")]),s._v("\nsentinel client-reconfig-script mymaster /var/redis/reconfig.sh\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br")])]),t("h3",{attrs:{id:"java整合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#java整合"}},[s._v("#")]),s._v(" Java整合")]),s._v(" "),t("p",[s._v("开启哨兵后，Java 获取哨兵的代码：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),s._v(" jedisSentinelPool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getJedisFromSentinel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedisSentinelPool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Set")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" sentinelSet "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HashSet")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n    \tsentinelSet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.197.200:26379"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定哨兵的ip和端口")]),s._v("\n    \t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisPoolConfig")]),s._v(" jedisPoolConfig "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisPoolConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \tjedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMaxTotal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//最大可用连接数")]),s._v("\n    \tjedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMaxIdle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//最大闲置连接数")]),s._v("\n    \tjedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMinIdle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//最小闲置连接数")]),s._v("\n    \tjedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setBlockWhenExhausted")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//连接耗尽是否等待")]),s._v("\n    \tjedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMaxWaitMillis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//等待时间")]),s._v("\n    \tjedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTestOnBorrow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//取连接的时候进行一下测试 ping pong")]),s._v("\n    \tjedisSentinelPool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sentinelSet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("jedisPoolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" jedisSentinelPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" jedisSentinelPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);