(window.webpackJsonp=window.webpackJsonp||[]).push([[306],{655:function(s,a,t){"use strict";t.r(a);var e=t(10),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"nginx-缓存集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-缓存集成"}},[s._v("#")]),s._v(" Nginx 缓存集成")]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#缓存的概念"}},[s._v("缓存的概念")])]),a("li",[a("a",{attrs:{href:"#web缓存服务"}},[s._v("Web缓存服务")])]),a("li",[a("a",{attrs:{href:"#缓存设置相关指令"}},[s._v("缓存设置相关指令")]),a("ul",[a("li",[a("a",{attrs:{href:"#proxy-cache-path"}},[s._v("proxycachepath")])]),a("li",[a("a",{attrs:{href:"#proxy-cache"}},[s._v("proxy_cache")])]),a("li",[a("a",{attrs:{href:"#proxy-cache-key"}},[s._v("proxycachekey")])]),a("li",[a("a",{attrs:{href:"#proxy-cache-valid"}},[s._v("proxycachevalid")])]),a("li",[a("a",{attrs:{href:"#proxy-cache-min-uses"}},[s._v("proxycachemin_uses")])]),a("li",[a("a",{attrs:{href:"#proxy-cache-methods"}},[s._v("proxycachemethods")])])])]),a("li",[a("a",{attrs:{href:"#缓存设置案例"}},[s._v("缓存设置案例")]),a("ul",[a("li",[a("a",{attrs:{href:"#需求分析"}},[s._v("需求分析")])]),a("li",[a("a",{attrs:{href:"#步骤实现"}},[s._v("步骤实现")])])])]),a("li",[a("a",{attrs:{href:"#缓存的删除"}},[s._v("缓存的删除")]),a("ul",[a("li",[a("a",{attrs:{href:"#删除缓存目录"}},[s._v("删除缓存目录")])]),a("li",[a("a",{attrs:{href:"#ngx-cache-purge删除"}},[s._v("ngxcachepurge删除")])])])]),a("li",[a("a",{attrs:{href:"#资源不缓存"}},[s._v("资源不缓存")]),a("ul",[a("li",[a("a",{attrs:{href:"#proxy-no-cache"}},[s._v("proxynocache")])]),a("li",[a("a",{attrs:{href:"#proxy-cache-bypass"}},[s._v("proxycachebypass")])]),a("li",[a("a",{attrs:{href:"#常用不缓存变量"}},[s._v("常用不缓存变量")])]),a("li",[a("a",{attrs:{href:"#案例模板"}},[s._v("案例模板")])])])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"缓存的概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存的概念"}},[s._v("#")]),s._v(" 缓存的概念")]),s._v(" "),a("p",[s._v("缓存就是数据交换的缓冲区（称作：Cache），当用户要获取数据的时候，会先从缓存中去查询获取数据，如果缓存中有就会直接返回给用户，如果缓存中没有，则会发请求从服务器重新查询数据，将数据返回给用户的同时将数据放入缓存，下次用户就会直接从缓存中获取数据。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.371wkgon7280.webp",alt:"image"}})]),s._v(" "),a("p",[s._v("缓存其实在很多场景中都有用到，比如：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("场景")]),s._v(" "),a("th",[s._v("作用")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("操作系统磁盘缓存")]),s._v(" "),a("td",[s._v("减少磁盘机械操作")])]),s._v(" "),a("tr",[a("td",[s._v("数据库缓存")]),s._v(" "),a("td",[s._v("减少文件系统的IO操作")])]),s._v(" "),a("tr",[a("td",[s._v("应用程序缓存")]),s._v(" "),a("td",[s._v("减少对数据库的查询")])]),s._v(" "),a("tr",[a("td",[s._v("Web 服务器缓存")]),s._v(" "),a("td",[s._v("减少对应用服务器请求次数")])]),s._v(" "),a("tr",[a("td",[s._v("浏览器缓存")]),s._v(" "),a("td",[s._v("减少与后台的交互次数")])])])]),s._v(" "),a("p",[s._v("缓存的优点")]),s._v(" "),a("ul",[a("li",[s._v("减少数据传输，节省网络流量，加快响应速度，提升用户体验")]),s._v(" "),a("li",[s._v("减轻服务器压力")]),s._v(" "),a("li",[s._v("提供服务端的高可用性")])]),s._v(" "),a("p",[s._v("缓存的缺点")]),s._v(" "),a("ul",[a("li",[s._v("数据的不一致")]),s._v(" "),a("li",[s._v("增加成本")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.2itt4ge9erq0.webp",alt:"image"}})]),s._v(" "),a("p",[s._v("在 "),a("RouterLink",{attrs:{to:"/middleware/Nginx/Nginx_Static_resource_deployment/#静态资源缓存配置"}},[s._v("静态资源部署 - 缓存配置")]),s._v(" 的时候，我们学习了如何在浏览器进行缓存，而本内容学习的是 Nginx。")],1),s._v(" "),a("p",[s._v("Nginx 作为 Web 服务器，Nginx 作为 Web 缓存服务器，它介于客户端和应用服务器之间，当用户通过浏览器访问一个 URL 时，Web 缓存服务器会去应用服务器获取要展示给用户的内容，将内容缓存到自己的服务器上，当下一次请求到来时，如果访问的是同一个 URL，Web 缓存服务器就会直接将之前缓存的内容返回给客户端，而不是向应用服务器再次发送请求。Web 缓存降低了应用服务器、数据库的负载，减少了网络延迟，提高了用户访问的响应速度，增强了用户的体验。")]),s._v(" "),a("h2",{attrs:{id:"web缓存服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#web缓存服务"}},[s._v("#")]),s._v(" Web缓存服务")]),s._v(" "),a("p",[s._v("Nginx 是从 0.7.48 版开始提供缓存功能。Nginx 是基于 Proxy Store 来实现的，"),a("strong",[s._v("其原理是把 URL 及相关组合当做 Key，在使用 MD5 算法对 Key 进行哈希化，得到硬盘上对应的哈希目录路径，从而将缓存内容保存在该目录中")]),s._v("。它可以支持任意 URL 连接，同时也支持 404/301/302 这样的非200 状态码。Nginx 即可以支持对指定 URL 或者状态码设置过期时间，也可以使用 purge 命令来手动清除指定 URL 的缓存。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.5rf186zoffg0.webp",alt:"image"}})]),s._v(" "),a("h2",{attrs:{id:"缓存设置相关指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存设置相关指令"}},[s._v("#")]),s._v(" 缓存设置相关指令")]),s._v(" "),a("p",[s._v("Nginx 的 Web 缓存服务主要是使用 "),a("code",[s._v("ngx_http_proxy_module")]),s._v(" 模块相关指令集来完成，接下来我们把常用的指令来进行介绍下。")]),s._v(" "),a("p",[a("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_proxy_module.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("ngx_http_proxy_module 文档地址"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"proxy-cache-path"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-path"}},[s._v("#")]),s._v(" proxy_cache_path")]),s._v(" "),a("p",[s._v("该指定用于设置缓存文件的存放路径。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_path <path> [levels=number]"),a("br"),s._v(" <keys_zone=zone_name:zone_size> [inactive=time][max_size=size];")]),s._v(" "),a("td",[s._v("—")]),s._v(" "),a("td",[s._v("http")])])])]),s._v(" "),a("p",[a("code",[s._v("path")]),s._v("：缓存路径地址，如：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("/usr/local/proxy_cache\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("levels")]),s._v(": 指定该缓存空间 "),a("code",[s._v("path")]),s._v(" 基础上新建的目录，最多可以设置 3 层，每层取 1 到 2 个字母作为目录名，格式为：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[s._v("levels=num:num:num   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 三个 num 代表三层，每层目录名分别取 num 个字母")]),s._v("\nlevels=num:num       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 两个 num 代表两层，每层目录名分别取 num 个字母")]),s._v("\nlevels=num           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个 num 代表一层，每层目录名分别取 num 个字母")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("如：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[s._v("levels=1:2   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 缓存空间有两层目录，第一层目录名取 1 个字母，第二层目录名取 2 个字母")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("字母名从 MD5 加密的值后面往前截取。")]),s._v(" "),a("p",[s._v("举例说明：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 假设 proxy_cache_key 为 kele，通过 MD5 加密以后的值为 27ce47ea65c1381dbe5175f7c77d8a3a")]),s._v("\nlevels=1:2    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终的存储路径为 /usr/local/proxy_cache/a/a3，每层截取个数根据 1:2")]),s._v("\nlevels=2:1:2  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终的存储路径为 /usr/local/proxy_cache/3a/a/d8，每层截取个数根据 2:1:2")]),s._v("\nlevels=2:2:2  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终的存储路径为 /usr/local/proxy_cache/3a/8a/7d，每层截取个数根据 2:2:2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("还不理解吗？存储路径在 "),a("code",[s._v("path")]),s._v(" 目录基础上再创建新的目录，新的目录名从加密后的值的后面往前面截取。")]),s._v(" "),a("p",[a("code",[s._v("keys_zone")]),s._v("：用来为这个缓存区设置名称和指定大小，如：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[s._v("keys_zone=kele:200m  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 缓存区的名称是 kele，大小为 200M，1M 大概能存储 8000 个 keys")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("inactive")]),s._v("：指定的时间内未访问的缓存数据会从缓存中删除，默认情况下，"),a("code",[s._v("inactive")]),s._v(" 设置为 10 分钟。如：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[s._v("inactive=1d   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 缓存数据在 1 天内没有被访问就会被删除")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("max_size")]),s._v("：设置最大缓存空间，如果缓存空间存满，默认会覆盖缓存时间最长的资源，默认单位为兆。如：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[s._v("max_size=20g    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大缓存空间为 20G")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("配置实例:")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_path")]),s._v(" /usr/local/proxy_cache keys_zone=kele:200m levels=1:2:1 inactive=1d max_size=20g")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("此时重启 Nginx 配置文件，发现 "),a("code",[s._v("/usr/local")]),s._v(" 目录里多出一个目录，名字叫做 proxy_cache。")]),s._v(" "),a("h3",{attrs:{id:"proxy-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache"}},[s._v("#")]),s._v(" proxy_cache")]),s._v(" "),a("p",[s._v("该指令用来开启或关闭代理缓存，如果是开启则自定使用哪个缓存区来进行缓存。默认关闭。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache <zone_name | off>;")]),s._v(" "),a("td",[s._v("proxy_cache off;")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("p",[s._v("zone_name：指定使用缓存区的名称。")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("缓存区的名称必须是 "),a("code",[s._v("proxy_cache_path")]),s._v(" 里的 "),a("code",[s._v("keys_zone")]),s._v(" 生成的缓存名。")])]),s._v(" "),a("h3",{attrs:{id:"proxy-cache-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-key"}},[s._v("#")]),s._v(" proxy_cache_key")]),s._v(" "),a("p",[s._v("该指令用来设置 Web 缓存的 key 值，Nginx 会根据 key 值利用 MD5 计算处哈希值并缓存起来，作为缓存目录名的参考。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_key <key>;")]),s._v(" "),a("td",[s._v("proxy_cache_key "),a("mjx-container",{staticClass:"MathJax",attrs:{jax:"SVG"}},[a("svg",{staticStyle:{"vertical-align":"-0.025ex"},attrs:{xmlns:"http://www.w3.org/2000/svg",width:"7.439ex",height:"1.595ex",viewBox:"0 -694 3288 705"}},[a("g",{attrs:{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"matrix(1 0 0 -1 0 0)"}},[a("g",{attrs:{"data-mml-node":"math"}},[a("g",{attrs:{"data-mml-node":"mi"}},[a("path",{attrs:{"data-c":"73",d:"M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"}})]),a("g",{attrs:{"data-mml-node":"mi",transform:"translate(469, 0)"}},[a("path",{attrs:{"data-c":"63",d:"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"}})]),a("g",{attrs:{"data-mml-node":"mi",transform:"translate(902, 0)"}},[a("path",{attrs:{"data-c":"68",d:"M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"}})]),a("g",{attrs:{"data-mml-node":"mi",transform:"translate(1478, 0)"}},[a("path",{attrs:{"data-c":"65",d:"M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"}})]),a("g",{attrs:{"data-mml-node":"mi",transform:"translate(1944, 0)"}},[a("path",{attrs:{"data-c":"6D",d:"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"}})]),a("g",{attrs:{"data-mml-node":"mi",transform:"translate(2822, 0)"}},[a("path",{attrs:{"data-c":"65",d:"M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"}})])])])])]),s._v("proxy_host$request_uri;")],1),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("p",[s._v("如 kele 由 MD5 计算出来是 27ce47ea65c1381dbe5175f7c77d8a3a")]),s._v(" "),a("p",[s._v("在哪计算出来的？ 前往 "),a("a",{attrs:{href:"https://md5jiami.bmcx.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("MD5 在线加密网站"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"proxy-cache-valid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-valid"}},[s._v("#")]),s._v(" proxy_cache_valid")]),s._v(" "),a("p",[s._v("该指令用来对不同返回状态码的 URL 设置不同的缓存时间。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_valid [code ...... ] <time>;")]),s._v(" "),a("td",[s._v("—")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("p",[s._v("如：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("302")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 200 和 302 的响应 URL 设置 10 分钟缓存时间")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 404 的响应 URL 设置 1 分钟缓存时间")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" any "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对所有响应状态码的URL都设置 1 分钟缓存时间")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"proxy-cache-min-uses"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-min-uses"}},[s._v("#")]),s._v(" proxy_cache_min_uses")]),s._v(" "),a("p",[s._v("该指令用来设置资源被访问多少次后才会被缓存。默认是 1 次。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_min_uses <number>;")]),s._v(" "),a("td",[s._v("proxy_cache_min_uses 1;")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("h3",{attrs:{id:"proxy-cache-methods"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-methods"}},[s._v("#")]),s._v(" proxy_cache_methods")]),s._v(" "),a("p",[s._v("该指令是设置缓存哪些 HTTP 方法的请求资源。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_methods <GET | HEAD | POST>;")]),s._v(" "),a("td",[s._v("proxy_cache_methods GET HEAD;")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("p",[s._v("默认缓存 HTTP 的 GET 和 HEAD 方法的请求资源，不缓存 POST 方法的请求资源。")]),s._v(" "),a("h2",{attrs:{id:"缓存设置案例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存设置案例"}},[s._v("#")]),s._v(" 缓存设置案例")]),s._v(" "),a("h3",{attrs:{id:"需求分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#需求分析"}},[s._v("#")]),s._v(" 需求分析")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.4ye8ddxwbng0.webp",alt:"image"}})]),s._v(" "),a("h3",{attrs:{id:"步骤实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤实现"}},[s._v("#")]),s._v(" 步骤实现")]),s._v(" "),a("p",[a("strong",[s._v("应用服务器的环境准备")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("在 "),a("code",[s._v("192.168.200.146")]),s._v(" 服务器 A 上的 tomcat 的 webapps 下面添加一个 js 目录，并在 js 目录中添加一个 jquery.js 文件")])]),s._v(" "),a("li",[a("p",[s._v("启动 tomcat")])])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/tomcat/bin\n./startup.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("访问服务器 A 进行测试")])]),s._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header"}},[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[s._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token header-value"}},[s._v("//192.168.200.146:8080/js/jquery.js")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("Nginx 的环境准备")])]),s._v(" "),a("ol",[a("li",[s._v("准备服务器 B 完成 Nginx 的反向代理配置")])]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 192.168.200.146:8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器 A 地址")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("  localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        \t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://backend/js/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("完成 Nginx 缓存配置")])]),s._v(" "),a("p",[s._v(':::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }"')]),s._v(" "),a("p",[s._v("::: tab 有注释版")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_path")]),s._v(" /usr/local/proxy_cache levels=2:1 keys_zone=bing:200m inactive=1d max_size=20g")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 192.168.200.146:8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器 A 的地址")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听 8080 端口")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("  localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听 localhost 的IP")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听包含 / 的请求")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache")]),s._v(" bing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启 bing 缓存区，和第 2 行的 keys_zone 对应")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_key")]),s._v(" kele")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 缓存的 key 值，会被 MD5 解析成字符串用于生成缓存的目录")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_min_uses")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 资源被访问 5 次后才会被缓存")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5d")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 200 响应 URL 设置 5 天缓存时间")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30s")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 404 的响应 URL 设置 30 秒缓存时间")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" any "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为除了上方的任意响应 URL 设置 1 分钟缓存时间")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" nginx-cache "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$upstream_cache_status")]),s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将缓存的状态放到请求头里")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://backend/js/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 代理 backend，将 /js/ 追加到 backend 模块里的地址后面")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v(":::")]),s._v(" "),a("p",[s._v("::: tab 无注释版")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_path")]),s._v(" /usr/local/proxy_cache levels=2:1 keys_zone=bing:200m inactive=1d max_size=20g")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 192.168.200.146:8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("  localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache")]),s._v(" bing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_key")]),s._v(" kele")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_min_uses")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5d")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30s")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" any "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" nginx-cache "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$upstream_cache_status")]),s._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://backend/js/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v(":::")]),s._v(" "),a("p",[s._v("::::")]),s._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[s._v("测试是否缓存成功")])]),s._v(" "),a("p",[s._v("利用 "),a("code",[s._v("$upstream_cache_status")]),s._v(" 的值在控制台(F12)查看是否缓存。")]),s._v(" "),a("p",[s._v("第一次访问 "),a("code",[s._v("192.168.200.113:8080/jquery.js")]),s._v("，如图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.3p1azxp6cdy0.webp",alt:"image"}})]),s._v(" "),a("p",[s._v("因为第一次访问时，正在缓存，所以返回的请求头 MISS 是没有缓存成功。")]),s._v(" "),a("p",[s._v("第二次访问 "),a("code",[s._v("192.168.200.113:8080/jquery.js")]),s._v("，如图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.73w7kaxo8r00.webp",alt:"image"}})]),s._v(" "),a("p",[s._v("HIT 代表成功缓存。")]),s._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[s._v("测试 404 缓存时间")])]),s._v(" "),a("p",[s._v("测试 404 缓存时间，我们访问 "),a("code",[s._v("192.168.200.113:8080/jquery.js111")]),s._v("，它会返回 404 页面，并缓存 404 页面，当我们立即访问正确的 "),a("code",[s._v("192.168.200.113:8080/jquery.js")]),s._v("，它依然返回 404 页面，因为 "),a("code",[s._v("/jquery.js")]),s._v(" 请求目前被缓存为 404，还没到 30 秒过期，等 30 秒后再访问，就成功了。")]),s._v(" "),a("h2",{attrs:{id:"缓存的删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存的删除"}},[s._v("#")]),s._v(" 缓存的删除")]),s._v(" "),a("p",[s._v("这里介绍两种方式：")]),s._v(" "),a("ul",[a("li",[s._v("删除对应的缓存目录")]),s._v(" "),a("li",[s._v("使用第三方扩展模块")])]),s._v(" "),a("h3",{attrs:{id:"删除缓存目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除缓存目录"}},[s._v("#")]),s._v(" 删除缓存目录")]),s._v(" "),a("p",[s._v("假设缓存目录是 "),a("code",[s._v("/usr/local/proxy_cache/")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v(" /usr/local/proxy_cache/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果想删除某个缓存目录，就在后面加上目录名。如果想删除整个缓存目录，直接删除 "),a("code",[s._v("/usr/local/proxy_cache/")]),s._v(" 即可。")]),s._v(" "),a("h3",{attrs:{id:"ngx-cache-purge删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ngx-cache-purge删除"}},[s._v("#")]),s._v(" ngx_cache_purge删除")]),s._v(" "),a("p",[s._v("使用第三方扩展模块 "),a("code",[s._v("ngx_cache_purge")]),s._v(" 进行删除缓存。")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("下载 "),a("code",[s._v("ngx_cache_purge")]),s._v(" 模块对应的资源包，并上传到服务器的 "),a("code",[s._v("/root/nginx/module/")]),s._v(" 目录下。")]),s._v(" "),a("p",[s._v("这里的资源包是 ngx_cache_purge-2.3.tar.gz")])]),s._v(" "),a("li",[a("p",[s._v("对资源文件进行解压缩")])])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxf")]),s._v(" ngx_cache_purge-2.3.tar.gz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("修改文件夹名称为 "),a("code",[s._v("purge")]),s._v("，方便后期配置")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" ngx_cache_purge-2.3 purge\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("查询 Nginx 的配置参数 "),a("code",[s._v("configure arguments")]),s._v("，并拷贝出来")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-V")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("进入 Nginx 的安装包目录，使用 ./configure 进行参数配置，记得加上 "),a("code",[s._v("nginx -V")]),s._v(" 查询出来的 "),a("code",[s._v("configure arguments")]),s._v(" 参数")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("./configure --add-module"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/root/nginx/module/purge  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加上之前的 configure arguments 参数")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"6"}},[a("li",[s._v("使用 make 进行编译")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"7"}},[a("li",[s._v("将 Nginx 安装目录的 nginx 二级制可执行文件备份")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.backup\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"8"}},[a("li",[s._v("将编译后的 objs 中的 nginx 拷贝到 nginx 的 sbin 目录下")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" objs/nginx /usr/local/nginx/sbin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"9"}},[a("li",[s._v("使用 "),a("code",[s._v("make upgrade")]),s._v(" 进行升级，记得在安装包目录下执行")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/nginx/core/nginx-1.20.2\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" upgrade\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"10"}},[a("li",[s._v("在 Nginx 配置文件中进行如下配置")])]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" ~/purge(/.*)")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_purge")]),s._v(" bing kele")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("proxy_cache_purge")]),s._v(" 指令")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_purge <cache> <key>")]),s._v(" "),a("td",[s._v("-")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("ul",[a("li",[a("code",[s._v("cache")]),s._v(" 是 "),a("code",[s._v("proxy_cache")]),s._v("，详细内容看 "),a("a",{attrs:{href:"https://notes.youngkbt.cn/nginx/cache-integration/#proxy-cache",target:"_blank",rel:"noopener noreferrer"}},[s._v("proxy_cache"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("code",[s._v("key")]),s._v(" 是 "),a("code",[s._v("proxy_cache_key")]),s._v("，详细内容看 "),a("a",{attrs:{href:"https://notes.youngkbt.cn/nginx/cache-integration/#proxy-cache-key",target:"_blank",rel:"noopener noreferrer"}},[s._v("proxy_cache_key"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"资源不缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#资源不缓存"}},[s._v("#")]),s._v(" 资源不缓存")]),s._v(" "),a("p",[s._v("前面咱们已经完成了 Nginx 作为 Web 缓存服务器的使用。但是我们得思考一个问题，"),a("strong",[s._v("不是所有的数据都适合进行缓存")]),s._v("。比如说对于一些经常发生变化的数据。如果进行缓存的话，就很容易出现用户访问到的数据不是服务器真实的数据。所以对于这些资源我们在缓存的过程中就需要进行过滤，不进行缓存。")]),s._v(" "),a("p",[s._v("Nginx 也提供了这块的功能设置，需要使用到如下两个指令：")]),s._v(" "),a("ul",[a("li",[s._v("proxy_no_cache")]),s._v(" "),a("li",[s._v("proxy_cache_bypass")])]),s._v(" "),a("h3",{attrs:{id:"proxy-no-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-no-cache"}},[s._v("#")]),s._v(" proxy_no_cache")]),s._v(" "),a("p",[s._v("该指令是用来定义不将数据进行缓存的条件，也就是不缓存指定的数据。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_no_cache <string> ...... ;")]),s._v(" "),a("td",[s._v("—")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("p",[s._v("可设置多个 string。")]),s._v(" "),a("p",[s._v("配置实例：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_no_cache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cookie_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_comment")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"proxy-cache-bypass"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxy-cache-bypass"}},[s._v("#")]),s._v(" proxy_cache_bypass")]),s._v(" "),a("p",[s._v("该指令是用来设置不从缓存中获取数据的条件，也就是虽然缓存了指定的资源，但请求过来也不会去获取它，而是去服务器里获取资源。")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("语法")]),s._v(" "),a("th",[s._v("默认值")]),s._v(" "),a("th",[s._v("位置")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("proxy_cache_bypass <string> ...... ;")]),s._v(" "),a("td",[s._v("—")]),s._v(" "),a("td",[s._v("http、server、location")])])])]),s._v(" "),a("p",[s._v("可设置多个 string。")]),s._v(" "),a("p",[s._v("配置实例：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_bypass")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cookie_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_comment")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("上述两个指令都有一个指定的条件，这个条件可以是多个，"),a("strong",[s._v("并且多个条件中至少有一个不为空且不等于「0」，则条件满足成立。")])]),s._v(" "),a("p",[s._v("上面给的配置实例是从官方网站获取的，里面使用到了三个变量，分别是 "),a("code",[s._v("$cookie_nocache")]),s._v("、"),a("code",[s._v("$arg_nocache")]),s._v("、"),a("code",[s._v("$arg_comment")])]),s._v(" "),a("h3",{attrs:{id:"常用不缓存变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用不缓存变量"}},[s._v("#")]),s._v(" 常用不缓存变量")]),s._v(" "),a("p",[s._v("常用不缓存的三个变量分别为：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("$cookie_nocache")])]),s._v(" "),a("li",[a("code",[s._v("$arg_nocache")])]),s._v(" "),a("li",[a("code",[s._v("$arg_comment")])])]),s._v(" "),a("p",[s._v("这三个变量分别代表的含义是:")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("$cookie_nocache")]),s._v("：指的是当前请求的 cookie 中 key 为 nocache 的 value 值")]),s._v(" "),a("li",[a("code",[s._v("$arg_nocache")]),s._v(" 和 "),a("code",[s._v("$arg_comment")]),s._v("：指的是当前请求的参数中属性名为 nocache 和 comment 对应的属性值")])]),s._v(" "),a("p",[s._v("案例演示:")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("log_format")]),s._v(" params "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cookie_nocache")]),s._v(" | "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_nocache")]),s._v(" | "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_comment；")]),s._v("\nserver")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs/access_params.log params")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" Set-Cookie "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nocache=888'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("访问 "),a("code",[s._v("192.168.200.133:8081?nocache=999&comment=777")]),s._v("，然后去日志查看结果，如图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220805/image.695kmtpob840.webp",alt:"image"}})]),s._v(" "),a("p",[s._v("以后访问的某一个资源如果不想缓存，在 URL 后面加入三个变量中的任意一个或多个即可，只要它们不为空或 0。")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("这三个变量推荐作为不缓存资源的条件，但并不是只能作为不缓存资源的条件。")])]),s._v(" "),a("h3",{attrs:{id:"案例模板"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#案例模板"}},[s._v("#")]),s._v(" 案例模板")]),s._v(" "),a("p",[s._v("设置不缓存资源的配置方案模板：")]),s._v(" "),a("ul",[a("li",[s._v("如果访问的是 js 文件，则不会缓存该 js 文件")]),s._v(" "),a("li",[s._v("如果 "),a("code",[s._v("$nocache")]),s._v(" "),a("code",[s._v("$cookie_nocache")]),s._v(" "),a("code",[s._v("$arg_nocache")]),s._v(" "),a("code",[s._v("$arg_comment")]),s._v(" 任意不为空或 0，则访问的资源不进行缓存")])]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),s._v(" ~ /.*\\.js$)")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_no_cache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cookie_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_comment")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_bypass")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cookie_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_nocache")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$arg_comment")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("为什么不会缓存 js 文件呢，看第 5 - 6 行代码。如果访问的文件是 js 文件，则设置 "),a("code",[s._v("$nocache")]),s._v(" 为 1，只要它不为 0，则触发第 8 行代码，"),a("code",[s._v("proxy_no_cache")]),s._v(" 后面的参数只要有一个不为空或 0，则访问的资源不进行缓存。")])])}),[],!1,null,null,null);a.default=n.exports}}]);