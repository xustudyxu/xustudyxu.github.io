(window.webpackJsonp=window.webpackJsonp||[]).push([[309],{661:function(s,t,a){"use strict";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"nginx-lua扩展模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-lua扩展模块"}},[s._v("#")]),s._v(" Nginx Lua扩展模块")]),s._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#ngx-lua模块概念"}},[s._v("ngx_lua模块概念")])]),t("li",[t("a",{attrs:{href:"#ngx-lua模块环境准备"}},[s._v("ngx_lua模块环境准备")]),t("ul",[t("li",[t("a",{attrs:{href:"#方式一"}},[s._v("方式一")])]),t("li",[t("a",{attrs:{href:"#方式二"}},[s._v("方式二")])]),t("li",[t("a",{attrs:{href:"#openresty卸载"}},[s._v("OpenResty卸载")])])])]),t("li",[t("a",{attrs:{href:"#ngx-lua指令图"}},[s._v("ngx_lua指令图")])]),t("li",[t("a",{attrs:{href:"#语法api"}},[s._v("语法API")]),t("ul",[t("li",[t("a",{attrs:{href:"#ngx-say"}},[s._v("ngx.say")])]),t("li",[t("a",{attrs:{href:"#ngx-print"}},[s._v("ngx.print")])]),t("li",[t("a",{attrs:{href:"#ngx-flush"}},[s._v("ngx.flush")])]),t("li",[t("a",{attrs:{href:"#ngx-arg"}},[s._v("ngx.arg")])]),t("li",[t("a",{attrs:{href:"#ngx-var"}},[s._v("ngx.var")])]),t("li",[t("a",{attrs:{href:"#ngx-log"}},[s._v("ngx.log")])]),t("li",[t("a",{attrs:{href:"#http-方法常量"}},[s._v("HTTP 方法常量")])]),t("li",[t("a",{attrs:{href:"#http-状态常量"}},[s._v("HTTP 状态常量")])]),t("li",[t("a",{attrs:{href:"#print"}},[s._v("print")])]),t("li",[t("a",{attrs:{href:"#ngx-ctx"}},[s._v("ngx.ctx")])]),t("li",[t("a",{attrs:{href:"#ngx-exit"}},[s._v("ngx.exit")])]),t("li",[t("a",{attrs:{href:"#ngx-sleep"}},[s._v("ngx.sleep")])])])]),t("li",[t("a",{attrs:{href:"#请求api"}},[s._v("请求API")]),t("ul",[t("li",[t("a",{attrs:{href:"#ngx-req-get-uri-args"}},[s._v("ngx.req.geturiargs")])]),t("li",[t("a",{attrs:{href:"#ngx-req-set-uri-args"}},[s._v("ngx.req.seturiargs")])]),t("li",[t("a",{attrs:{href:"#ngx-header-header"}},[s._v("ngx.header.HEADER")])]),t("li",[t("a",{attrs:{href:"#ngx-req-get-method"}},[s._v("ngx.req.get_method")])]),t("li",[t("a",{attrs:{href:"#ngx-req-set-method"}},[s._v("ngx.req.set_method")])]),t("li",[t("a",{attrs:{href:"#ngx-req-read-body"}},[s._v("ngx.req.read_body")])]),t("li",[t("a",{attrs:{href:"#ngx-req-get-post-args"}},[s._v("ngx.req.getpostargs")])]),t("li",[t("a",{attrs:{href:"#ngx-redirect"}},[s._v("ngx.redirect")])]),t("li",[t("a",{attrs:{href:"#ngx-exec"}},[s._v("ngx.exec")])]),t("li",[t("a",{attrs:{href:"#ngx-location-capture"}},[s._v("ngx.location.capture")])]),t("li",[t("a",{attrs:{href:"#ngx-req-set-uri"}},[s._v("ngx.req.set_uri")])])])]),t("li",[t("a",{attrs:{href:"#指令api"}},[s._v("指令API")]),t("ul",[t("li",[t("a",{attrs:{href:"#init-by-lua"}},[s._v("initbylua")])]),t("li",[t("a",{attrs:{href:"#init-worker-by-lua"}},[s._v("initworkerby_lua")])]),t("li",[t("a",{attrs:{href:"#set-by-lua"}},[s._v("setbylua")])]),t("li",[t("a",{attrs:{href:"#rewrite-by-lua"}},[s._v("rewritebylua")])]),t("li",[t("a",{attrs:{href:"#access-by-lua"}},[s._v("accessbylua")])]),t("li",[t("a",{attrs:{href:"#content-by-lua"}},[s._v("contentbylua")])]),t("li",[t("a",{attrs:{href:"#header-filter-by-lua"}},[s._v("headerfilterby_lua")])]),t("li",[t("a",{attrs:{href:"#body-filter-by-lua"}},[s._v("bodyfilterby_lua")])]),t("li",[t("a",{attrs:{href:"#log-by-lua"}},[s._v("logbylua")])]),t("li",[t("a",{attrs:{href:"#balancer-by-lua"}},[s._v("balancerbylua")])]),t("li",[t("a",{attrs:{href:"#ssl-certificate-by"}},[s._v("sslcertificateby")])])])]),t("li",[t("a",{attrs:{href:"#简单案例"}},[s._v("简单案例")]),t("ul",[t("li",[t("a",{attrs:{href:"#需求"}},[s._v("需求")])]),t("li",[t("a",{attrs:{href:"#实现"}},[s._v("实现")])])])]),t("li",[t("a",{attrs:{href:"#ngx-lua操作redis"}},[s._v("ngx_lua操作Redis")]),t("ul",[t("li",[t("a",{attrs:{href:"#redis环境准备"}},[s._v("Redis环境准备")])]),t("li",[t("a",{attrs:{href:"#api学习"}},[s._v("API学习")])]),t("li",[t("a",{attrs:{href:"#效果实现"}},[s._v("效果实现")])])])]),t("li",[t("a",{attrs:{href:"#ngx-lua操作mysql"}},[s._v("ngx_lua操作Mysql")]),t("ul",[t("li",[t("a",{attrs:{href:"#lua-resty-mysql"}},[s._v("lua-resty-mysql")])]),t("li",[t("a",{attrs:{href:"#mysql环境准备"}},[s._v("MySQL环境准备")])]),t("li",[t("a",{attrs:{href:"#api学习"}},[s._v("API学习")])]),t("li",[t("a",{attrs:{href:"#表创建并插入数据"}},[s._v("表创建并插入数据")])]),t("li",[t("a",{attrs:{href:"#数据查询"}},[s._v("数据查询")])]),t("li",[t("a",{attrs:{href:"#lua-cjson处理查询结果"}},[s._v("lua-cjson处理查询结果")])]),t("li",[t("a",{attrs:{href:"#数据库删改"}},[s._v("数据库删改")])])])])])]),t("p"),s._v(" "),t("h2",{attrs:{id:"ngx-lua模块概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua模块概念"}},[s._v("#")]),s._v(" ngx_lua模块概念")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/openresty/lua-nginx-module#readme",target:"_blank",rel:"noopener noreferrer"}},[s._v("ngx_lua 官方文档"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://www.kancloud.cn/qq13867685/openresty-api-cn/159175",target:"_blank",rel:"noopener noreferrer"}},[s._v("ngx_lua 中文文档"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("淘宝开发的 "),t("code",[s._v("ngx_lua")]),s._v(" 模块通过将 Lua 解释器集成进 Nginx，可以采用 Lua 脚本实现业务逻辑，由于 Lua 的紧凑、快速以及内建协程，所以在保证高并发服务能力的同时极大地降低了业务逻辑实现成本。")]),s._v(" "),t("h2",{attrs:{id:"ngx-lua模块环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua模块环境准备"}},[s._v("#")]),s._v(" ngx_lua模块环境准备")]),s._v(" "),t("p",[s._v("下载 "),t("code",[s._v("ngx-lua-module")]),s._v(" 模块有两个方式。")]),s._v(" "),t("ul",[t("li",[s._v("方式一安装比较繁琐，需要手动下载其他依赖")]),s._v(" "),t("li",[s._v("方式二安装简单快捷，集成了依赖，不需要手动下载依赖，建议方式二")])]),s._v(" "),t("p",[s._v("不论方式一还是方式二安装，"),t("strong",[s._v("首先确保你为它安装好了环境，否则会安装报错")]),s._v("。环境分别为："),t("code",[s._v("GCC")]),s._v("、"),t("code",[s._v("PCRE")]),s._v("、"),t("code",[s._v("zlib")]),s._v("、"),t("code",[s._v("OpenSSL")]),s._v("。"),t("RouterLink",{attrs:{to:"/middleware/Nginx/Nginx_install/#nginx环境安装"}},[s._v("环境安装传送门")]),s._v("。")],1),s._v(" "),t("h3",{attrs:{id:"方式一"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方式一"}},[s._v("#")]),s._v(" 方式一")]),s._v(" "),t("p",[s._v("方式一下载第三方模块 "),t("code",[s._v("lua-nginx-module")]),s._v("，前，需要先下载 "),t("code",[s._v("LuaJIT")]),s._v(" 解析器。")]),s._v(" "),t("p",[t("code",[s._v("LuaJIT")]),s._v(" 官网地址为："),t("a",{attrs:{href:"http://luajit.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://luajit.org/"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("LuaJIT 是采用 C 语言编写的 Lua 代表的解释器，我们先下载它。")]),s._v(" "),t("p",[s._v("在官网上找到对应的下载地址："),t("a",{attrs:{href:"https://luajit.org/download.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://luajit.org/download.html"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("在 Linux 上使用 wget 来下载: "),t("code",[s._v("wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz")]),s._v("，这里下载在 "),t("code",[s._v("/opt")]),s._v("，下载的版本是 2.0.5。")])])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://luajit.org/download/LuaJIT-2.0.5.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("将下载的资源进行解压")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxf")]),s._v(" LuaJIT-2.0.5.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("进入解压的目录")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" LuaJIT-2.0.5\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("执行编译和安装:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.50moe87h8k00.webp",alt:"image"}})]),s._v(" "),t("ul",[t("li",[s._v("下载 "),t("code",[s._v("lua-nginx-module")])])]),s._v(" "),t("p",[s._v("下载地址："),t("a",{attrs:{href:"https://github.com/openresty/lua-nginx-module/tags",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/openresty/lua-nginx-module/tags"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("在 Linux 上使用 wget 来下载: "),t("code",[s._v("wget https://github.com/openresty/lua-nginx-module/archive/v0.10.16rc4.tar.gz")]),s._v("，这里下载在 "),t("code",[s._v("/opt")]),s._v("，版本是 0.10.16rc4。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/openresty/lua-nginx-module/archive/v0.10.16rc4.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("将下载的资源进行解压")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxf")]),s._v(" lua-nginx-module-0.10.16rc4.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("目录名太长，更改目录名")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" lua-nginx-module-0.10.16rc4 lua-nginx-module\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("导入环境变量，告诉 Nginx 去哪里找 LuaJIT")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LUAJIT_LIB")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/lib\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LUAJIT_INC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/include/luajit-2.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("进入 Nginx 的源码目录（安装包目录）执行如下命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("./configure "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--prefix")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx --add-module"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/lua-nginx-module\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("注意事项")])]),s._v(" "),t("ol",[t("li",[s._v("如果启动 Nginx 出现如下错误:")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.3mn8xd7igx20.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("解决方案：")]),s._v(" "),t("p",[s._v("设置软链接，使用如下命令")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /usr/local/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("如果启动 Nginx 出现以下错误信息")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.6h5kw6afg4w0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("分析原因：因为 "),t("code",[s._v("lua-nginx-module")]),s._v(" 是来自 OpenResty，错误中提示的 resty.core 是 OpenRestry 的核心模块，对其下的很多函数进行了优化等工作。以前的版本默认不会把该模块编译进去，所以需要使用的话，我们得手动安装，或者禁用就可以。但是最新的 "),t("code",[s._v("lua-nginx-module")]),s._v(" 模块已经强制性安装了该模块，所以此处因为缺少 resty 模块导致的报错信息。")]),s._v(" "),t("p",[s._v("解决方案有两个：一种是下载对应的模块，另一种则是禁用掉 restry 模块，禁用的方式为：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lua_load_resty_core")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("off")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("测试")])]),s._v(" "),t("p",[s._v("在 nginx.conf 下配置如下内容:")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /lua")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/html'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ngx.say(\"<h1>HELLO,LUA</h1>\")'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("配置成功后，启动 Nginx，通过浏览器进行访问，如果获取到如下结果，则证明安装成功。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.6dtqzlgzk5s0.webp",alt:"image"}})]),s._v(" "),t("h3",{attrs:{id:"方式二"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方式二"}},[s._v("#")]),s._v(" 方式二")]),s._v(" "),t("p",[s._v("方式二使用 OpenRestry 进行安装。OpenRestry 就是我们上面说到的 Nginx 的 Spring 之一。")]),s._v(" "),t("h4",{attrs:{id:"概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),t("p",[s._v("前面我们提到过，OpenResty 是由淘宝工程师开发的，所以其官方网站（"),t("a",{attrs:{href:"http://openresty.org/cn/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://openresty.org/"),t("OutboundLink")],1),s._v("）我们读起来是非常的方便。OpenResty 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。所以本身 OpenResty 内部就已经集成了 Nginx 和 Lua，所以我们使用起来会更加方便。")]),s._v(" "),t("h4",{attrs:{id:"linux安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux安装"}},[s._v("#")]),s._v(" Linux安装")]),s._v(" "),t("p",[s._v("下载地址："),t("a",{attrs:{href:"http://openresty.org/cn/download.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://openresty.org/cn/download.html"),t("OutboundLink")],1),s._v("。这里下载 1.19.9.1 版本。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可以在 Windows 下载 OpenResty："),t("a",{attrs:{href:"https://openresty.org/download/openresty-1.19.9.1.tar.gz",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://openresty.org/download/openresty-1.19.9.1.tar.gz"),t("OutboundLink")],1),s._v("，然后上传到 Linux")]),s._v(" "),t("p",[s._v("或者直接在 Linux 使用 wget 下载: "),t("code",[s._v("wget https://openresty.org/download/openresty-1.19.9.1.tar.gz")])])])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/openresty    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 没有就创建：mkdir /opt/openresty")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://openresty.org/download/openresty-1.19.9.1.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("解压缩")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxvf")]),s._v(" openresty-1.19.9.1.tar.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("进入 OpenResty 目录")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" openresty-1.19.9.1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("执行命令")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("./configure\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("执行命令进行编译和安装")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者")]),s._v("\ngmake "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" gmake "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("默认安装在 "),t("code",[s._v("/usr/local/")]),s._v(" 下。")]),s._v(" "),t("ul",[t("li",[s._v("进入 OpenResty 的目录，找到 nginx")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/openresty/nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("在 conf 目录下的 nginx.conf 添加如下内容：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" conf/nginx.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/html'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ngx.say(\"<h1>HELLO,OpenRestry</h1>\")'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("重启 Nginx 配置文件")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("nginx "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("先把 Nginx 停止运行")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("systemctl stop Nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后在 sbin 目录下启动可执行文件 nginx")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("./sbin/nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("通过浏览器访问测试"),t("code",[s._v("192.168.91.200")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.502009iyfd00.webp",alt:"image"}})]),s._v(" "),t("ul",[t("li",[s._v("通过浏览器访问测试"),t("code",[s._v("192.168.91.200/lua")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.4r1610qz44g0.webp",alt:"image"}})]),s._v(" "),t("h3",{attrs:{id:"openresty卸载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#openresty卸载"}},[s._v("#")]),s._v(" OpenResty卸载")]),s._v(" "),t("p",[s._v("卸载非常简单粗暴，相信我，这样卸载是对的，没什么问题。")]),s._v(" "),t("ol",[t("li",[s._v("停止 Nginx 服务")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 Nginx 是否停止，没有则去停止")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入 sbin 目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/openresty/nginx/sbin\n./nginx "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" stop\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("输入以下指令全局查找 OpenResty 相关的文件")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" / "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" openresty\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("find / -name openresty")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v("  此处跟查找出来的 Openresty 文件\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"ngx-lua指令图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua指令图"}},[s._v("#")]),s._v(" ngx_lua指令图")]),s._v(" "),t("p",[s._v("使用 Lua 编写 Nginx 脚本的基本构建块是指令。指令用于指定何时运行用户 Lua 代码以及如何使用结果。")]),s._v(" "),t("p",[s._v("下图显示了执行指令的顺序。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.3xichpazdxy0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("先来解释下 * 的作用")]),s._v(" "),t("ul",[t("li",[s._v("* 代表 *_by_lua 指令，指令后面跟的是 lua 指令")]),s._v(" "),t("li",[s._v("*:_file，即 *_by_lua_file 指令，后面跟的是 lua 文件")]),s._v(" "),t("li",[s._v("*:_block，即 *_by_lua_block 指令，在 0.9.17 版后替换 init_by_lua_file")])]),s._v(" "),t("p",[s._v("如上图所示，OpenResty 的执行阶段分为：")]),s._v(" "),t("ul",[t("li",[s._v("init_by_lua*：在每次 Nginx 重新加载配置时执行，初始化一些全局配置。")]),s._v(" "),t("li",[s._v("init_worker_by_lua*：该指令用于启动一些定时任务，如心跳检查、定时拉取服务器配置等。")]),s._v(" "),t("li",[s._v("set_by_lua* : 流程分支处理判断变量初始化")]),s._v(" "),t("li",[s._v("rewrite_by_lua* : 转发、重定向、缓存等功能(例如特定请求代理到外网)")]),s._v(" "),t("li",[s._v("access_by_lua* : IP 准入、接口权限等情况集中处理(例如配合 iptable 完成简单防火墙)")]),s._v(" "),t("li",[s._v("content_by_lua* : 内容生成")]),s._v(" "),t("li",[s._v("header_filter_by_lua* : 响应头部过滤处理(例如添加头部信息)")]),s._v(" "),t("li",[s._v("body_filter_by_lua* : 响应体过滤处理(例如完成应答内容统一成大写)")]),s._v(" "),t("li",[s._v("log_by_lua* : 会话完成后本地异步完成日志记录(日志可以记录在本地，还可以同步到其他机器)")])]),s._v(" "),t("h2",{attrs:{id:"语法api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#语法api"}},[s._v("#")]),s._v(" 语法API")]),s._v(" "),t("h3",{attrs:{id:"ngx-say"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-say"}},[s._v("#")]),s._v(" ngx.say")]),s._v(" "),t("p",[s._v("返回结果给客户端。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v('ngx.say("")')]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua_block")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v('\n        ngx.say("Hello World")\n    '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("你会在网页上看到 Hello World。")]),s._v(" "),t("h3",{attrs:{id:"ngx-print"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-print"}},[s._v("#")]),s._v(" ngx.print")]),s._v(" "),t("p",[s._v("将输入参数合并发送给 HTTP 客户端 (作为 HTTP 响应体)。如果此时还没有发送响应头信息，本函数将先发送 HTTP 响应头，再输出响应体。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ok, err = ngx.print(...)")])]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" table "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"world: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" or "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('": "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("table"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("将输出：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" hello"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" world"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("其中 ok 存储着输出的内容，如果输出失败，err 存储失败的原因。")]),s._v(" "),t("p",[s._v("本函数为异步调用，将立即返回，不会等待所有数据被写入系统发送缓冲区。要以同步模式运行，请在调用 "),t("code",[s._v("ngx.print")]),s._v(" 之后调用 "),t("code",[s._v("ngx.flush")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"ngx-flush"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-flush"}},[s._v("#")]),s._v(" ngx.flush")]),s._v(" "),t("p",[s._v("向客户端刷新响应输出。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ok, err = ngx.flush(wait)")])]),s._v(" "),t("p",[t("code",[s._v("ngx.flush")]),s._v(" 接受一个布尔型可选参数 "),t("code",[s._v("wait")]),s._v(" (默认值 "),t("code",[s._v("false")]),s._v(")。当通过默认参数（"),t("code",[s._v("false")]),s._v("）调用时，本函数发起一个异步调用。当把 "),t("code",[s._v("wait")]),s._v(" 参数设置为 "),t("code",[s._v("true")]),s._v(" 时，本函数将以同步模式执行。")]),s._v(" "),t("ul",[t("li",[s._v("异步调用下，直接将数据返回，不等待输出数据被写入系统发送缓冲区。")]),s._v(" "),t("li",[s._v("同步模式下，本函数不会立即返回，一直到所有输出数据被写入系统输出缓冲区，或到达发送超时 send_timeout 时间。")])]),s._v(" "),t("p",[s._v("这个要和上方的 ngx.print 进行配合使用，开启同步模式，可以优化返回客户端多条数据的速度。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" table "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"world: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" or "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('": "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("table"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("flush")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 开启同步模式")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"ngx-arg"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-arg"}},[s._v("#")]),s._v(" ngx.arg")]),s._v(" "),t("p",[s._v("获取定义的变量。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.arg[n]")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /foo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$a")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$b")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sum")]),s._v(" = ngx.arg[1] + ngx.arg[2]  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 等价于 $a + $b")]),s._v("\n     echo "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sum")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("将输出 88，是 32 和 56 的和。")]),s._v(" "),t("h3",{attrs:{id:"ngx-var"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-var"}},[s._v("#")]),s._v(" ngx.var")]),s._v(" "),t("p",[s._v("读写 Nginx 变量值。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.var.xxx")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /foo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$my_var")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 $my_var 变量")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\n        ngx.var.my_var = 123;  # 使用 "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$my_var")]),s._v(" 变量\n    '")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"ngx-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-log"}},[s._v("#")]),s._v(" ngx.log")]),s._v(" "),t("p",[s._v("输出到日志中。格式："),t("code",[s._v("ngx.log(ngx.level,...)")])]),s._v(" "),t("p",[s._v("可指定多个日志常量 ngx.level。")]),s._v(" "),t("p",[s._v("ngx.level有：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("STDERR    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 例如 ngx.log(ngx.STDERR)")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("EMERG\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ALERT\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CRIT\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WARN\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("NOTICE\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INFO\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DEBUG\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"http-方法常量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#http-方法常量"}},[s._v("#")]),s._v(" HTTP 方法常量")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_GET\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_HEAD\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_PUT\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_POST\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_DELETE\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_OPTIONS")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.")]),s._v("0rc24 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_MKCOL")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_COPY")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_MOVE")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_PROPFIND")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_PROPPATCH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_LOCK")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_UNLOCK")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_PATCH")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_TRACE")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"http-状态常量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#http-状态常量"}},[s._v("#")]),s._v(" HTTP 状态常量")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_OK")]),s._v(" \t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_CREATED")]),s._v(" \t\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("201")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_SPECIAL_RESPONSE")]),s._v(" \t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_MOVED_PERMANENTLY")]),s._v(" \t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_MOVED_TEMPORARILY")]),s._v(" \t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("302")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_SEE_OTHER")]),s._v(" \t\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("303")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_NOT_MODIFIED")]),s._v(" \t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("304")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_BAD_REQUEST")]),s._v(" \t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("400")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_UNAUTHORIZED")]),s._v(" \t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("401")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_FORBIDDEN")]),s._v(" \t\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("403")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_NOT_FOUND")]),s._v(" \t\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_NOT_ALLOWED")]),s._v(" \t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("405")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_GONE")]),s._v(" \t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("410")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_INTERNAL_SERVER_ERROR")]),s._v(" \t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_METHOD_NOT_IMPLEMENTED")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("501")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_SERVICE_UNAVAILABLE")]),s._v(" \t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nvalue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("HTTP_GATEWAY_TIMEOUT")]),s._v(" \t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("等于 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("504")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.")]),s._v("1rc38 版本加入"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"print"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#print"}},[s._v("#")]),s._v(" print")]),s._v(" "),t("p",[s._v("将参数值以 "),t("code",[s._v("ngx.NOTICE")]),s._v(" 日志级别写入 Nginx 的 "),t("code",[s._v("error.log")]),s._v(" 文件。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("print(...)")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("等价于")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("NOTICE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"ngx-ctx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-ctx"}},[s._v("#")]),s._v(" ngx.ctx")]),s._v(" "),t("p",[s._v("一个 location 模块里的全局环境变量，存储基于请求的 Lua 环境数据。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.ctx.xxx")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /sub")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n        ngx.say("sub pre: ", ngx.ctx.blah)\n        ngx.ctx.blah = 32\n        ngx.say("sub post: ", ngx.ctx.blah)\n    \'')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /main")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n        ngx.ctx.blah = 73\n        ngx.say("main pre: ", ngx.ctx.blah)\n        local res = ngx.location.capture("/sub")\n        ngx.print(res.body)\n        ngx.say("main post: ", ngx.ctx.blah)\n    \'')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("访问 "),t("code",[s._v("GET /main")]),s._v(" 输出：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("main pre"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("73")]),s._v("\nsub pre"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),s._v("\nsub post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("\nmain post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("73")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"ngx-exit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-exit"}},[s._v("#")]),s._v(" ngx.exit")]),s._v(" "),t("p",[s._v("退出某个阶段，如处理请求阶段、重定向阶段等。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.exit(status)")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("status")]),s._v(" 参数可以是 "),t("code",[s._v("ngx.OK")]),s._v("，"),t("code",[s._v("ngx.ERROR")]),s._v(" 等等 "),t("RouterLink",{attrs:{to:"/middleware/Nginx/Nginx_Lua_Expansion_module/#http-状态常量"}},[s._v("HTTP 状态常量")])],1),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_GONE\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"This is our own content"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 退出整个请求而不是当前处理阶段")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_OK"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("可以直接使用数字作为参数，例如：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("501")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("数字作为参数仅支持 "),t("code",[s._v("NGX_OK")]),s._v(" 和 "),t("code",[s._v("NGX_ERROR")]),s._v(" 的数字。")])]),s._v(" "),t("h3",{attrs:{id:"ngx-sleep"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-sleep"}},[s._v("#")]),s._v(" ngx.sleep")]),s._v(" "),t("p",[s._v("无阻塞地休眠特定秒。时间可以精确到 0.001 秒 (毫秒)。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.sleep(seconds)")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"请求api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#请求api"}},[s._v("#")]),s._v(" 请求API")]),s._v(" "),t("h3",{attrs:{id:"ngx-req-get-uri-args"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-get-uri-args"}},[s._v("#")]),s._v(" ngx.req.get_uri_args")]),s._v(" "),t("p",[s._v("返回一个 Lua table，包含当前请求的所有 URL 查询参数。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("args = ngx.req.get_uri_args([max_args])")])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" = /test")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n         local args = ngx.req.get_uri_args()\n         for key, val in pairs(args) do\n             if type(val) == "table" then\n                 ngx.say(key, ": ", table.concat(val, ", "))\n             else\n                 ngx.say(key, ": ", val)\n             end\n         end\n     \'')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("访问 "),t("code",[s._v("GET /test?foo=bar&bar=baz&bar=blah")]),s._v(" 将输出：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" foo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bar\n bar"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" baz"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" blah\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("多次出现同一个参数 key 时，将生成一个 Lua table，按顺序保存其所有 value。")]),s._v(" "),t("h3",{attrs:{id:"ngx-req-set-uri-args"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-set-uri-args"}},[s._v("#")]),s._v(" ngx.req.set_uri_args")]),s._v(" "),t("p",[s._v("用 "),t("code",[s._v("args")]),s._v(" 参数重写当前请求的 URI 请求参数。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.req.set_uri_args(args)")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_uri_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a=3&b=hello%20world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_uri_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_uri_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("在第二种情况下，本方法将根据 URI 转义规则转义参数的 key 和 value。")]),s._v(" "),t("p",[s._v("在第三种情况下，请求参数字符串为 "),t("code",[s._v("a=3&b=5&b=6")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"ngx-header-header"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-header-header"}},[s._v("#")]),s._v(" ngx.header.HEADER")]),s._v(" "),t("p",[s._v("修改、添加、或清除当前请求待发送的 "),t("code",[s._v("HEADER")]),s._v(" 响应头信息。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.header.HEADER = VALUE")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("HEADER")]),s._v(" 响应头信息不是自定义的，是请求头带有的。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 与 ngx.header[\"Content-Type\"] = 'text/plain' 相同")]),s._v("\n ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("content_type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X-My-Header"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'blah blah'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"ngx-req-get-method"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-get-method"}},[s._v("#")]),s._v(" ngx.req.get_method")]),s._v(" "),t("p",[s._v("获取当前请求的 HTTP 请求方法名称。结果为类似 "),t("code",[s._v('"GET"')]),s._v(" 和 "),t("code",[s._v('"POST"')]),s._v(" 的字符串。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.req.get_method")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_method\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"ngx-req-set-method"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-set-method"}},[s._v("#")]),s._v(" ngx.req.set_method")]),s._v(" "),t("p",[s._v("用 "),t("code",[s._v("method_id")]),s._v(" 参数的值改写当前请求的 HTTP 请求方法。当前仅支持 "),t("RouterLink",{attrs:{to:"/middleware/Nginx/Nginx_Lua_Expansion_module/#http-方法常量"}},[s._v("HTTP 请求方法")]),s._v(" 中定义的数值常量。")],1),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.req.set_method(method_id)")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_method")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("method_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_method")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_GET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"ngx-req-read-body"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-read-body"}},[s._v("#")]),s._v(" ngx.req.read_body")]),s._v(" "),t("p",[s._v("同步读取客户端请求体，不阻塞 Nginx 事件循环。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.req.read_body()")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_post_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"ngx-req-get-post-args"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-get-post-args"}},[s._v("#")]),s._v(" ngx.req.get_post_args")]),s._v(" "),t("p",[s._v("返回一个 Lua table，包含当前请求的所有 POST 查询参数。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("args, err = ngx.req.get_post_args(max_args?)")])]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("ngx.req.get_post_args")]),s._v(" 获取参数前，必须使用 "),t("code",[s._v("ngx.req.read_body")]),s._v(" 读取请求体。")])]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     content_by_lua '\n         ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_post_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" args "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n             ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to get post args: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" val "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("pairs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("val"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"table"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n                 ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('": "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" table"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("concat")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("val"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('", "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n                 ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('": "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" val"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n     '"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("请求")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Post request with the body 'foo=bar&bar=baz&bar=blah'")]),s._v("\n $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'foo=bar&bar=baz&bar=blah'")]),s._v(" localhost/test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("将输出：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" foo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bar\n bar"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" baz"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" blah\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("多次出现同一个参数 key 时，将生成一个 Lua table，按顺序保存其所有 value。")]),s._v(" "),t("h3",{attrs:{id:"ngx-redirect"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-redirect"}},[s._v("#")]),s._v(" ngx.redirect")]),s._v(" "),t("p",[s._v("发出一个 HTTP "),t("code",[s._v("301")]),s._v(" 或 "),t("code",[s._v("302")]),s._v(" 重定向到 "),t("code",[s._v("uri")]),s._v("。")]),s._v(" "),t("p",[s._v("可选项 "),t("code",[s._v("status")]),s._v(" 参数指定 "),t("code",[s._v("301")]),s._v(" 或 "),t("code",[s._v("302")]),s._v(" 哪个被使用。 默认使用 "),t("code",[s._v("302")]),s._v("。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.redirect(uri, [status])")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("redirect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/foo"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 等价于")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("redirect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/foo"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 等价于")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("redirect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/foo"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_MOVED_TEMPORARILY"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("重定向到任意外部 URL 也是支持的，例如：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("redirect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://www.baidu.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"ngx-exec"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-exec"}},[s._v("#")]),s._v(" ngx.exec")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("uri")]),s._v("、"),t("code",[s._v("args")]),s._v(" 参数执行一个内部跳转。内部指的是 Nginx 的某个 location 模块。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.exec(uri, [args])")])]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /foo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n         ngx.exec("/bar", "a=goodbye");\n     \'')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /bar")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\n         local args = ngx.req.get_uri_args()\n         for key, val in pairs(args) do\n             if key == \"a\" then\n                 ngx.say(val)\n             end\n         end\n     '")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("访问 "),t("code",[s._v("GET /foo/file.php?a=hello")]),s._v("，将返回 『 hello 』 ，而不是 『 goodbye 』")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[t("code",[s._v("ngx.exec")]),s._v(" 方法与 "),t("a",{attrs:{href:"/middleware/Nginx/Nginx_Lua_Expansion_module#nginx-redirect"}},[s._v("ngx.redirect")]),s._v(" 是完全不同的，前者是个纯粹的内部跳转并且没有引入任何额外 HTTP 信号。")]),s._v(" "),t("p",[s._v("此方法的调用终止当前请求的处理。")])]),s._v(" "),t("h3",{attrs:{id:"ngx-location-capture"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-location-capture"}},[s._v("#")]),s._v(" ngx.location.capture")]),s._v(" "),t("p",[s._v("向 "),t("code",[s._v("uri")]),s._v(" 发起一个同步非阻塞 Nginx 子请求。")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.location.capture(uri,[options])")]),s._v("。")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("它会请求 Nginx 的其他 location 模块，location 模块可以是其他文件目录的配置文件中，或任何其他 Nginx 模块。")])]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("location"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("capture")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uri"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("code",[s._v("res")]),s._v(" 是返回的结果，它是一个「对象」，将包含四个元素的 Lua 表 ("),t("code",[s._v("res.status")]),s._v(", "),t("code",[s._v("res.header")]),s._v(", "),t("code",[s._v("res.body")]),s._v(", 和 "),t("code",[s._v("res.truncated")]),s._v(")。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("res.status")]),s._v(" (状态) 保存子请求的响应状态码。")]),s._v(" "),t("li",[t("code",[s._v("res.header")]),s._v(" (头) 用一个标准 Lua 表储子请求响应的所有头信息。如果是“多值”响应头，这些值将使用 Lua (数组) 表顺序存储。")])]),s._v(" "),t("p",[s._v("如果子请求响应头包含下面的行：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" Set"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Cookie"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n Set"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Cookie"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" foo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar\n Set"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Cookie"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" baz"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("blah\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("则 "),t("code",[s._v('res.header["Set-Cookie"]')]),s._v(" 将存储 Lua 表 "),t("code",[s._v('{"a=3", "foo=bar", "baz=blah"}')]),s._v("。")]),s._v(" "),t("p",[t("strong",[s._v("options 选项")])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("选项")]),s._v(" "),t("th",[s._v("作用")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("method")]),s._v(" "),t("td",[s._v("指定子请求的请求方法, 只接受类似 "),t("code",[s._v("ngx.HTTP_POST")]),s._v(" 的常量")])]),s._v(" "),t("tr",[t("td",[s._v("body")]),s._v(" "),t("td",[s._v("指定子请求的请求体 (仅接受字符串值)")])]),s._v(" "),t("tr",[t("td",[s._v("args")]),s._v(" "),t("td",[s._v("指定子请求的 URI 请求参数 (可以是字符串或者 Lua 表)")])]),s._v(" "),t("tr",[t("td",[s._v("ctx")]),s._v(" "),t("td",[s._v("指定一个 Lua 表作为子请求的 ngx.ctx 表，可以是当前请求的 ngx.ctx 表")])]),s._v(" "),t("tr",[t("td",[s._v("vars")]),s._v(" "),t("td",[s._v("用一个 Lua 表设置子请求中的 Nginx 变量值")])]),s._v(" "),t("tr",[t("td",[s._v("copy_all_vars")]),s._v(" "),t("td",[s._v("设置是否复制所有当前请求的 Nginx 变量值到子请求中，修改子请求的 nginx 变量值不影响当前 (父) 请求")])]),s._v(" "),t("tr",[t("td",[s._v("share_all_vars")]),s._v(" "),t("td",[s._v("设置是否共享所有当前 (父) 请求的 Nginx 变量值到子请求中，修改子请求的 nginx 变量值将影响当前 (父) 请求")])]),s._v(" "),t("tr",[t("td",[s._v("always_forward_body")]),s._v(" "),t("td",[s._v("当设置为 true 时，如果没有设置 "),t("code",[s._v("body")]),s._v(" 选项，当前 (父) 请求的请求体将被转发给子请求")])])])]),s._v(" "),t("p",[s._v("例如，发送一个 POST 子请求，可以这样做：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("res")]),s._v(" = ngx.location.capture(\n     "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/foo/bar'")]),s._v(",")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("method")]),s._v(" = ngx.HTTP_POST, args =")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" a = 1,b = 3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(", body = 'Hello，World' "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n )\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("等价于：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("location"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("capture")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/foo/bar?a=1&b=3'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("code",[s._v("method")]),s._v(" 选项默认值是 "),t("code",[s._v("ngx.HTTP_GET")]),s._v("。")]),s._v(" "),t("p",[s._v("其他内容具体看中文文档，开头有转送门。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("ngx.exec 和 ngx.location.capture 区别")]),s._v(" "),t("p",[t("code",[s._v("ngx.exec")]),s._v(" 只会访问同一个配置文件的 location 模块。")]),s._v(" "),t("p",[t("code",[s._v("ngx.location.capture")]),s._v(" 不仅如此，还可以访问其他配置文件的 location 模块。")])]),s._v(" "),t("h3",{attrs:{id:"ngx-req-set-uri"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-req-set-uri"}},[s._v("#")]),s._v(" ngx.req.set_uri")]),s._v(" "),t("p",[s._v("语法："),t("code",[s._v("ngx.req.set_uri(uri, jump?)")])]),s._v(" "),t("p",[s._v("通过参数 uri 重写当前请求的 uri；参数 jump，表明是否进行 locations 的重新匹配。当 jump 为 true 时，调用 "),t("code",[s._v("ngx.req.set_uri")]),s._v(" 后，Nginx 将会根据修改后的 uri，重新匹配新的 locations；如果 jump 为 false，将不会进行 locations 的重新匹配，而仅仅是修改了当前请求的 URI 而已。jump 的默认值为 false。")]),s._v(" "),t("ul",[t("li",[s._v("jump 为 true，等价于 rewrite...last")]),s._v(" "),t("li",[s._v("jump 为 false，等价于 rewrite...break")])]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_uri")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/foo"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rewrite "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("foo last"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_uri")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/foo"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("  rewrite "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("foo "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"指令api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#指令api"}},[s._v("#")]),s._v(" 指令API")]),s._v(" "),t("h3",{attrs:{id:"init-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#init-by-lua"}},[s._v("#")]),s._v(" init_by_lua")]),s._v(" "),t("p",[s._v("该指令在每次 Nginx 重新加载配置时执行，可以用来完成一些耗时模块的加载，或者初始化一些全局配置。")]),s._v(" "),t("p",[s._v("这是一个公共模块，把所有都用到的代码放到这个模块里，避免重复使用相同的代码。")]),s._v(" "),t("p",[s._v("比如每个模块都需要 MySQL 和 Redis，则在这个公共模块进行引用。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("init_by_lua_block")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v('\n    mysql = require "resty.mysql"\n\tredis = require "resty.redis"\n'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下方直接使用 MySQL 和 Redis 的 API")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("init_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"init-worker-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#init-worker-by-lua"}},[s._v("#")]),s._v(" init_worker_by_lua")]),s._v(" "),t("p",[s._v("该指令用于启动一些定时任务，如心跳检查、定时拉取服务器配置等。")]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v(" init_worker_by_lua '\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" delay "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- in seconds")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" new_timer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("timer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("at\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ERR "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" check\n\n     check "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("premature"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" premature "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- do the health check or other routine work")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new_timer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" check"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n                 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ERR"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to create timer: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new_timer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" check"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ERR"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to create timer: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n '"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("init_worker_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"set-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#set-by-lua"}},[s._v("#")]),s._v(" set_by_lua")]),s._v(" "),t("p",[s._v("该指令只要用来做变量赋值，这个指令一次只能返回一个值，并将结果赋值给 Nginx 中指定的变量。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("语法")]),s._v(" "),t("th",[s._v("说明")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("set_by_lua* <key> <value>")]),s._v(" "),t("td",[s._v("key要加上 $ 符号，value 是 Lua 语言的格式")])])])]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v('set_by_lua $name "\n\t\t'),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" uri_args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_uri_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取请求 ? 后的参数")]),s._v("\n\t\tname "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取 key 为 name 的参数")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'先生'")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在 name 后面加上 先生，作为 $name 的 value 返回给客户端")]),s._v('\n\t"'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("此时 key 为 "),t("code",[s._v("$name")]),s._v(" 的 value 值是 URL 的参数 name 加上「先生」。")]),s._v(" "),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("set_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"rewrite-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rewrite-by-lua"}},[s._v("#")]),s._v(" rewrite_by_lua")]),s._v(" "),t("p",[s._v("该指令用于执行内部 URL 重写或者外部重定向，典型的如伪静态化 URL 重写，本阶段在 Rewrite 处理阶段的最后默认执行。")]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /foo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$a")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建变量 $a")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$b")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建变量 $b")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rewrite_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\n         ngx.var.b = tonumber(ngx.var.a) + 1  # 此时 b = 13\n         if tonumber(ngx.var.b) == 13 then\n             return ngx.redirect(\"/bar\");   # 重定向到 /bar\n         end\n     '")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"res = '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$b")]),s._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# res = 13")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("rewrite_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"access-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#access-by-lua"}},[s._v("#")]),s._v(" access_by_lua")]),s._v(" "),t("p",[s._v("该指令用于访问控制。例如，如果只允许内网 IP 访问。")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\n        local res = ngx.location.capture(\"/auth\")\n\n        if res.status == ngx.HTTP_OK then\n        return\n        end\n\n        if res.status == ngx.HTTP_FORBIDDEN then\n        ngx.exit(res.status)\n        end\n\n        ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)\n        '")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# proxy_pass/fastcgi_pass/postgres_pass/...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("注意，在 access_by_lua 处理内部，当调用 "),t("code",[s._v("ngx.exit(ngx.OK)")]),s._v(" 时，nginx 请求将继续下一阶段的内容处理。要在 access_by_lua 处理中终结当前请求，调用 ngx.exit ，成功的请求设定 status >= 200 ("),t("code",[s._v("ngx.HTTP_OK")]),s._v(") 并 status < 300 ("),t("code",[s._v("ngx.HTTP_SPECIAL_RESPONSE")]),s._v(")，失败的请求设定"),t("code",[s._v("ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)")]),s._v(" (或其他相关的)。")]),s._v(" "),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("access_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"content-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#content-by-lua"}},[s._v("#")]),s._v(" content_by_lua")]),s._v(" "),t("p",[t("strong",[s._v("该指令是应用最多的指令")]),s._v("，大部分任务是在这个阶段完成的，其他的过程往往为这个阶段准备数据，正式处理基本都在本阶段。")]),s._v(" "),t("p",[s._v("这个指令就相当于 Java 的一个方法，所有的代码都需要一个方法体作为环境。")]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v('\n    set_by_lua $name "\n        '),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" uri_args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_uri_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取请求 ? 后的参数")]),s._v("\n        name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" uri_args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取 key 为 name 的参数")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'先生'")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在 name 后面加上 先生，作为 $name 的 value 返回给客户端")]),s._v('\n    "'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("content_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"header-filter-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#header-filter-by-lua"}},[s._v("#")]),s._v(" header_filter_by_lua")]),s._v(" "),t("p",[s._v("该指令用于设置应答消息的头部信息。")]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://mybackend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("header_filter_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ngx.header.username = \"frx\"'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("你会在请求头看到 name 为 frx")]),s._v(" "),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("header_filter_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"body-filter-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#body-filter-by-lua"}},[s._v("#")]),s._v(" body_filter_by_lua")]),s._v(" "),t("p",[s._v("该指令是对响应数据进行过滤，如截断、替换。")]),s._v(" "),t("p",[s._v("例如，在输出体转换所有的小写字母，我们可以这样用：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v(" location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     proxy_pass http://mybackend"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n     body_filter_by_lua "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ngx.arg[1] = string.upper(ngx.arg[1])'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转小写")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("body_filter_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"log-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#log-by-lua"}},[s._v("#")]),s._v(" log_by_lua")]),s._v(" "),t("p",[s._v("该指令用于在 log 请求处理阶段，用 Lua 代码处理日志，但并不替换原有 log 处理。")]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://mybackend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("log_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n            local log_dict = ngx.shared.log_dict\n            local upstream_time = tonumber(ngx.var.upstream_response_time)\n\n            local sum = log_dict:get("upstream_time-sum") or 0\n            sum = sum + upstream_time\n            log_dict:set("upstream_time-sum", sum)\n\n            local newval, err = log_dict:incr("upstream_time-nb", 1)\n            if not newval and err == "not found" then\n            log_dict:add("upstream_time-nb", 0)\n            log_dict:incr("upstream_time-nb", 1)\n            end\n            \'')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("如果不喜欢直接写 Lua 语法，把 Lua 语法 放到 Lua 文件里，使用 "),t("code",[s._v("log_by_lua_file")]),s._v(" 引用 Lua 文件。")]),s._v(" "),t("h3",{attrs:{id:"balancer-by-lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#balancer-by-lua"}},[s._v("#")]),s._v(" balancer_by_lua")]),s._v(" "),t("p",[s._v("该指令主要的作用是用来实现上游服务器的负载均衡器算法")]),s._v(" "),t("h3",{attrs:{id:"ssl-certificate-by"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ssl-certificate-by"}},[s._v("#")]),s._v(" ssl_certificate_by")]),s._v(" "),t("p",[s._v("该指令作用在 Nginx 和下游服务开始一个 SSL 握手操作时将允许本配置项的 Lua 代码。")]),s._v(" "),t("h2",{attrs:{id:"简单案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简单案例"}},[s._v("#")]),s._v(" 简单案例")]),s._v(" "),t("h3",{attrs:{id:"需求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[s._v("#")]),s._v(" 需求")]),s._v(" "),t("p",[s._v("发送请求："),t("code",[s._v("http://192.168.91.200?name=张三&gender=1")])]),s._v(" "),t("p",[s._v("Nginx 接收到请求后，根据 gender 传入的值进行判断，如果 gender 传入的是 1，则在页面上展示张三先生,如果 gender 传入的是 0，则在页面上展示张三女士，如果未传或者传入的不是 1 和 2，则在页面上展示张三。")]),s._v(" "),t("h3",{attrs:{id:"实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[s._v("#")]),s._v(" 实现")]),s._v(" "),t("p",[s._v("在配置文件进行如下配置：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /getByGender")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/html'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"\n\t\tlocal uri_args = ngx.req.get_uri_args()\n\t\tgender = uri_args['gender']\n\t\tname = uri_args['name']\n\t\tif gender=='1' then\n\t\t\treturn name..'先生'\n\t\telseif gender=='0' then\n\t\t\treturn name..'女士'\n\t\telse\n\t\t\treturn name\n\t\tend\n\t\"")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("header_filter_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"\n\t\tngx.header.aaa='bbb'\n\t\"")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("charset")]),s._v(" utf-8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("访问测试："),t("code",[s._v("http://192.168.91.200/getByGender?name=冯荣旭&gender=1")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.43wr3kwp3ag0.webp",alt:"image"}})]),s._v(" "),t("p",[s._v("访问测试："),t("code",[s._v("http://192.168.91.200/getByGender?name=冯荣旭")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.44pzvk2lzlk0.webp",alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"ngx-lua操作redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua操作redis"}},[s._v("#")]),s._v(" ngx_lua操作Redis")]),s._v(" "),t("p",[s._v("Redis 在系统中经常作为数据缓存、内存数据库使用，在大型系统中扮演着非常重要的作用。")]),s._v(" "),t("p",[s._v("在 Nginx 核心系统中，Redis 是常备组件。Nginx 支持 3 种方法访问 Redis，分别是 HttpRedis 模块、HttpRedis2Module 模块、lua-resty-redis 库。")]),s._v(" "),t("p",[s._v("这三种方式中 HttpRedis 模块提供的指令少，功能单一，适合做简单缓存。HttpRedis2Module 模块比 HttpRedis 模块操作更灵活，功能更强大。而Lua-resty-redis 库是 OpenResty 提供的一个操作 Redis 的接口库，可根据自己的业务情况做一些逻辑处理，适合做复杂的业务逻辑。")]),s._v(" "),t("p",[s._v("本内容将主要以 Lua-resty-redis 来进行讲解。")]),s._v(" "),t("h3",{attrs:{id:"redis环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis环境准备"}},[s._v("#")]),s._v(" Redis环境准备")]),s._v(" "),t("p",[s._v("准备一个 Redis 环境，并确保正常连接")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".91.200\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master local"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /usr/local/bin/redis-server /etc/redis.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master local"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"api学习"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#api学习"}},[s._v("#")]),s._v(" API学习")]),s._v(" "),t("p",[t("code",[s._v("lua-resty-redis")]),s._v(" 提供了访问 Redis 的详细 API，包括创建对接、连接、操作、数据处理等。这些 API 基本上与 Redis 的操作一一对应。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("API")]),s._v(" "),t("th",[s._v("作用")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v('redis = require "resty.redis"')]),s._v(" "),t("td",[s._v("引入 Redis 模块，类似于 Java 的 import。")])]),s._v(" "),t("tr",[t("td",[s._v("redis,err = redis:new()")]),s._v(" "),t("td",[s._v("创建一个 Redis 对象给 redis，err 记录创建失败的原因。")])]),s._v(" "),t("tr",[t("td",[s._v("ok,err=redis:connect(host,port[,options_table])")]),s._v(" "),t("td",[s._v("设置连接 Redis 的连接信息。 ok：连接成功返回 1，连接失败返回 nil。 err：返回对应的错误信息。")])]),s._v(" "),t("tr",[t("td",[s._v("redis:set_timeout(time)")]),s._v(" "),t("td",[s._v("设置请求操作 Redis 的超时时间，单位毫秒。")])]),s._v(" "),t("tr",[t("td",[s._v("ok,err = redis:close()")]),s._v(" "),t("td",[s._v("关闭当前连接。 ok：连接成功返回 1，连接失败返回 nil。 err：返回对应的错误信息。")])]),s._v(" "),t("tr",[t("td",[s._v("原生 Redis 命令如 get、set、lpush 等")]),s._v(" "),t("td",[s._v("所有的 Redis 命令都有自己的方法，方法名字和命令名字相同，只是全部为小写。")])])])]),s._v(" "),t("h3",{attrs:{id:"效果实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#效果实现"}},[s._v("#")]),s._v(" 效果实现")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    default_type "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text/html"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" redis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.redis"')]),s._v(" \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 引入 Redis")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" redisObj "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建 Redis 对象")]),s._v("\n        redisObj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置超时数据为 1s")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redisObj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.91.200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置 Redis 连接信息")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" \t\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 判断是否连接成功")]),s._v("\n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to connection redis"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redisObj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TOM"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 存入数据")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" \t\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 判断是否存入成功")]),s._v("\n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to set username"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redisObj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 从 Redis 中获取数据")]),s._v("\n        ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\t\t\t\t\t\t "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 将数据写会消息体中")]),s._v("\n        redisObj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\t\t\t\t\t "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 关闭 Redis 连接")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("运行测试效果")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsdelivr.codeqihan.com//gh/xustudyxu/image-hosting1@master/20220807/image.4iflh85c7ma0.webp",alt:"image"}})]),s._v(" "),t("ul",[t("li",[s._v("查询redis")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" get username\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TOM"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"ngx-lua操作mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua操作mysql"}},[s._v("#")]),s._v(" ngx_lua操作Mysql")]),s._v(" "),t("p",[s._v("MySQL 是一个使用广泛的关系型数据库。在 ngx_lua 中，MySQL 有两种访问模式，分别是是：")]),s._v(" "),t("ul",[t("li",[s._v("用 "),t("code",[s._v("ngx_lua")]),s._v(" 模块和 "),t("code",[s._v("lua-resty-mysql")]),s._v(" 模块，这两个模块是安装 OpenResty 时默认安装的。")]),s._v(" "),t("li",[s._v("使用 "),t("code",[s._v("drizzle_nginx_module")]),s._v("（HttpDrizzleModule）模块，需要单独安装，这个库现不在 OpenResty 中。")])]),s._v(" "),t("h3",{attrs:{id:"lua-resty-mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lua-resty-mysql"}},[s._v("#")]),s._v(" lua-resty-mysql")]),s._v(" "),t("p",[s._v("这里使用的是 "),t("code",[s._v("lua-resty-mysql")]),s._v(" 模块。")]),s._v(" "),t("p",[t("code",[s._v("lua-resty-mysql")]),s._v(" 是 OpenResty 开发的模块，使用灵活、功能强大，适合复杂的业务场景，同时支持存储过程的访问。")]),s._v(" "),t("h3",{attrs:{id:"mysql环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql环境准备"}},[s._v("#")]),s._v(" MySQL环境准备")]),s._v(" "),t("p",[s._v("准备 MySQL，确保能正常连接")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("host: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".91.200\nport: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\nusername: root\npassword: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345678")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"api学习-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#api学习-2"}},[s._v("#")]),s._v(" API学习")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v('mysql = require "resty.mysql"')])]),s._v(" "),t("p",[s._v("引入 MySQL 模块，类似于 Java 的 import。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("db,err = mysql:new()")])]),s._v(" "),t("p",[s._v("创建一个 MySQL 连接对象给 db，连接对象遇到错误时，db 为nil，err 为错误描述信息。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("ok,err = db:connect(Options)")])]),s._v(" "),t("p",[s._v("尝试连接到一个MySQL服务器。Options 是一个参数的 Lua 表结构，里面包含数据库连接的相关信息。")]),s._v(" "),t("p",[s._v("Options 选项：")])])]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("host：服务器主机名或IP地址\nport：服务器监听端口，默认为"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v("：登录的用户名\npassword：登录密码\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v("：使用的数据库名\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[t("p",[t("code",[s._v("db:set_timeout(time)")])]),s._v(" "),t("p",[s._v("设置子请求的超时时间，单位毫秒。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("ok,err = db:close()")])]),s._v(" "),t("p",[s._v("关闭当前 MySQL 连接并返回状态。")])])]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("ok：如果成功，则返回 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("；如果出现任何错误，则将返回 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),s._v("。\nerr：如果出现任何错误，返回错误描述。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[t("p",[t("code",[s._v("bytes,err=db:send_query(sql)")])]),s._v(" "),t("p",[s._v("异步向远程 MySQL 发送一个查询。")]),s._v(" "),t("p",[s._v("如果成功则返回成功发送的字节数；如果错误，则返回 nil 和错误描述。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("res, err, errcode, sqlstate = db:read_result([rows])")])]),s._v(" "),t("p",[s._v("从 MySQL 服务器返回结果中读取一行数据。")]),s._v(" "),t("p",[t("code",[s._v("rows")]),s._v(" 指定返回结果集的最大值，默认为 4，可不写。")])])]),s._v(" "),t("p",[s._v("返回值：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("res：操作的结果集，返回一个描述 OK 包或结果集包的 Lua 表\nerr：错误信息\nerrcode：MySQL 的错误码，比如 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1064")]),s._v("\nsqlstate：返回由 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 个字符组成的标准 SQL 错误码，比如 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("42000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("如果是查询，则返回一个容纳多行的数组。每行是一个数据列的key-value对，如下:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("username="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TOM"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("birthday="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1988-11-11"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("salary="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000.0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("username="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"JERRY"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("birthday="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1989-11-11"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("salary="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20000.0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("如果是增删改，则返回类上如下数据")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    insert_id = "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    server_status="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    warning_count="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    affected_rows="),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    message=nil\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("数据库连接四要素:")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("driverClass"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jdbc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Driver\nurl"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("jdbc:mysql:"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//192.168.91.200:3306/nginx_db")]),s._v("\nusername"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root\npassword"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345678")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"表创建并插入数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#表创建并插入数据"}},[s._v("#")]),s._v(" 表创建并插入数据")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("auto_increment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TOM"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"JERRY"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ROWS"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"LUCY"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"JACK"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"数据查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据查询"}},[s._v("#")]),s._v(" 数据查询")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("testMysql {\n    content_by_lua_block{\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" mysql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.mysql"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql:new"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 创建实例  ")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" db "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("  \n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"new mysql error : "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("  \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("  \n        \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db:"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("connect")]),s._v("{\n            host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.91.200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx_db"')]),s._v("\n        }\n        \n        db:set_timeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置超时时间(毫秒)  ")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询语句")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" query_sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from users"')]),s._v("\n        db:send_query"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("query_sql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sqlstate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db:read_result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 返回数据 .. 代表拼接")]),s._v("\n        ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("say"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    \tdb:"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    }\n\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[t("strong",[s._v("问题")])]),s._v(" "),t("p",[s._v("上面返回的是需要我们指定返回的数据，但是我们根本不知道查询的数据有多少条，长什么样子。")]),s._v(" "),t("ul",[t("li",[s._v("如何获取返回数据的内容")]),s._v(" "),t("li",[s._v("如何实现查询多条数据")]),s._v(" "),t("li",[s._v("如何实现数据库的删改操作")])]),s._v(" "),t("h3",{attrs:{id:"lua-cjson处理查询结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lua-cjson处理查询结果"}},[s._v("#")]),s._v(" lua-cjson处理查询结果")]),s._v(" "),t("p",[s._v("通过上述的案例学习，read_result() 得到的结果 res 都是 table 类型，要想在页面上展示，就必须知道 table 的具体数据结构才能进行遍历获取。处理起来比较麻烦。")]),s._v(" "),t("p",[s._v("接下来我们使用一种简单方式 cjson，使用它就可以将 table 类型的数据转换成 Json 字符串，把 Json 字符串展示在页面上即可。")]),s._v(" "),t("p",[s._v("步骤一：引入 cjson 模块")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" cjson "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cjson"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("步骤二：调用 cjson 的 encode 方法进行类型转换")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("cjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("encode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("步骤三：测试")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br"),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("testMysql")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" mysql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.mysql"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" cjson "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cjson"')]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" db "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.199.27"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123456"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            database"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx_db"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('-- db:send_query("select * from users where id = 1")')]),s._v("\n        \n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("send_query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from users"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sqlstate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_result")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("encode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 转为 JSON 字符串格式")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ipairs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 循环来返回数据")]),s._v("\n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"返回的数据："')]),s._v("，v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v("v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        \n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("h3",{attrs:{id:"数据库删改"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库删改"}},[s._v("#")]),s._v(" 数据库删改")]),s._v(" "),t("p",[s._v("优化 "),t("code",[s._v("send_query")]),s._v(" 和 "),t("code",[s._v("read_result")]),s._v("，两个可以变成一体。")]),s._v(" "),t("p",[s._v("本方法是 "),t("code",[s._v("send_query")]),s._v(" 和 "),t("code",[s._v("read_result")]),s._v(" 组合的快捷方法。")]),s._v(" "),t("p",[s._v("语法:")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sqlstate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("rows"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("有了该 API，上面的代码我们就可以进行对应的优化，如下：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br"),t("br"),t("br"),t("br"),t("br"),t("br"),t("br")]),t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("testMysql")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" mysql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.mysql"')]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" db "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.91.200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            database"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx_db"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            max_packet_size"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            compact_arrays"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        \n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询操作")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sqlstate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("send_query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from users where id = 1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改操作")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sqlstate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"update users set name = 'bing' where id = 1\"")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除操作")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sqlstate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delete from users where id = 1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 插入操作")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" insert_sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"insert into users(id,name) values(null,'kele')\"")]),s._v("\n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("p",[s._v("综合小案例")]),s._v(" "),t("p",[s._v("使用 ngx_lua 模块完成查询 MySQL 数据，然后在 Redis 缓存预热。")]),s._v(" "),t("p",[s._v("分析:")]),s._v(" "),t("ol",[t("li",[s._v("先得有一张表（users），上面已经创建")]),s._v(" "),t("li",[s._v("浏览器输入如下地址")])]),s._v(" "),t("div",{staticClass:"language-http line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-http"}},[t("code",[t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token header-name keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token header-value"}},[s._v("//191.168.91.200?name=frx")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("从MySQL 表中查询出符合条件的数据，此时获取的结果为 table 类型")]),s._v(" "),t("li",[s._v("使用 cjson 将 table 数据转换成 json 字符串")]),s._v(" "),t("li",[s._v("将查询的结果数据存入 Redis 中")])]),s._v(" "),t("p",[s._v("这里利用到 "),t("code",[s._v("init_by_lua_block")]),s._v(" 指令，该指令上面介绍过，用于初始化全局变量。这里用于初始化 MySQL、Redis、cjson 模块。")]),s._v(" "),t("p",[s._v("还是使用了 "),t("code",[s._v("quote_sql_str")]),s._v(" 指令，防止「拼」SQL，导致 SQL 注入。")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("init_by_lua_block")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    redis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.redis"')]),s._v("\n    mysql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.mysql"')]),s._v("\n    cjson "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cjson"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nlocation "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("testMysql")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    default_type "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text/html"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取请求的参数 name")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" param "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_uri_args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 建立 mysql 数据库的连接")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" db "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.91.200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            database"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx_db"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed connect to mysql:"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 设置连接超时时间")]),s._v("\n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询数据")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" param "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n            sql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from users"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n            sql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from users where name="')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\'"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v(" param "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\'"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- sql 注入 ，不建议")]),s._v("\n            sql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from users where name="')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("quote_sql_str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ch_param"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 防止 sql 注入")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("errcode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sqlstate"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" res "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to query from mysql:"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 连接redis")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" rd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.91.200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n            ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to connect to redis:"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        \n        rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set_timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 循环遍历数据")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ipairs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n            rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v("v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("cjson"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("encode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        \n        ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"success"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 关闭 MySQL 和 Rdis 的连接")]),s._v("\n        rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);